<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EduSaaS - Modern School Management</title>
    <!-- Tailwind and Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --brand: #2563eb; --brand-light: #eff6ff; --success: #166534; --success-bg: #dcfce7; }
        body { font-family: 'Outfit', sans-serif; background-color: #f8fafc; color: #1e293b; -webkit-tap-highlight-color: transparent; }
        .font-arabic { font-family: 'Tajawal', sans-serif; }
        
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.4); }
        .card-premium { background: white; border: 1px solid #f1f5f9; box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.04); border-radius: 2rem; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-premium:hover { transform: translateY(-4px); box-shadow: 0 12px 30px -4px rgba(0, 0, 0, 0.08); border-color: rgba(37, 99, 235, 0.2); }
        
        .sidebar-item { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 14px; margin-bottom: 6px; border-left: 4px solid transparent; }
        .sidebar-item:hover { background-color: #f1f5f9; color: var(--brand); padding-left: 1.5rem; }
        .sidebar-item.active { background-color: var(--brand-light); color: var(--brand); border-left-color: var(--brand); font-weight: 700; }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .calendar-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 14px; font-size: 0.95rem; cursor: pointer; transition: all 0.2s; position: relative; background: white; border: 1px solid #f1f5f9; }
        .calendar-day:hover:not(.empty) { background-color: var(--brand-light); border-color: #bae6fd; transform: scale(1.05); z-index: 20; }
        .calendar-day.selected { border: 2px solid var(--brand); background-color: var(--brand-light); font-weight: 800; }
        .calendar-day.has-event::after { content: ''; position: absolute; bottom: 6px; width: 5px; height: 5px; background: var(--brand); border-radius: 50%; }
        .calendar-day.present { background-color: var(--success-bg) !important; border-color: #86efac !important; color: var(--success) !important; font-weight: 800; }
        .empty { background: transparent; border: none; pointer-events: none; }
        
        .msg-bubble { max-width: 85%; border-radius: 1.2rem; padding: 12px 18px; position: relative; font-size: 0.95rem; line-height: 1.5; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .msg-sent { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border-bottom-right-radius: 4px; }
        .msg-received { background: white; border: 1px solid #f1f5f9; border-bottom-left-radius: 4px; color: #334155; }
        
        .date-divider { position: relative; text-align: center; margin: 20px 0; }
        .date-divider::before { content: ''; position: absolute; left: 0; top: 50%; width: 100%; height: 1px; background: #f1f5f9; z-index: 1; }
        .date-divider span { position: relative; z-index: 2; background: #f8fafc; padding: 0 12px; font-size: 10px; font-bold: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.1em; }

        .scan-flash { animation: flash-green 0.6s ease-out; }
        @keyframes flash-green { 0% { background-color: rgba(34, 197, 94, 0.5); } 100% { background-color: transparent; } }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <div id="mobile-overlay" class="hidden fixed inset-0 bg-slate-900/60 z-[60] backdrop-blur-sm opacity-0 transition-opacity duration-300" onclick="window.toggleMobileMenu()"></div>
    
    <aside id="sidebar" class="fixed inset-y-0 left-0 w-72 bg-white z-[70] shadow-2xl transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col h-full border-r border-slate-100">
        <div class="p-8 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg">E</div>
                <h1 class="text-2xl font-bold text-slate-800 tracking-tight leading-none">EduSaaS</h1>
            </div>
            <button onclick="window.toggleMobileMenu()" class="lg:hidden text-slate-400 p-2"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>
        <div class="mx-6 p-4 bg-slate-50 rounded-2xl border border-slate-100 mb-6">
            <p class="text-[10px] text-slate-400 uppercase font-bold mb-1 tracking-widest leading-none">Workspace</p>
            <div id="school-name-display" class="font-bold text-sm text-slate-800 truncate text-blue-600 tracking-tight">Accessing...</div>
        </div>
        <nav id="nav-menu" class="flex-1 overflow-y-auto px-4 space-y-1"></nav>
        <div class="p-6 border-t border-slate-50">
            <button onclick="window.logout()" class="flex items-center gap-3 w-full px-4 py-3.5 text-sm font-bold text-red-500 bg-red-50/50 hover:bg-red-50 rounded-xl transition-colors"><i class="fa-solid fa-right-from-bracket"></i> Sign Out</button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full relative overflow-hidden bg-slate-50/50 lg:ml-72">
        <header class="bg-white/80 backdrop-blur-xl border-b border-slate-200 h-16 md:h-20 flex items-center justify-between px-4 md:px-8 shrink-0 z-40 sticky top-0">
            <div class="flex items-center gap-4">
                <button onclick="window.toggleMobileMenu()" class="lg:hidden text-slate-500 p-2 hover:bg-slate-100 rounded-xl transition-all"><i class="fa-solid fa-bars-staggered text-xl"></i></button>
                <div class="flex flex-col">
                    <h2 id="page-title" class="text-lg md:text-xl font-bold text-slate-800 leading-tight">Dashboard</h2>
                    <div class="flex items-center gap-1.5 mt-0.5"><span id="conn-dot" class="w-1.5 h-1.5 rounded-full bg-red-400"></span><span id="conn-text" class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Cloud Syncing...</span></div>
                </div>
            </div>

            <div class="flex items-center gap-3 md:gap-5">
                <div class="relative">
                    <button onclick="window.toggleNotifications()" class="p-2.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition-all relative">
                        <i class="fa-regular fa-bell text-xl"></i>
                        <span id="notif-badge" class="absolute top-2 right-2 w-4 h-4 bg-blue-600 text-white text-[9px] font-bold flex items-center justify-center rounded-full border-2 border-white hidden">0</span>
                    </button>
                    <div id="notification-dropdown" class="hidden absolute right-0 mt-3 w-80 bg-white rounded-[1.8rem] shadow-2xl border border-slate-100 z-50 overflow-hidden">
                        <div class="p-5 border-b border-slate-50 flex justify-between items-center bg-slate-50/50"><h3 class="font-bold text-sm text-slate-800">Notifications</h3><button onclick="window.clearNotifications()" class="text-[10px] font-bold text-blue-600">CLEAR ALL</button></div>
                        <div id="notification-list" class="max-h-80 overflow-y-auto py-2"></div>
                    </div>
                </div>
                <button onclick="window.toggleLangMenu()" class="p-2.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition-all"><i class="fa-solid fa-globe text-xl"></i></button>
                <div id="lang-dropdown" class="hidden absolute right-16 top-16 w-32 bg-white rounded-xl shadow-2xl border border-slate-100 py-1 z-50">
                    <button onclick="window.setLanguage('en')" class="block w-full text-left px-4 py-2 text-sm hover:bg-slate-50">English</button>
                    <button onclick="window.setLanguage('ar')" class="block w-full text-right px-4 py-2 text-sm hover:bg-slate-50 font-arabic">العربية</button>
                </div>
                <div class="h-8 w-px bg-slate-200 hidden sm:block"></div>
                <div class="w-10 h-10 rounded-full bg-blue-600 shadow-lg flex items-center justify-center text-white font-bold text-lg" id="user-initials">?</div>
            </div>
        </header>

        <div id="app-content" class="flex-1 overflow-y-auto p-4 md:p-8 relative scroll-smooth bg-white/30"></div>

        <div class="bg-slate-900 text-white text-[10px] py-1.5 px-4 flex justify-between items-center z-50">
            <div class="flex items-center gap-2"><span id="footer-conn-dot" class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></span><span id="footer-conn-text" class="text-yellow-400 uppercase font-bold tracking-widest">Initializing...</span></div>
            <div id="footer-user-id" class="text-slate-500 font-mono tracking-tighter uppercase">IDLE</div>
        </div>
    </main>

    <div id="login-modal" class="fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-xl flex items-center justify-center p-4">
        <div class="bg-white rounded-[2.5rem] shadow-2xl max-w-4xl w-full overflow-hidden flex flex-col md:flex-row border border-white/40">
            <div class="md:w-5/12 bg-blue-600 p-10 md:p-14 text-white flex flex-col justify-center relative overflow-hidden shrink-0">
                <div class="absolute -top-20 -right-20 w-64 h-64 bg-white/10 rounded-full blur-3xl"></div>
                <div class="relative z-10"><div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center text-3xl font-bold mb-8">E</div><h1 class="text-4xl font-bold mb-4 tracking-tighter leading-none">EduSaaS</h1><p class="text-blue-100 text-lg opacity-80 leading-relaxed font-light">Your intelligent school ecosystem.</p></div>
            </div>
            <div class="md:w-7/12 p-10 md:p-14 bg-white overflow-y-auto max-h-[90vh]">
                <h2 class="text-2xl font-extrabold text-slate-800 mb-2 tracking-tight">Access Portal</h2>
                <p class="text-slate-400 text-sm mb-10">Select a profile to enter.</p>
                <div class="grid grid-cols-1 gap-4">
                    <button onclick="window.login('teacher')" class="p-6 border border-slate-100 rounded-3xl hover:border-blue-500 hover:bg-blue-50/50 text-left transition-all flex items-center gap-5 group shadow-sm"><div class="w-14 h-14 bg-blue-100 text-blue-600 rounded-2xl flex items-center justify-center text-2xl group-hover:scale-110 transition-transform"><i class="fa-solid fa-chalkboard-teacher"></i></div><div><span class="font-extrabold block text-slate-800 text-lg">Teacher</span><span class="text-xs text-slate-400 font-bold uppercase tracking-widest">Faculty Management</span></div></button>
                    <div class="p-6 border border-slate-100 rounded-3xl bg-slate-50/30"><span class="font-bold text-slate-400 block mb-4 uppercase text-[10px] tracking-[0.25em]">Student Portal</span><div class="grid grid-cols-2 gap-3"><button onclick="window.login('student1')" class="bg-white p-3.5 rounded-xl border border-slate-200 text-sm font-bold text-slate-600 hover:text-blue-600 transition-all hover:-translate-y-1">Y. Brahimi</button><button onclick="window.login('student2')" class="bg-white p-3.5 rounded-xl border border-slate-200 text-sm font-bold text-slate-600 hover:text-blue-600 transition-all hover:-translate-y-1">M. Hadjadj</button></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals & Feedback -->
    <div id="image-modal" class="fixed inset-0 z-[110] bg-black/90 hidden flex items-center justify-center p-4 cursor-pointer" onclick="this.classList.add('hidden')"><img id="modal-img" src="" class="max-w-full max-h-full rounded-2xl shadow-2xl"></div>
    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 md:left-auto md:right-6 md:translate-x-0 bg-slate-900 text-white px-6 py-4 rounded-xl shadow-2xl transform translate-y-32 opacity-0 transition-all duration-300 z-[120] flex items-center gap-4"><div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white shrink-0"><i class="fa-solid fa-check"></i></div><span id="toast-msg" class="font-medium text-sm">Notification</span></div>
    <audio id="scan-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, setDoc, getDoc, updateDoc, getDocs, doc, Timestamp, where, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. DATA & CONFIG ---
        const staticData = {
            schools: [{ id: 's1', name: 'El Nardjess School' }],
            users: {
                teacher: { name: 'Fatima Zohra', role: 'teacher', id: 'teacher_dz' },
                student1: { name: 'Yacine Brahimi', role: 'student', id: 'student_dz_1' },
                student2: { name: 'Meriem Hadjadj', role: 'student', id: 'student_dz_2' }
            },
            classes: [
                { id: 'c1', name: 'Advanced Mathematics', time: '08:30 AM', icon: 'fa-calculator' }, 
                { id: 'c2', name: 'Science & Physics', time: '10:45 AM', icon: 'fa-atom' }
            ],
            students: [{ id: 'student_dz_1', name: 'Yacine Brahimi' }, { id: 'student_dz_2', name: 'Meriem Hadjadj' }]
        };

        const translations = {
            en: { 'lbl-no-notif': 'No notifications', 'lbl-contacts': 'Contacts', 'lbl-type-msg': 'Message...', 'lbl-back': 'Back', 'btn-scan': 'MARK ATTENDANCE' },
            ar: { 'lbl-no-notif': 'لا توجد إشعارات', 'lbl-contacts': 'جهات الاتصال', 'lbl-type-msg': 'رسالة...', 'lbl-back': 'رجوع', 'btn-scan': 'تسجيل الحضور' }
        };

        const firebaseConfig = {
            apiKey: "AIzaSyD2aOVfl6bXOpWCL9eaiM85g14WB25aXYg",
            authDomain: "alpha-26f1e.firebaseapp.com",
            projectId: "alpha-26f1e",
            storageBucket: "alpha-26f1e.firebasestorage.app",
            messagingSenderId: "838970744952",
            appId: "1:838970744952:web:4b190d95010ecf23e18d8d",
            measurementId: "G-230TGXB20M"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const dbFirestore = getFirestore(app);
        const APP_ID = 'edusaas-live-demo-v2';

        // --- 2. SHARED STATE ---
        let currentUser = null;
        let activeClassId = null;
        let activeScanner = null;
        let activeChatPartner = null;
        let currentCalendarDate = new Date();
        let currentCalendarEvents = {};
        let currentSelectedDate = null;
        let activeSessionFile = null;
        let isProcessingScan = false;
        let currentLang = 'en';
        let notificationStore = [];
        let firestoreUnsubscribes = [];
        let globalUnsubscribe = null;

        const dbCollections = {
            users: `artifacts/${APP_ID}/public/data/users`,
            classes: `artifacts/${APP_ID}/public/data/classes`,
            attendance: `artifacts/${APP_ID}/public/data/attendance`,
            materials: `artifacts/${APP_ID}/public/data/materials`,
            messages: `artifacts/${APP_ID}/public/data/messages`
        };

        window.isAuthReady = false;

        // --- 3. CORE UTILITIES (Hoisted) ---

        function getTranslation(key) { return translations[currentLang][key] || key; }

        function showToast(msg) {
            const t = document.getElementById('toast');
            if(!t) return;
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('translate-y-32', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-32', 'opacity-0'), 3000);
        }

        function updateUIHeader() {
            if (!currentUser) return;
            document.getElementById('user-name-header').innerText = currentUser.name;
            document.getElementById('user-role-label').innerText = currentUser.role.toUpperCase();
            document.getElementById('user-initials').innerText = currentUser.name.charAt(0);
            document.getElementById('footer-user-id').innerText = `SESSION: ${currentUser.id}`;
            document.getElementById('school-name-display').innerText = 'El Nardjess Private School';
        }

        function renderSidebar() {
            const nav = document.getElementById('nav-menu');
            if (!nav || !currentUser) return;
            nav.innerHTML = '';
            
            const teacherRoutes = [{ id: 'teacher-classes', label: 'My Hub', icon: 'fa-chalkboard-teacher' }, { id: 'teacher-calendar', label: 'Attendance', icon: 'fa-calendar-check' }, { id: 'teacher-chat', label: 'Messages', icon: 'fa-comments' }];
            const studentRoutes = [{ id: 'student-qr', label: 'My ID', icon: 'fa-id-card' }, { id: 'student-calendar', label: 'History', icon: 'fa-history' }, { id: 'student-materials', label: 'Resources', icon: 'fa-folder-open' }, { id: 'teacher-chat', label: 'Teacher Chat', icon: 'fa-comments' }];
            const routes = currentUser.role === 'teacher' ? teacherRoutes : studentRoutes;
            
            routes.forEach((rt) => {
                const b = document.createElement('button');
                b.className = `sidebar-item w-full flex items-center gap-3 px-5 py-4 text-sm font-bold text-slate-500 transition-all`;
                b.innerHTML = `<div class="w-8 flex justify-center"><i class="fa-solid ${rt.icon} text-lg"></i></div> ${rt.label}`;
                b.onclick = () => {
                    document.querySelectorAll('.sidebar-item').forEach(x=>x.classList.remove('active'));
                    b.classList.add('active');
                    window.renderPage(rt.id);
                };
                nav.appendChild(b);
            });
        }

        function updateNotificationBadge() {
            const b = document.getElementById('notif-badge');
            if (b) {
                b.innerText = notificationStore.length;
                notificationStore.length ? b.classList.remove('hidden') : b.classList.add('hidden');
            }
        }

        function renderNotificationList() {
            const l = document.getElementById('notification-list');
            if (!l) return;
            l.innerHTML = notificationStore.length ? notificationStore.map(n => `<div onclick="window.openChatFromNotif('${n.senderId}','${n.senderName}')" class="p-4 border-b hover:bg-blue-50 cursor-pointer text-xs"><p class="font-bold">${n.senderName}</p><p class="truncate opacity-70">${n.text}</p></div>`).join('') : `<div class="p-10 text-center text-slate-400 text-xs font-bold opacity-50">Secure Connection Established</div>`;
        }

        function setupGlobalNotifications() {
            if (globalUnsubscribe) globalUnsubscribe();
            const q = query(collection(dbFirestore, dbCollections.messages), where("receiverId", "==", String(currentUser.id)));
            globalUnsubscribe = onSnapshot(q, (snap) => {
                snap.docChanges().forEach((change) => {
                    if (change.type === "added" && change.doc.data().read !== true) {
                        const msg = change.doc.data();
                        if (!notificationStore.find(n => n.id === change.doc.id)) {
                             notificationStore.unshift({ id: change.doc.id, senderId: msg.senderId, senderName: msg.senderName, text: msg.text });
                        }
                    }
                });
                updateNotificationBadge();
                renderNotificationList();
            });
        }

        async function resetSessionMaterials() {
            if (currentUser.role !== 'teacher') return;
            for (const cl of staticData.classes) {
                try {
                    await updateDoc(doc(dbFirestore, dbCollections.classes, cl.id), {
                        currentFile: null,
                        currentFileData: null
                    });
                } catch (e) { console.warn("Materials reset failed for: ", cl.id); }
            }
        }

        async function stopScanner() {
            if (activeScanner) {
                try { await activeScanner.stop(); } catch (e) {}
                activeScanner = null;
            }
        }

        async function handleTeacherScanSuccess(txt) {
            try {
                let sData = txt.trim().startsWith('{') ? JSON.parse(txt) : { id: txt, name: "Student " + txt.substring(0,4) };
                if (!sData.id) throw new Error("Invalid ID");

                await addDoc(collection(dbFirestore, dbCollections.attendance), {
                    studentId: String(sData.id),
                    studentName: sData.name || "Unknown Student",
                    classId: activeClassId || "generic",
                    timestamp: Timestamp.now()
                });

                if (activeSessionFile) {
                    const clsSnap = await getDoc(doc(dbFirestore, dbCollections.classes, activeClassId));
                    const fd = clsSnap.data()?.currentFileData;
                    await addDoc(collection(dbFirestore, dbCollections.materials), {
                        studentId: String(sData.id), fileName: activeSessionFile, fileData: fd, timestamp: Timestamp.now(),
                        className: staticData.classes.find(c=>c.id===activeClassId)?.name || "Session Handout"
                    });
                }
                showToast(`VERIFIED: ${sData.name}`);
                document.getElementById('scan-sound').play().catch(()=>{});
            } catch (e) { showToast("LINK ERROR: INVALID CODE"); }
        }

        async function markMessagesRead(senderId) {
            const q = query(collection(dbFirestore, dbCollections.messages), where("senderId", "==", senderId), where("receiverId", "==", String(currentUser.id)), where("read", "==", false));
            const snap = await getDocs(q);
            snap.forEach(d => updateDoc(doc(dbFirestore, dbCollections.messages, d.id), { read: true }));
        }

        function refreshCalendarUI(role, myEvents = {}) {
            const grid = document.getElementById('cal-days');
            const title = document.getElementById('cal-title');
            if(!grid || !title) return;
            const y = currentCalendarDate.getFullYear(), m = currentCalendarDate.getMonth();
            title.innerText = new Date(y, m).toLocaleDateString(undefined, { month: 'long', year: 'numeric' });
            grid.innerHTML = '';
            const firstDay = new Date(y, m, 1).getDay(), daysInMonth = new Date(y, m+1, 0).getDate();
            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div class="empty"></div>`;
            for(let i=1; i<=daysInMonth; i++) {
                const dateKey = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                let cls = 'calendar-day';
                let content = i;
                if(role === 'teacher' && currentCalendarEvents[dateKey]) cls += ' has-event';
                if(role === 'student' && myEvents[dateKey]) { cls += ' present'; content += `<i class="fa-solid fa-check text-[10px] absolute bottom-1 right-1"></i>`; }
                const onclick = role === 'teacher' ? `onclick="window.selectDate('${dateKey}', this)"` : '';
                grid.innerHTML += `<div class="${cls}" data-date="${dateKey}" ${onclick}>${content}</div>`;
            }
        }

        // --- 4. EXPORTED GLOBALS ---

        window.login = async (roleKey) => {
            const defUser = staticData.users[roleKey];
            if (!defUser) return;
            const userRef = doc(dbFirestore, dbCollections.users, defUser.id);
            try {
                const snap = await getDoc(userRef);
                currentUser = snap.exists() ? { ...defUser, ...snap.data() } : { ...defUser };
                if(!snap.exists()) await setDoc(userRef, { name: defUser.name, role: defUser.role });
                
                // Refresh class attachments on teacher login
                if (currentUser.role === 'teacher') await resetSessionMaterials();

                document.getElementById('login-modal').classList.add('hidden');
                updateUIHeader();
                renderSidebar();
                setupGlobalNotifications();
                window.renderPage(currentUser.role === 'student' ? 'student-qr' : 'teacher-classes');
                
                document.getElementById('conn-dot').className = "w-1.5 h-1.5 rounded-full bg-green-500 shadow-sm";
                document.getElementById('conn-text').innerText = "Live Synchronized";
                document.getElementById('footer-conn-dot').className = "w-2 h-2 rounded-full bg-green-500";
                document.getElementById('footer-conn-text').innerText = "Engine active";
            } catch(e) { alert("Auth Denied. Check connectivity."); }
        };

        window.logout = () => location.reload();
        window.toggleLangMenu = () => document.getElementById('lang-dropdown').classList.toggle('hidden');
        window.setLanguage = (l) => { currentLang = l; document.getElementById('lang-dropdown').classList.add('hidden'); renderSidebar(); };
        window.toggleNotifications = () => document.getElementById('notification-dropdown').classList.toggle('hidden');
        window.clearNotifications = () => { notificationStore = []; updateNotificationBadge(); renderNotificationList(); };
        
        window.toggleMobileMenu = () => { 
            const s = document.getElementById('sidebar'); const o = document.getElementById('mobile-overlay');
            if (s.classList.contains('-translate-x-full')) { s.classList.remove('-translate-x-full', 'hidden'); s.classList.add('flex'); o.classList.remove('hidden'); setTimeout(() => o.style.opacity = '1', 10); }
            else { s.classList.add('-translate-x-full'); o.style.opacity = '0'; setTimeout(() => o.classList.add('hidden'), 300); }
        };

        window.renderPage = async (pageId) => {
            await stopScanner();
            firestoreUnsubscribes.forEach(u => u()); firestoreUnsubscribes = [];
            const container = document.getElementById('app-content');
            container.innerHTML = '';
            document.getElementById('page-title').innerText = pageId.toUpperCase().replace('-',' ');

            if(window.innerWidth < 1024) {
                const sidebar = document.getElementById('sidebar');
                if(!sidebar.classList.contains('-translate-x-full')) window.toggleMobileMenu();
            }

            if(pageId === 'teacher-classes') {
                container.innerHTML = `<div class="mb-10"><h2 class="text-3xl font-extrabold text-slate-800 tracking-tight leading-none">Class Console</h2><p class="text-slate-400 mt-2 font-medium">Link session assets to student IDs.</p></div><div id="cls-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>`;
                const unsub = onSnapshot(collection(dbFirestore, dbCollections.classes), (snap) => {
                    const liveData = {}; snap.forEach(d => liveData[d.id] = d.data());
                    document.getElementById('cls-list').innerHTML = staticData.classes.map(cl => `
                        <div class="bg-white p-8 rounded-[2.5rem] border border-slate-100 card-premium flex flex-col justify-between h-full group overflow-hidden">
                            <div class="flex items-center gap-5 mb-10">
                                <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-[1.4rem] flex items-center justify-center text-2xl group-hover:scale-110 transition-transform"><i class="fa-solid ${cl.icon}"></i></div>
                                <div><h3 class="font-extrabold text-slate-800 text-lg">${cl.name}</h3><p class="text-[10px] uppercase font-bold text-slate-400 tracking-[0.2em]">${cl.time}</p></div>
                            </div>
                            <div class="flex gap-3">
                                <label class="w-14 h-14 bg-slate-50 rounded-2xl flex items-center justify-center cursor-pointer border-2 border-transparent hover:border-blue-200 hover:bg-blue-50 relative transition-all"><i class="fa-solid fa-paperclip text-slate-400"></i><input type="file" class="hidden" onchange="window.uploadFile('${cl.id}', this)">${liveData[cl.id]?.currentFile ? '<div class="absolute -top-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-white shadow-sm"></div>' : ''}</label>
                                <button onclick="window.startScanning('${cl.id}')" class="flex-1 bg-blue-600 text-white p-4 rounded-2xl text-xs font-black shadow-xl shadow-blue-200 hover:bg-blue-700 transition-all uppercase tracking-widest leading-none">START LINKING</button>
                            </div>
                        </div>`).join('');
                });
                firestoreUnsubscribes.push(unsub);
            } 
            else if(pageId === 'teacher-scan') {
                container.innerHTML = `<div class="max-w-md mx-auto fade-in"><div class="bg-white p-8 rounded-[3rem] shadow-2xl border border-slate-100 relative overflow-hidden"><button onclick="window.renderPage('teacher-classes')" class="mb-6 text-slate-400 hover:text-blue-600 transition flex items-center gap-2 font-bold text-xs uppercase tracking-widest p-2"><i class="fa-solid fa-arrow-left"></i> BACK</button><div id="scanner-sync-status" class="text-[10px] text-center p-2.5 bg-slate-50 rounded-2xl mb-6 text-slate-400 font-bold uppercase tracking-widest">CLOUD SYNC ACTIVE</div><div id="reader" class="rounded-[2.5rem] overflow-hidden bg-slate-900 aspect-square relative border-8 border-slate-50 shadow-inner"></div><div id="scan-feedback" class="absolute inset-x-8 top-[135px] bottom-32 rounded-[2.5rem] z-10 pointer-events-none transition-all duration-300"></div><div class="mt-8 flex gap-3"><input id="manual-id" placeholder="STUDENT ID" class="flex-1 bg-slate-50 p-4 rounded-2xl outline-none text-sm font-bold border-2 border-transparent focus:border-blue-400 transition-all uppercase tracking-tighter shadow-inner"></div></div></div>`;
                onSnapshot(doc(dbFirestore, dbCollections.classes, activeClassId), (d) => {
                    activeSessionFile = d.data()?.currentFile || null;
                    const el = document.getElementById('scanner-sync-status');
                    if(el) el.innerHTML = activeSessionFile ? `<span class="text-green-500 font-extrabold"><i class="fa-solid fa-cloud-arrow-down"></i> SYNCING: ${activeSessionFile}</span>` : `<span class="text-slate-300">READY TO LINK ID</span>`;
                });
                setTimeout(() => {
                    activeScanner = new Html5Qrcode("reader");
                    activeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => {
                        if (isProcessingScan) return;
                        isProcessingScan = true;
                        const flash = document.getElementById('scan-feedback');
                        if(flash) flash.classList.add('scan-flash');
                        window.handleTeacherScanSuccess(txt);
                        setTimeout(() => { if(flash) flash.classList.remove('scan-flash'); isProcessingScan = false; }, 2000);
                    }).catch(() => { document.getElementById('reader').innerHTML = `<div class="p-12 text-center text-red-400 font-bold text-sm">CAMERA ACCESS ERROR</div>`; });
                }, 600);
            }
            else if(pageId === 'teacher-calendar') {
                container.innerHTML = `<div class="flex flex-col lg:flex-row h-full bg-white rounded-[2.5rem] shadow-sm border border-slate-200 overflow-hidden fade-in"><div class="lg:w-2/3 flex flex-col border-r border-slate-50"><div class="p-6 border-b border-slate-50 flex justify-between items-center bg-white"><button onclick="window.changeMonth(-1, 'teacher')" class="p-3 bg-slate-50 rounded-xl hover:bg-blue-50 text-slate-400 transition-all"><i class="fa-solid fa-chevron-left"></i></button><h2 id="cal-title" class="font-extrabold text-slate-800 text-lg tracking-tight"></h2><button onclick="window.changeMonth(1, 'teacher')" class="p-3 bg-slate-50 rounded-xl hover:bg-blue-50 text-slate-400 transition-all"><i class="fa-solid fa-chevron-right"></i></button></div><div class="flex-1 p-6 md:p-10"><div id="cal-days" class="calendar-grid"></div></div></div><div class="lg:w-1/3 bg-slate-50/50 p-8 flex flex-col border-t lg:border-t-0"><h3 class="font-extrabold text-slate-800 mb-6 flex items-center gap-3"><i class="fa-solid fa-clipboard-user text-blue-500"></i> Linking Audit</h3><p id="selected-date-lbl" class="text-[10px] text-slate-400 mb-6 font-bold uppercase tracking-[0.25em]">Select a day</p><div id="att-detail-list" class="space-y-2.5 flex-1 overflow-y-auto"></div></div></div>`;
                const unsub = onSnapshot(collection(dbFirestore, dbCollections.attendance), (snap) => {
                    currentCalendarEvents = {}; snap.forEach(d => { const data = d.data(); const dateKey = new Date(data.timestamp.seconds * 1000).toISOString().split('T')[0]; if(!currentCalendarEvents[dateKey]) currentCalendarEvents[dateKey] = []; currentCalendarEvents[dateKey].push(data.studentName); });
                    refreshCalendarUI('teacher');
                    if(currentSelectedDate) window.selectDate(currentSelectedDate, document.querySelector(`[data-date="${currentSelectedDate}"]`));
                });
                firestoreUnsubscribes.push(unsub);
            }
            else if(pageId === 'student-qr') {
                container.innerHTML = `<div class="h-full flex items-center justify-center p-4"><div class="bg-white p-12 md:p-16 rounded-[4rem] shadow-2xl text-center border border-slate-50 max-w-sm w-full"><div class="w-16 h-16 bg-blue-600 rounded-[1.2rem] flex items-center justify-center text-2xl font-bold text-white mx-auto mb-8 shadow-2xl shadow-blue-200">${currentUser.name.charAt(0)}</div><h2 class="font-black text-2xl text-slate-800 mb-2">${currentUser.name}</h2><p class="text-[10px] text-blue-600 font-bold uppercase tracking-[0.35em] mb-10">Digital Student ID</p><div id="sqr" class="mb-10 flex justify-center bg-white p-4 border-2 border-slate-100 rounded-[2.5rem] shadow-inner"></div><p class="text-[11px] text-slate-400 font-bold uppercase tracking-widest leading-loose opacity-60">Identity Sync Code</p></div></div>`;
                setTimeout(() => { new QRCode(document.getElementById("sqr"), { text: JSON.stringify({ id: currentUser.id, name: currentUser.name }), width: 220, height: 220, colorDark: "#1e293b" }); }, 200);
            }
            else if(pageId === 'student-calendar') {
                container.innerHTML = `<div class="max-w-2xl mx-auto h-full bg-white rounded-[2.5rem] shadow-sm border border-slate-200 overflow-hidden fade-in flex flex-col"><div class="p-6 border-b border-slate-50 flex justify-between items-center"><button onclick="window.changeMonth(-1, 'student')" class="p-3 bg-slate-50 rounded-xl"><i class="fa-solid fa-chevron-left"></i></button><h2 id="cal-title" class="font-extrabold text-lg"></h2><button onclick="window.changeMonth(1, 'student')" class="p-3 bg-slate-50 rounded-xl"><i class="fa-solid fa-chevron-right"></i></button></div><div class="flex-1 p-6 md:p-12 overflow-y-auto"><div id="cal-days" class="calendar-grid"></div></div><div class="p-6 bg-slate-50 border-t flex items-center gap-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest"><div class="flex items-center gap-2"><span class="w-3 h-3 bg-green-200 rounded-full"></span> Marked Present</div></div></div>`;
                const qAtt = query(collection(dbFirestore, dbCollections.attendance), where('studentId', '==', String(currentUser.id)));
                const unsub = onSnapshot(qAtt, (snap) => { const myEvents = {}; snap.forEach(d => { myEvents[new Date(d.data().timestamp.seconds * 1000).toISOString().split('T')[0]] = true; }); refreshCalendarUI('student', myEvents); });
                firestoreUnsubscribes.push(unsub);
            }
            else if(pageId === 'student-materials') {
                container.innerHTML = `<div class="mb-10"><h2 class="text-3xl font-extrabold text-slate-800 tracking-tight">Synced Materials</h2></div><div id="mat-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>`;
                const q = query(collection(dbFirestore, dbCollections.materials), where('studentId', '==', String(currentUser.id)));
                const unsub = onSnapshot(q, (snap) => {
                    const items = []; snap.forEach(d=>items.push(d.data()));
                    document.getElementById('mat-list').innerHTML = items.length ? items.map(m=>`<div class="p-5 bg-white border border-slate-200 rounded-[2rem] flex items-center justify-between shadow-sm"><div class="flex items-center gap-5"><div class="w-14 h-14 bg-blue-50 text-blue-600 rounded-[1.2rem] flex items-center justify-center text-2xl"><i class="fa-solid fa-file-pdf"></i></div><div><p class="font-extrabold text-slate-800 text-sm uppercase">${m.fileName}</p></div></div><button onclick="window.downloadFile('${m.fileName}','${m.fileData}')" class="p-4 text-slate-400 hover:text-blue-600 transition-all"><i class="fa-solid fa-download text-lg"></i></button></div>`).join('') : `<div class="col-span-2 text-center py-20 opacity-40">No handouts synced.</div>`;
                });
                firestoreUnsubscribes.push(unsub);
            }
            else if(pageId.includes('chat')) {
                let contacts = currentUser.role === 'teacher' ? staticData.students : [{id:staticData.users.teacher.id, name:staticData.users.teacher.name}];
                if (!activeChatPartner && contacts.length) activeChatPartner = contacts[0];
                container.innerHTML = `<div class="flex h-full bg-white rounded-[2.5rem] shadow-sm border border-slate-200 overflow-hidden fade-in relative"><div id="chat-list" class="${(window.innerWidth < 1024 && activeChatPartner) ? 'hidden' : 'flex'} w-full lg:w-80 border-r border-slate-100 flex-col bg-slate-50/30"><div class="p-6 border-b border-slate-100 bg-white"><h3 class="font-black text-slate-800 text-lg uppercase tracking-tighter">Messages</h3></div><div class="overflow-y-auto flex-1 p-4 space-y-2">${contacts.map(c => `<div onclick="window.switchChat('${c.id}', '${c.name}')" class="p-4 rounded-2xl cursor-pointer transition-all flex items-center gap-4 ${activeChatPartner?.id === c.id ? 'bg-white shadow-lg border border-slate-100' : 'hover:bg-white border border-transparent'}"><div class="w-12 h-12 rounded-xl bg-blue-100 text-blue-600 flex items-center justify-center font-black text-lg">${c.name.charAt(0)}</div><div class="flex-1 text-sm font-bold text-slate-700">${c.name}</div></div>`).join('')}</div></div><div id="chat-area" class="${(window.innerWidth < 1024 && !activeChatPartner) ? 'hidden' : 'flex'} flex-1 flex-col bg-white"><div class="p-4 md:p-6 border-b border-slate-100 flex items-center gap-4 glass sticky top-0">${window.innerWidth < 1024 ? `<button onclick="window.switchChat(null)" class="text-slate-400 p-2 hover:bg-slate-50 rounded-xl transition-all"><i class="fa-solid fa-chevron-left"></i></button>` : ''}<div class="w-11 h-11 rounded-xl bg-blue-600 text-white flex items-center justify-center font-extrabold shadow-lg">${activeChatPartner?.name.charAt(0) || '?'}</div><h4 class="font-black text-slate-800 truncate">${activeChatPartner?.name || 'Secure Channel'}</h4></div><div id="msg-stream" class="flex-1 p-4 md:p-8 overflow-y-auto space-y-4 bg-slate-50/20 min-h-[300px]"></div><div class="p-4 md:p-6 border-t border-slate-50"><form onsubmit="window.handleSendMessage(event)" class="flex gap-3"><input type="text" id="chat-input" placeholder="Type a message..." class="flex-1 bg-slate-50 border-2 border-transparent focus:border-blue-400 rounded-2xl px-6 py-4 text-sm font-bold transition-all outline-none shadow-inner"><button type="submit" class="w-14 h-14 bg-blue-600 text-white rounded-2xl shadow-xl active:scale-90 transition-all"><i class="fa-solid fa-paper-plane text-xl"></i></button></form></div></div></div>`;
                if(activeChatPartner) {
                    const cid = [String(currentUser.id), String(activeChatPartner.id)].sort().join('_');
                    const q = query(collection(dbFirestore, dbCollections.messages), where('chatId', '==', cid));
                    const unsubChat = onSnapshot(q, (snap) => {
                        let msgs = []; snap.forEach(d => msgs.push(d.data()));
                        msgs.sort((a,b)=>(a.timestamp?.seconds||0)-(b.timestamp?.seconds||0));
                        const div = document.getElementById('msg-stream');
                        if(div) { div.innerHTML = msgs.map(m => `<div class="flex w-full ${String(m.senderId) === String(currentUser.id)?'justify-end':'justify-start'} mb-1.5 fade-in"><div class="msg-bubble ${String(m.senderId) === String(currentUser.id)?'msg-sent':'msg-received'}">${m.text}</div></div>`).join(''); div.scrollTop = div.scrollHeight; }
                    });
                    firestoreUnsubscribes.push(unsubChat);
                    markMessagesRead(activeChatPartner.id);
                }
            }
        };

        window.startScanning = (cid) => { activeClassId = cid; window.renderPage('teacher-scan'); };
        window.handleManualScan = () => { const v = document.getElementById('manual-id').value; if(v) window.handleTeacherScanSuccess(v); };
        window.changeMonth = (o, r) => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + o); window.renderPage(r === 'teacher' ? 'teacher-calendar' : 'student-calendar'); };
        window.selectDate = (k, el) => {
            currentSelectedDate = k;
            document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
            if(el) el.classList.add('selected');
            const lbl = document.getElementById('selected-date-lbl'); if(lbl) lbl.innerText = k;
            const list = document.getElementById('att-detail-list'); if(!list) return;
            const students = currentCalendarEvents[k] || [];
            list.innerHTML = students.length ? students.map(s => `<div class="p-4 bg-white border border-slate-100 rounded-2xl flex items-center gap-4 shadow-sm fade-in hover:shadow-md transition-all"><div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center font-black text-xs">${s.charAt(0)}</div><span class="text-sm font-extrabold text-slate-700">${s}</span></div>`) : `<div class="text-center text-slate-300 text-xs mt-10 p-10 border border-dashed rounded-[2rem]">No attendance data</div>`;
        };
        window.uploadFile = async (cid, input) => {
            if(!input.files[0]) return;
            const file = input.files[0]; if(file.size > 800000) return showToast("File too large (>800KB)");
            const reader = new FileReader(); reader.onload = async (e) => {
                await setDoc(doc(dbFirestore, dbCollections.classes, cid), { currentFile: file.name, currentFileData: e.target.result }, { merge: true });
                showToast("Resource Ready");
            };
            reader.readAsDataURL(file);
        };
        window.switchChat = (id, name) => { activeChatPartner = id ? { id, name } : null; window.renderPage('teacher-chat'); };
        window.openChatFromNotif = (pid, pname) => { activeChatPartner = { id: pid, name: pname }; notificationStore = notificationStore.filter(n => n.senderId !== pid); window.renderPage('teacher-chat'); markMessagesRead(pid); };
        window.handleSendMessage = async (e) => {
            e.preventDefault(); const inp = document.getElementById('chat-input'), txt = inp.value.trim(); if(!txt || !activeChatPartner) return;
            const cid = [String(currentUser.id), String(activeChatPartner.id)].sort().join('_');
            await addDoc(collection(dbFirestore, dbCollections.messages), { chatId: cid, senderId: String(currentUser.id), senderName: currentUser.name, receiverId: String(activeChatPartner.id), text: txt, timestamp: Timestamp.now(), read: false });
            inp.value = '';
        };
        window.downloadFile = (name, data) => { const a = document.createElement('a'); a.href = data; a.download = name; a.click(); };
        window.markMessagesRead = markMessagesRead;
        window.stopScanner = stopScanner;
        window.handleTeacherScanSuccess = handleTeacherScanSuccess;
        window.refreshCalendarUI = refreshCalendarUI;

        // Init connection
        signInAnonymously(auth).then(() => { window.isAuthReady = true; });

    </script>
</body>
</html>
