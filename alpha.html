<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EduSaaS - Comprehensive School Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #f8fafc; }
        .font-arabic { font-family: 'Tajawal', sans-serif; }
        .sidebar-item { transition: all 0.3s ease; border-left: 4px solid transparent; }
        .sidebar-item:hover { background-color: #eff6ff; color: #2563eb; padding-left: 1.75rem; }
        html[dir="rtl"] .sidebar-item:hover { padding-left: 1rem; padding-right: 1.75rem; border-left: none; border-right: 4px solid transparent; }
        .sidebar-item.active { background-color: #eff6ff; color: #2563eb; border-left: 4px solid #fbbf24; font-weight: 600; }
        html[dir="rtl"] .sidebar-item.active { border-left: none; border-right: 4px solid #fbbf24; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .msg-bubble { max-width: 85%; border-radius: 16px; position: relative; word-wrap: break-word; }
        .msg-sent { background: #2563eb; color: white; border-bottom-right-radius: 4px; margin-left: auto; }
        .msg-received { background: white; color: #334155; border-bottom-left-radius: 4px; margin-right: auto; border: 1px solid #e2e8f0; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .calendar-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; position: relative; background: white; border: 1px solid #f1f5f9; }
        .calendar-day:hover:not(.empty) { background-color: #f0f9ff; border-color: #bae6fd; transform: translateY(-2px); }
        .calendar-day.selected { border: 2px solid #2563eb; background-color: #eff6ff; }
        .calendar-day.has-event::after { content: ''; position: absolute; bottom: 4px; width: 4px; height: 4px; background: #2563eb; border-radius: 50%; }
        .calendar-day.present { background-color: #dcfce7 !important; border-color: #86efac !important; color: #166534 !important; font-weight: bold; }
        .empty { background: transparent; border: none; pointer-events: none; }
        .scan-flash { animation: flash-green 0.5s ease-out; }
        @keyframes flash-green { 0% { background-color: rgba(34, 197, 94, 0.5); } 100% { background-color: transparent; } }
    </style>
</head>
<body class="text-slate-600 antialiased h-screen flex overflow-hidden bg-slate-50">

    <!-- Sidebar Navigation -->
    <aside id="sidebar" class="w-72 bg-white shadow-xl z-20 hidden md:flex flex-col h-full border-r border-slate-100">
        <div class="p-8 flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white font-bold text-xl">E</div>
            <div>
                <h1 class="text-2xl font-bold text-slate-800 tracking-tight leading-none">EduSaaS</h1>
                <p id="role-display" class="text-[10px] font-semibold text-yellow-500 uppercase mt-1">Platform</p>
            </div>
        </div>
        
        <div class="mx-6 p-4 bg-blue-50 rounded-xl border border-blue-100 mb-2">
            <p class="text-[10px] text-blue-400 uppercase font-bold mb-1">Active Tenant</p>
            <div id="school-name-display" class="font-bold text-sm text-blue-900 truncate">Login Required</div>
        </div>

        <nav id="nav-menu" class="flex-1 overflow-y-auto py-4 space-y-1 px-4"></nav>

        <div class="p-6 border-t border-slate-50">
            <button onclick="window.logout()" class="flex items-center gap-3 w-full px-4 py-3 text-sm font-medium text-slate-500 hover:text-red-500 hover:bg-red-50 rounded-xl transition-colors">
                <i class="fa-solid fa-right-from-bracket"></i> Sign Out
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full relative overflow-hidden bg-slate-50/50">
        <header class="bg-white/80 backdrop-blur-md border-b border-slate-200 h-20 flex items-center justify-between px-8 shadow-sm z-30">
            <div class="flex items-center gap-4">
                <button onclick="window.toggleMobileMenu()" class="md:hidden text-slate-500 hover:text-blue-600 transition"><i class="fa-solid fa-bars text-xl"></i></button>
                <div class="flex flex-col">
                    <h2 id="page-title" class="text-xl font-bold text-slate-800 leading-tight">Dashboard</h2>
                    <div class="flex items-center gap-1.5 mt-0.5">
                        <span id="conn-status-dot" class="w-2 h-2 rounded-full bg-red-400"></span>
                        <span id="conn-status-text" class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Connecting...</span>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="relative group">
                    <button onclick="window.toggleLangMenu()" class="p-2 text-slate-400 hover:text-blue-600 transition"><i class="fa-solid fa-globe text-lg"></i></button>
                    <div id="lang-dropdown" class="hidden absolute right-0 mt-2 w-32 bg-white rounded-xl shadow-xl border border-slate-100 py-1 z-50">
                        <button onclick="window.setLanguage('en')" class="block w-full text-left px-4 py-2 text-sm hover:bg-slate-50">English</button>
                        <button onclick="window.setLanguage('ar')" class="block w-full text-right px-4 py-2 text-sm hover:bg-slate-50 font-arabic">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
                    </div>
                </div>
                <div class="h-8 w-px bg-slate-200"></div>
                <div class="flex items-center gap-3">
                    <div class="text-right hidden sm:block">
                        <p id="user-name" class="text-sm font-bold text-slate-800">Guest</p>
                        <p id="user-role" class="text-xs text-slate-500 font-medium uppercase tracking-tighter" id="debug-user-id">Guest</p>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-yellow-100 border-2 border-yellow-200 flex items-center justify-center text-yellow-700 font-bold shadow-sm" id="user-initials">?</div>
                </div>
            </div>
        </header>

        <div id="app-content" class="flex-1 overflow-y-auto p-8 relative scroll-smooth"></div>

        <div class="bg-slate-900 text-white text-[10px] py-1 px-4 flex justify-between items-center z-50">
            <div class="flex items-center gap-2" id="conn-status">
                <span id="conn-dot" class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></span>
                <span id="conn-text" class="text-yellow-400">Connecting...</span>
            </div>
            <div id="footer-user-id" class="text-slate-500 font-mono"></div>
        </div>
    </main>

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 z-50 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-4xl w-full overflow-hidden flex flex-col md:flex-row">
            <div class="md:w-5/12 bg-blue-600 p-12 flex flex-col justify-center text-white">
                <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center text-3xl font-bold mb-6">E</div>
                <h1 class="text-4xl font-bold mb-4">EduSaaS</h1>
                <p class="text-blue-100 text-lg opacity-90">Next-gen school management.</p>
            </div>
            <div class="md:w-7/12 p-12 bg-white">
                <h2 id="lbl-welcome" class="text-2xl font-bold text-slate-800 mb-2">Welcome Back</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-8">
                    <button onclick="window.login('teacher')" class="p-5 border rounded-xl hover:bg-purple-50 text-left"><span class="font-bold block text-slate-700">Teacher</span></button>
                    <button onclick="window.login('schooladmin')" class="p-5 border rounded-xl hover:bg-blue-50 text-left"><span class="font-bold block text-slate-700">School Admin</span></button>
                    <div class="p-5 border rounded-xl bg-yellow-50 md:col-span-2"><span class="font-bold text-slate-700 block mb-2 uppercase text-xs tracking-widest">Student Login</span><div class="grid grid-cols-2 gap-2"><button onclick="window.login('student1')" class="block text-xs font-bold text-slate-600 hover:text-yellow-600 bg-white p-2 rounded-lg border">Yacine Brahimi</button><button onclick="window.login('student2')" class="block text-xs font-bold text-slate-600 hover:text-yellow-600 bg-white p-2 rounded-lg border">Meriem Hadjadj</button></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="image-modal" class="fixed inset-0 z-[100] bg-black/90 hidden flex items-center justify-center p-4 cursor-pointer" onclick="this.classList.add('hidden')"><img id="modal-img" src="" class="max-w-full max-h-full rounded-lg shadow-2xl"></div>
    <div id="toast" class="fixed bottom-6 right-6 bg-slate-900 text-white px-6 py-4 rounded-xl shadow-2xl transform translate-y-24 opacity-0 transition-all duration-300 z-50 flex items-center gap-4"><div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white shrink-0"><i class="fa-solid fa-check"></i></div><span id="toast-msg" class="font-medium text-sm">Notification</span></div>
    <audio id="scan-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>
    <audio id="msg-sound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3" preload="auto"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, setDoc, getDoc, updateDoc, getDocs, doc, Timestamp, where, orderBy, enableNetwork } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. FIREBASE SETUP ---
        const firebaseConfig = {
            apiKey: "AIzaSyD2aOVfl6bXOpWCL9eaiM85g14WB25aXYg",
            authDomain: "alpha-26f1e.firebaseapp.com",
            projectId: "alpha-26f1e",
            storageBucket: "alpha-26f1e.firebasestorage.app",
            messagingSenderId: "838970744952",
            appId: "1:838970744952:web:4b190d95010ecf23e18d8d",
            measurementId: "G-230TGXB20M"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const dbFirestore = getFirestore(app);
        const appId = 'edusaas-live-demo-v2';

        // --- 2. SHARED STATE (UNIFIED MODULE SCOPE) ---
        let currentUser = null;
        let activeClassId = null;
        let activeScanner = null;
        let activeChatPartner = null;
        let firestoreUnsubscribes = [];
        let globalUnsubscribe = null;
        let currentCalendarDate = new Date();
        let currentCalendarEvents = {};
        let currentSelectedDate = null;
        let activeSessionFile = null;
        let isProcessingScan = false;
        let heartbeatInterval = null;
        let currentLang = 'en';
        let notificationStore = [];
        let presenceUnsubscribes = [];

        window.isAuthReady = false;
        window.authFailed = false;

        const dbCollections = {
            users: `artifacts/${appId}/public/data/users`,
            classes: `artifacts/${appId}/public/data/classes`,
            attendance: `artifacts/${appId}/public/data/attendance`,
            materials: `artifacts/${appId}/public/data/materials`,
            messages: `artifacts/${appId}/public/data/messages`
        };

        const staticData = {
            users: {
                superadmin: { name: 'Amine Benali', role: 'superadmin', schoolId: null, id: 'super_dz' },
                schooladmin: { name: 'Mourad Boukhalfa', role: 'schooladmin', schoolId: 's1', id: 'admin_dz' },
                teacher: { name: 'Fatima Zohra', role: 'teacher', schoolId: 's1', id: 'teacher_dz' },
                student1: { name: 'Yacine Brahimi', role: 'student', schoolId: 's1', id: 'student_dz_1' },
                student2: { name: 'Meriem Hadjadj', role: 'student', schoolId: 's1', id: 'student_dz_2' },
                student3: { name: 'Youcef Belaili', role: 'student', schoolId: 's1', id: 'student_dz_3' }
            },
            classes: [{ id: 'c1', name: 'Advanced Calculus', time: '09:00 AM' }, { id: 'c2', name: 'Linear Algebra', time: '11:00 AM' }]
        };

        const translations = {
            en: { 'lbl-no-notif': 'No notifications', 'title-teacher-classes': 'My Classes', 'title-student-materials': 'Materials', 'lbl-sending': 'Sending:', 'lbl-file-loading': 'Loading...', 'lbl-no-file': 'None', 'lbl-contacts': 'Contacts', 'lbl-type-msg': 'Type message...' },
            ar: { 'lbl-no-notif': 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª', 'title-teacher-classes': 'ÙØµÙˆÙ„ÙŠ', 'title-student-materials': 'Ø§Ù„Ù…ÙˆØ§Ø¯', 'lbl-sending': 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:', 'lbl-file-loading': 'ØªØ­Ù…ÙŠÙ„...', 'lbl-no-file': 'Ù„Ø§ ÙŠÙˆØ¬Ø¯', 'lbl-contacts': 'Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„', 'lbl-type-msg': 'Ø±Ø³Ø§Ù„Ø©...' }
        };

        // --- 3. HELPER FUNCTIONS (DEFINED FIRST IN SCOPE) ---

        const showToast = (msg) => {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('translate-y-24', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-24', 'opacity-0'), 3000);
        };

        const updateUIHeader = () => {
            if (!currentUser) return;
            document.getElementById('user-name').innerText = currentUser.name;
            document.getElementById('user-role').innerText = currentUser.role.toUpperCase();
            document.getElementById('user-initials').innerText = currentUser.name.charAt(0);
            document.getElementById('footer-user-id').innerText = currentUser.id;
            document.getElementById('school-name-display').innerText = currentUser.schoolId ? 'Private School' : 'Admin Panel';
        };

        const renderSidebar = () => {
            const nav = document.getElementById('nav-menu');
            if (!nav || !currentUser) return;
            nav.innerHTML = '';
            
            const teacherRoutes = [{ id: 'teacher-classes', label: 'My Classes', icon: 'fa-chalkboard-user' }, { id: 'teacher-calendar', label: 'Attendance', icon: 'fa-calendar-check' }, { id: 'teacher-chat', label: 'Chat', icon: 'fa-comments' }];
            const studentRoutes = [{ id: 'student-qr', label: 'My ID', icon: 'fa-id-card' }, { id: 'student-calendar', label: 'My History', icon: 'fa-calendar-days' }, { id: 'student-materials', label: 'Materials', icon: 'fa-folder-open' }];
            
            const currentRoutes = currentUser.role === 'teacher' ? teacherRoutes : studentRoutes;
            
            currentRoutes.forEach((rt) => {
                const b = document.createElement('button');
                b.className = `sidebar-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-500 rounded-xl mb-1`;
                b.innerHTML = `<i class="fa-solid ${rt.icon} w-6"></i> ${rt.label}`;
                b.onclick = () => {
                    document.querySelectorAll('.sidebar-item').forEach(x=>x.classList.remove('active'));
                    b.classList.add('active');
                    window.renderPage(rt.id);
                };
                nav.appendChild(b);
            });
        };

        const setupGlobalNotifications = () => {
            if (globalUnsubscribe) globalUnsubscribe();
            const q = query(collection(dbFirestore, dbCollections.messages), where("receiverId", "==", String(currentUser.id)));
            globalUnsubscribe = onSnapshot(q, (snap) => {
                snap.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const msg = change.doc.data();
                        if (msg.read !== true && !notificationStore.find(n => n.id === change.doc.id)) {
                             notificationStore.unshift({ id: change.doc.id, senderId: msg.senderId, senderName: msg.senderName, text: msg.text, time: msg.timestamp ? new Date(msg.timestamp.seconds * 1000) : new Date() });
                        }
                    }
                });
                window.updateNotificationBadge();
                window.renderNotificationList();
            });
        };

        const stopScanner = async () => {
            if (activeScanner) {
                try { await activeScanner.stop(); } catch (e) { console.warn(e); }
                activeScanner = null;
            }
        };

        // --- 4. SCANNER & LOGIC ---

        const handleTeacherScanSuccess = async (txt) => {
            try {
                let sData = txt.trim().startsWith('{') ? JSON.parse(txt) : { id: txt, name: "Student " + txt.substring(0,4) };
                
                await addDoc(collection(dbFirestore, dbCollections.attendance), {
                    studentId: String(sData.id),
                    studentName: sData.name,
                    classId: activeClassId,
                    className: "Class Session",
                    timestamp: Timestamp.now()
                });

                if (activeSessionFile) {
                    const clsSnap = await getDoc(doc(dbFirestore, dbCollections.classes, activeClassId));
                    const fd = clsSnap.data()?.currentFileData;
                    await addDoc(collection(dbFirestore, dbCollections.materials), {
                        studentId: String(sData.id),
                        fileName: activeSessionFile,
                        fileData: fd,
                        timestamp: Timestamp.now()
                    });
                }
                showToast(`Verified: ${sData.name}`);
            } catch (e) { showToast("QR Data Error"); }
        };

        const renderTeacherScanner = (c) => {
            c.innerHTML = `
                <div class="max-w-md mx-auto fade-in">
                    <div class="bg-white p-6 rounded-3xl shadow-xl border border-slate-100 relative">
                        <button onclick="window.renderPage('teacher-classes')" class="mb-4 text-slate-400 hover:text-blue-600 transition"><i class="fa-solid fa-arrow-left"></i> Back</button>
                        <h3 class="font-bold text-slate-800 mb-2 text-center">Scanner Camera</h3>
                        <div id="scanner-file-info" class="text-xs text-center p-2 bg-slate-50 rounded-lg mb-4 text-slate-400">Loading...</div>
                        <div id="reader" class="rounded-2xl overflow-hidden bg-slate-900 min-h-[300px] relative shadow-inner">
                            <div id="scan-feedback" class="absolute inset-0 z-10 hidden"></div>
                        </div>
                        <div class="mt-4 flex gap-2">
                            <input id="manual-id" placeholder="Manual ID..." class="flex-1 bg-slate-50 p-3 rounded-xl outline-none text-sm border focus:border-blue-300">
                            <button onclick="window.handleManualScan()" class="bg-blue-600 text-white px-4 rounded-xl"><i class="fa-solid fa-check"></i></button>
                        </div>
                    </div>
                </div>`;

            onSnapshot(doc(dbFirestore, dbCollections.classes, activeClassId), (d) => {
                activeSessionFile = d.data()?.currentFile || null;
                const el = document.getElementById('scanner-file-info');
                if(el) el.innerHTML = activeSessionFile ? `<span class="text-green-600 font-bold">ðŸ“‚ ${activeSessionFile}</span>` : `No materials attached`;
            });

            setTimeout(() => {
                const html5QrCode = new Html5Qrcode("reader");
                activeScanner = html5QrCode;
                html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => {
                    if (isProcessingScan) return;
                    isProcessingScan = true;
                    document.getElementById('scan-sound').play().catch(()=>{});
                    const flash = document.getElementById('scan-feedback');
                    if(flash) { flash.classList.remove('hidden'); flash.classList.add('scan-flash'); }
                    
                    handleTeacherScanSuccess(txt);
                    
                    setTimeout(() => { 
                        if(flash) { flash.classList.add('hidden'); flash.classList.remove('scan-flash'); }
                        isProcessingScan = false;
                    }, 2000);
                }).catch(() => {
                    document.getElementById('reader').innerHTML = `<div class="p-10 text-center text-red-400 text-sm">Camera error. Allow permissions.</div>`;
                });
            }, 500);
        };

        // --- 5. GLOBAL ATTACHMENTS (TO WINDOW) ---
        window.login = async (roleKey) => {
            const defUser = staticData.users[roleKey];
            const userRef = doc(dbFirestore, dbCollections.users, defUser.id);
            try {
                const snap = await getDoc(userRef);
                if (snap.exists()) currentUser = { ...defUser, ...snap.data() };
                else {
                    await setDoc(userRef, { name: defUser.name, role: defUser.role, schoolId: defUser.schoolId, notificationsEnabled: true });
                    currentUser = { ...defUser, notificationsEnabled: true };
                }
                document.getElementById('login-modal').classList.add('hidden');
                updateUIHeader();
                renderSidebar();
                setupGlobalNotifications();
                window.renderPage(currentUser.role === 'student' ? 'student-qr' : (currentUser.role === 'teacher' ? 'teacher-classes' : 'saas-dashboard'));
            } catch(e) { alert("Login failed. Check console."); }
        };

        window.logout = () => location.reload();
        window.setLanguage = (lang) => { currentLang = lang; document.getElementById('lang-dropdown').classList.add('hidden'); renderSidebar(); };
        window.toggleMobileMenu = () => { const s = document.getElementById('sidebar'); s.classList.toggle('hidden'); s.classList.toggle('flex'); };
        window.toggleLangMenu = () => document.getElementById('lang-dropdown').classList.toggle('hidden');
        window.startScanning = (cid) => { activeClassId = cid; window.renderPage('teacher-scan'); };
        window.handleManualScan = () => { const v = document.getElementById('manual-id').value; if(v) handleTeacherScanSuccess(v); };
        window.updateNotificationBadge = () => { const b = document.getElementById('notif-badge'); if(b) { b.innerText = notificationStore.length; notificationStore.length ? b.classList.remove('hidden') : b.classList.add('hidden'); } };
        window.renderNotificationList = () => { const l = document.getElementById('notification-list'); if(l) l.innerHTML = notificationStore.length ? notificationStore.map(n => `<div onclick="window.openChatFromNotif('${n.senderId}','${n.senderName}')" class="p-4 border-b hover:bg-blue-50 cursor-pointer text-xs"><p class="font-bold">${n.senderName}</p><p class="truncate opacity-70">${n.text}</p></div>`).join('') : `<div class="p-4 text-center text-xs opacity-50">No notifications</div>`; };
        window.handleSendMessage = async (e) => {
            e.preventDefault(); const inp = document.getElementById('chat-input'), txt = inp.value.trim(); if(!txt) return;
            const cid = [String(currentUser.id), String(activeChatPartner.id)].sort().join('_');
            await addDoc(collection(dbFirestore, dbCollections.messages), { chatId: cid, senderId: String(currentUser.id), senderName: currentUser.name, receiverId: String(activeChatPartner.id), text: txt, timestamp: Timestamp.now(), read: false });
            inp.value = '';
        };

        window.renderPage = async function(pageId) {
            await stopScanner();
            firestoreUnsubscribes.forEach(u => u()); firestoreUnsubscribes = [];
            const container = document.getElementById('app-content');
            container.innerHTML = '';
            document.getElementById('page-title').innerText = pageId.toUpperCase();

            if(pageId === 'teacher-classes') renderTeacherClasses(container);
            else if(pageId === 'teacher-scan') renderTeacherScanner(container);
            else if(pageId === 'teacher-calendar') renderTeacherCalendar(container);
            else if(pageId === 'student-qr') renderStudentQR(container);
            else if(pageId === 'student-calendar') renderStudentCalendar(container);
        };

        const renderTeacherClasses = (c) => {
            c.innerHTML = `<h2 class="text-2xl font-bold mb-6">Class Management</h2><div id="cls-list" class="space-y-3"></div>`;
            const unsub = onSnapshot(collection(dbFirestore, dbCollections.classes), (snap) => {
                const liveData = {}; snap.forEach(d => liveData[d.id] = d.data());
                document.getElementById('cls-list').innerHTML = staticData.classes.map(cl => `
                    <div class="bg-white p-5 rounded-2xl border shadow-sm flex justify-between items-center">
                        <div><h3 class="font-bold">${cl.name}</h3><p class="text-xs opacity-50">${cl.time}</p></div>
                        <div class="flex gap-2">
                            <label class="w-10 h-10 bg-slate-50 rounded-xl flex items-center justify-center cursor-pointer border relative">
                                <i class="fa-solid fa-file-arrow-up"></i><input type="file" class="hidden" onchange="window.uploadFile('${cl.id}', this)">
                                ${liveData[cl.id]?.currentFile ? '<div class="absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>' : ''}
                            </label>
                            <button onclick="window.startScanning('${cl.id}')" class="bg-blue-600 text-white px-5 py-2 rounded-xl text-sm font-bold">Scan</button>
                        </div>
                    </div>`).join('');
            });
            firestoreUnsubscribes.push(unsub);
        };

        window.uploadFile = async (cid, input) => {
            if(!input.files[0]) return;
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = async (e) => {
                await setDoc(doc(dbFirestore, dbCollections.classes, cid), { currentFile: file.name, currentFileData: e.target.result }, { merge: true });
                showToast("Material Attached");
            };
            reader.readAsDataURL(file);
        };

        const renderStudentQR = (c) => {
            c.innerHTML = `<div class="h-full flex flex-col items-center justify-center"><div class="bg-white p-10 rounded-3xl shadow-xl text-center border max-w-sm w-full"><div id="sqr" class="mb-4 flex justify-center"></div><h2 class="font-bold text-xl">${currentUser.name}</h2><p class="text-xs opacity-50 mt-2">SHOW THIS TO TEACHER</p></div></div>`;
            setTimeout(() => { new QRCode(document.getElementById("sqr"), { text: JSON.stringify({ id: currentUser.id, name: currentUser.name }), width: 220, height: 220 }); }, 200);
        };

        const renderTeacherCalendar = (container) => {
            container.innerHTML = `<div class="flex flex-col md:flex-row h-full bg-white rounded-3xl shadow-sm border overflow-hidden"><div class="md:w-2/3 flex flex-col border-r"><div class="p-6 border-b flex justify-between"><button onclick="window.changeMonth(-1, 'teacher')"><i class="fa-solid fa-chevron-left"></i></button><h2 id="cal-title" class="font-bold"></h2><button onclick="window.changeMonth(1, 'teacher')"><i class="fa-solid fa-chevron-right"></i></button></div><div class="flex-1 p-6 overflow-y-auto"><div id="cal-days" class="calendar-grid"></div></div></div><div class="md:w-1/3 bg-slate-50 p-6 flex flex-col"><h3 class="font-bold mb-4">Present Students</h3><div id="att-detail-list" class="space-y-2"></div></div></div>`;
            const unsub = onSnapshot(collection(dbFirestore, dbCollections.attendance), (snap) => {
                currentCalendarEvents = {};
                snap.forEach(d => {
                    const dateKey = new Date(d.data().timestamp.seconds * 1000).toISOString().split('T')[0];
                    if(!currentCalendarEvents[dateKey]) currentCalendarEvents[dateKey] = [];
                    currentCalendarEvents[dateKey].push(d.data().studentName);
                });
                refreshCalendarUI('teacher');
            });
            firestoreUnsubscribes.push(unsub);
        };

        const renderStudentCalendar = (container) => {
            container.innerHTML = `<div class="bg-white rounded-3xl p-6 shadow-sm border flex flex-col h-full"><div class="flex justify-between items-center mb-6"><button onclick="window.changeMonth(-1, 'student')"><i class="fa-solid fa-chevron-left"></i></button><h2 id="cal-title" class="font-bold"></h2><button onclick="window.changeMonth(1, 'student')"><i class="fa-solid fa-chevron-right"></i></button></div><div id="cal-days" class="calendar-grid"></div></div>`;
            const q = query(collection(dbFirestore, dbCollections.attendance), where('studentId', '==', String(currentUser.id)));
            const unsub = onSnapshot(q, (snap) => {
                const myEvents = {};
                snap.forEach(d => { myEvents[new Date(d.data().timestamp.seconds * 1000).toISOString().split('T')[0]] = true; });
                refreshCalendarUI('student', myEvents);
            });
            firestoreUnsubscribes.push(unsub);
        };

        const refreshCalendarUI = (role, myEvents = {}) => {
            const grid = document.getElementById('cal-days');
            const title = document.getElementById('cal-title');
            if(!grid || !title) return;
            const y = currentCalendarDate.getFullYear(), m = currentCalendarDate.getMonth();
            title.innerText = new Date(y, m).toLocaleDateString(undefined, { month: 'long', year: 'numeric' });
            grid.innerHTML = '';
            const firstDay = new Date(y, m, 1).getDay(), daysInMonth = new Date(y, m+1, 0).getDate();
            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div class="empty"></div>`;
            for(let i=1; i<=daysInMonth; i++) {
                const dateKey = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                let cls = 'calendar-day';
                if(role === 'teacher' && currentCalendarEvents[dateKey]) cls += ' has-event';
                if(role === 'student' && myEvents[dateKey]) cls += ' present';
                const onclick = role === 'teacher' ? `onclick="window.selectDate('${dateKey}', this)"` : '';
                grid.innerHTML += `<div class="${cls}" ${onclick}>${i}</div>`;
            }
        };

        window.selectDate = (dateKey, el) => {
            document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
            if(el) el.classList.add('selected');
            const list = document.getElementById('att-detail-list');
            const students = currentCalendarEvents[dateKey] || [];
            list.innerHTML = students.length ? students.map(s => `<div class="p-3 bg-white border rounded-xl text-xs font-bold shadow-sm">${s}</div>`).join('') : '<p class="text-xs opacity-50 text-center mt-10">No records</p>';
        };

        window.changeMonth = (offset, role) => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + offset);
            window.renderPage(role === 'teacher' ? 'teacher-calendar' : 'student-calendar');
        };

        // Final Init
        signInAnonymously(auth).then(() => { window.isAuthReady = true; });

    </script>
</body>
</html>
