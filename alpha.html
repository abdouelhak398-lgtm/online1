<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduSaaS - Comprehensive School Management</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- QR Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, setDoc, getDoc, updateDoc, getDocs, doc, Timestamp, where, orderBy, enableNetwork } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIGURATION (LIVE) ---
        const firebaseConfig = {
            apiKey: "AIzaSyD2aOVfl6bXOpWCL9eaiM85g14WB25aXYg",
            authDomain: "alpha-26f1e.firebaseapp.com",
            projectId: "alpha-26f1e",
            storageBucket: "alpha-26f1e.firebasestorage.app",
            messagingSenderId: "838970744952",
            appId: "1:838970744952:web:4b190d95010ecf23e18d8d",
            measurementId: "G-230TGXB20M"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const dbFirestore = getFirestore(app);
        
        // Expose to window for vanilla JS access
        window.dbFirestore = dbFirestore;
        window.auth = auth;
        window.collection = collection;
        window.addDoc = addDoc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;
        window.updateDoc = updateDoc;
        window.getDocs = getDocs;
        window.doc = doc;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
        window.Timestamp = Timestamp;
        window.enableNetwork = enableNetwork; // Exposed for retry logic
        
        // SHARED APP ID
        window.appId = 'edusaas-live-demo-v2';
        
        window.dbCollections = {
            users: `artifacts/${window.appId}/public/data/users`,
            classes: `artifacts/${window.appId}/public/data/classes`,
            attendance: `artifacts/${window.appId}/public/data/attendance`,
            materials: `artifacts/${window.appId}/public/data/materials`,
            messages: `artifacts/${window.appId}/public/data/messages`
        };

        window.isAuthReady = false;
        window.authFailed = false;
        window.authError = null;

        function showAuthErrorModal(error) {
            if (document.getElementById('auth-error-modal')) return;

            let title = "⚠️ Connection Issue";
            let message = "We couldn't connect to the authentication server.";
            let steps = "";

            if (error.code === 'auth/configuration-not-found' || error.code === 'auth/operation-not-allowed') {
                title = "⚠️ Enable Anonymous Auth";
                message = "The code is correct, but the <b>Anonymous Sign-in</b> method is disabled in your Firebase Console.";
                steps = `
                    <ol style="list-style-type:decimal; margin-left:20px; color:#e2e8f0; margin-top:10px;">
                        <li>Go to <a href="https://console.firebase.google.com/" target="_blank" style="color:#fbbf24; text-decoration:underline;">Firebase Console</a> > <b>Authentication</b>.</li>
                        <li>Click the <b>Sign-in method</b> tab.</li>
                        <li>Click <b>Anonymous</b> -> Toggle <b>Enable</b> -> Click <b>Save</b>.</li>
                    </ol>
                `;
            } else {
                message = `Error: ${error.message}`;
            }

            const modalHTML = `
                <div id="auth-error-modal" style="position:fixed; inset:0; background:rgba(15, 23, 42, 0.95); z-index:9999; color:white; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:20px; font-family:'Outfit', sans-serif;">
                    <h2 style="font-size:2rem; margin-bottom:1rem; color:#fbbf24; font-weight:700;">${title}</h2>
                    <p style="max-w:600px; color:#cbd5e1;">${message}</p>
                    <div style="text-align:left; background:#1e293b; padding:20px; border-radius:12px; margin-top:20px; border:1px solid #334155; max-width:500px; width:100%;">
                        ${steps}
                        <div style="margin-top:15px; font-size:0.75rem; color:#94a3b8; font-family:monospace;">Code: ${error.code}</div>
                    </div>
                    <button onclick="location.reload()" style="margin-top:30px; padding:12px 30px; background:#2563eb; color:white; border:none; border-radius:12px; cursor:pointer; font-weight:bold; font-size:1rem; transition:all 0.2s;">Retry Connection</button>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        const initAuth = async () => {
             try {
                 if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                 } else {
                    await signInAnonymously(auth);
                 }
             } catch (e) {
                 try {
                     await signInAnonymously(auth);
                 } catch (err) {
                     console.error("Auth Critical Error:", err);
                     window.authFailed = true;
                     window.authError = err;
                     if (typeof __initial_auth_token === 'undefined') {
                         showAuthErrorModal(err);
                     }
                 }
             }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Auth State: Connected", user.uid);
                window.isAuthReady = true;
                window.dispatchEvent(new Event('auth-ready'));
            }
        });
        
        initAuth();
    </script>
    
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #f8fafc; }
        .sidebar-item { transition: all 0.3s ease; border-left: 4px solid transparent; }
        .sidebar-item:hover { background-color: #eff6ff; color: #2563eb; padding-left: 1.75rem; }
        .sidebar-item.active { background-color: #eff6ff; color: #2563eb; border-left: 4px solid #fbbf24; font-weight: 600; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        .slide-in-right { animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .dropdown-enter { animation: dropDown 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards; transform-origin: top right; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes dropDown { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .msg-bubble { max-width: 80%; border-radius: 16px; position: relative; word-wrap: break-word; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .msg-sent { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border-bottom-right-radius: 4px; margin-left: auto; }
        .msg-received { background-color: white; color: #334155; border-bottom-left-radius: 4px; margin-right: auto; border: 1px solid #f1f5f9; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .calendar-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; position: relative; background: white; border: 1px solid #f1f5f9; }
        .calendar-day:hover:not(.empty) { background-color: #f0f9ff; border-color: #bae6fd; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .calendar-day.today { border: 2px solid #3b82f6; color: #3b82f6; font-weight: 700; }
        .calendar-day.has-event { background-color: #eff6ff; color: #1d4ed8; font-weight: 600; border-color: #bfdbfe; }
        .calendar-day.present { background-color: #f0fdf4; color: #15803d; border: 1px solid #bbf7d0; }
        .empty { background: transparent; border: none; pointer-events: none; }
        .badge-pop { animation: bounce 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes bounce { 0% { transform: scale(0); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
        @keyframes flash-green { 0% { background-color: rgba(34, 197, 94, 0.5); } 100% { background-color: transparent; } }
        .scan-flash { animation: flash-green 0.5s ease-out; }
    </style>
</head>
<body class="text-slate-600 antialiased h-screen flex overflow-hidden bg-slate-50">

    <!-- Sidebar Navigation -->
    <aside id="sidebar" class="w-72 bg-white shadow-xl z-20 hidden md:flex flex-col h-full border-r border-slate-100">
        <div class="p-8 flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-700 rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-blue-200">E</div>
            <div>
                <h1 class="text-2xl font-bold text-slate-800 tracking-tight leading-none">EduSaaS</h1>
                <p class="text-[10px] font-semibold text-yellow-500 uppercase tracking-wider mt-1">School Manager</p>
            </div>
        </div>
        
        <!-- School Context -->
        <div class="mx-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-100 mb-2">
            <p class="text-[10px] text-blue-400 uppercase font-bold mb-1">Active Tenant</p>
            <div id="school-name-display" class="font-bold text-sm text-blue-900 truncate">Select Role</div>
        </div>

        <nav id="nav-menu" class="flex-1 overflow-y-auto py-4 space-y-1 px-4">
            <!-- Nav Items -->
        </nav>

        <div class="p-6 border-t border-slate-50">
            <button onclick="logout()" class="flex items-center gap-3 w-full px-4 py-3 text-sm font-medium text-slate-500 hover:text-red-500 hover:bg-red-50 rounded-xl transition-colors">
                <i class="fa-solid fa-right-from-bracket"></i> Sign Out
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full relative overflow-hidden bg-slate-50/50">
        
        <!-- Header -->
        <header class="bg-white/80 backdrop-blur-md border-b border-slate-200 h-20 flex items-center justify-between px-8 shadow-sm z-30 sticky top-0">
            <div class="flex items-center gap-4">
                <button class="md:hidden text-slate-500 hover:text-blue-600 transition">
                    <i class="fa-solid fa-bars text-xl"></i>
                </button>
                <h2 id="page-title" class="text-xl font-bold text-slate-800">Dashboard</h2>
            </div>

            <div class="flex items-center gap-6">
                <!-- Notifications with Dropdown -->
                <div class="relative">
                    <button onclick="toggleNotifications()" class="relative p-2 text-slate-400 hover:text-blue-600 transition-colors focus:outline-none">
                        <i class="fa-regular fa-bell text-xl"></i>
                        <span id="notif-badge" class="absolute top-0 right-0 w-5 h-5 bg-yellow-400 text-blue-900 rounded-full border-2 border-white text-[10px] font-bold flex items-center justify-center hidden shadow-sm">0</span>
                    </button>
                    
                    <!-- Dropdown Menu -->
                    <div id="notification-dropdown" class="hidden absolute right-0 mt-4 w-80 bg-white rounded-2xl shadow-2xl border border-slate-100 z-50 overflow-hidden transform dropdown-enter">
                        <div class="p-4 border-b border-slate-50 bg-slate-50/50 flex justify-between items-center">
                            <h3 class="font-bold text-slate-700 text-sm">Notifications</h3>
                            <button onclick="clearNotifications()" class="text-xs text-blue-500 font-medium hover:text-blue-700">Mark all read</button>
                        </div>
                        <div id="notification-list" class="max-h-80 overflow-y-auto">
                            <!-- Items Injected Here -->
                            <div class="p-8 text-center text-slate-400 text-xs">
                                <i class="fa-regular fa-bell-slash text-2xl mb-2 opacity-50"></i>
                                <p>No new notifications</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="h-8 w-px bg-slate-200"></div>
                
                <div class="flex items-center gap-3">
                    <div class="text-right hidden sm:block">
                        <p id="user-name" class="text-sm font-bold text-slate-800">Guest</p>
                        <p id="user-role" class="text-xs text-slate-500 font-medium">Not Logged In</p>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-yellow-100 border-2 border-yellow-200 flex items-center justify-center text-yellow-700 font-bold shadow-sm" id="user-initials">?</div>
                </div>
            </div>
        </header>

        <!-- Dynamic View Container -->
        <div id="app-content" class="flex-1 overflow-y-auto p-8 relative scroll-smooth">
            <!-- Views injected here -->
        </div>

    </main>

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 z-50 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity">
        <div class="bg-white rounded-3xl shadow-2xl max-w-5xl w-full overflow-hidden flex flex-col md:flex-row fade-in border border-white/20">
            <!-- Left Side: Brand -->
            <div class="md:w-5/12 bg-blue-600 p-12 flex flex-col justify-center text-white relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                <div class="relative z-10">
                    <div class="w-16 h-16 bg-white/20 backdrop-blur rounded-2xl flex items-center justify-center text-3xl font-bold mb-6">E</div>
                    <h1 class="text-4xl font-bold mb-4 tracking-tight">EduSaaS</h1>
                    <p class="text-blue-100 text-lg mb-8 leading-relaxed">The next-gen platform for modern schools. Scan, track, and learn.</p>
                    <div class="space-y-4 text-sm font-medium text-blue-50">
                        <div class="flex items-center gap-3 bg-blue-700/30 p-3 rounded-xl border border-blue-500/30">
                            <i class="fa-solid fa-qrcode text-yellow-400"></i> Smart Attendance
                        </div>
                        <div class="flex items-center gap-3 bg-blue-700/30 p-3 rounded-xl border border-blue-500/30">
                            <i class="fa-solid fa-comments text-yellow-400"></i> Real-time Chat
                        </div>
                    </div>
                </div>
            </div>
            <!-- Right Side: Roles -->
            <div class="md:w-7/12 p-12 bg-white">
                <h2 class="text-2xl font-bold text-slate-800 mb-2">Welcome Back</h2>
                <p class="text-slate-500 mb-8">Select your role to access the dashboard.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button onclick="login('superadmin')" class="p-5 border border-slate-200 rounded-2xl hover:border-purple-500 hover:bg-purple-50 hover:shadow-md transition-all group text-left">
                        <div class="w-10 h-10 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform"><i class="fa-solid fa-shield-halved"></i></div>
                        <span class="font-bold text-slate-700 group-hover:text-purple-700 block">Super Admin</span>
                        <span class="text-xs text-slate-400">Platform Owner</span>
                    </button>

                    <button onclick="login('schooladmin')" class="p-5 border border-slate-200 rounded-2xl hover:border-blue-500 hover:bg-blue-50 hover:shadow-md transition-all group text-left">
                        <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform"><i class="fa-solid fa-building-columns"></i></div>
                        <span class="font-bold text-slate-700 group-hover:text-blue-700 block">School Admin</span>
                        <span class="text-xs text-slate-400">Principal/Staff</span>
                    </button>

                    <button onclick="login('teacher')" class="p-5 border border-slate-200 rounded-2xl hover:border-green-500 hover:bg-green-50 hover:shadow-md transition-all group text-left">
                        <div class="w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform"><i class="fa-solid fa-chalkboard-user"></i></div>
                        <span class="font-bold text-slate-700 group-hover:text-green-700 block">Teacher</span>
                        <span class="text-xs text-slate-400">Faculty Member</span>
                    </button>

                    <!-- Student Selection Group -->
                    <div class="p-5 border border-slate-200 rounded-2xl bg-yellow-50/50 hover:shadow-md transition-all group">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-10 h-10 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center"><i class="fa-solid fa-graduation-cap"></i></div>
                            <div>
                                <span class="font-bold text-slate-700 block">Student</span>
                                <span class="text-xs text-slate-400">Select Profile</span>
                            </div>
                        </div>
                        <div class="space-y-2 pl-2">
                            <button onclick="login('student1')" class="w-full text-left text-xs font-bold text-slate-600 hover:text-yellow-600 flex items-center gap-2">
                                <span class="w-2 h-2 bg-yellow-400 rounded-full"></span> Yacine Brahimi
                            </button>
                            <button onclick="login('student2')" class="w-full text-left text-xs font-bold text-slate-600 hover:text-yellow-600 flex items-center gap-2">
                                <span class="w-2 h-2 bg-yellow-400 rounded-full"></span> Meriem Hadjadj
                            </button>
                            <button onclick="login('student3')" class="w-full text-left text-xs font-bold text-slate-600 hover:text-yellow-600 flex items-center gap-2">
                                <span class="w-2 h-2 bg-yellow-400 rounded-full"></span> Youcef Belaili
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-6 right-6 bg-slate-900 text-white px-6 py-4 rounded-xl shadow-2xl transform translate-y-24 opacity-0 transition-all duration-300 z-50 flex items-center gap-4">
        <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white shrink-0"><i class="fa-solid fa-check"></i></div>
        <span id="toast-msg" class="font-medium text-sm">Notification</span>
    </div>

    <!-- Audio Assets -->
    <audio id="scan-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>
    <audio id="msg-sound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3" preload="auto"></audio>

    <script>
        // --- 1. STATE & DATA ---
        const db = {
            schools: [
                { id: 's1', name: 'École Privée El Nardjess', type: 'Private' },
                { id: 's2', name: 'Lycée Emir Abdelkader', type: 'Public' }
            ],
            users: {
                superadmin: { name: 'Amine Benali', role: 'superadmin', schoolId: null, id: 'super_dz' },
                schooladmin: { name: 'Mourad Boukhalfa', role: 'schooladmin', schoolId: 's1', id: 'admin_dz' },
                teacher: { name: 'Fatima Zohra', role: 'teacher', schoolId: 's1', id: 'teacher_dz' },
                student1: { name: 'Yacine Brahimi', role: 'student', schoolId: 's1', id: 'student_dz_1' },
                student2: { name: 'Meriem Hadjadj', role: 'student', schoolId: 's1', id: 'student_dz_2' },
                student3: { name: 'Youcef Belaili', role: 'student', schoolId: 's1', id: 'student_dz_3' }
            },
            classes: [
                { id: 'c1', name: 'Advanced Calculus', time: '09:00 AM', room: '101', currentFile: null },
                { id: 'c2', name: 'Linear Algebra', time: '11:00 AM', room: '102', currentFile: null }
            ],
            // This student list MUST match db.users IDs for the chat/contact list to work
            students: [
                { id: 'student_dz_1', name: 'Yacine Brahimi', attendance: 85, tuitionStatus: 'Paid', tuitionDue: 0 },
                { id: 'student_dz_2', name: 'Meriem Hadjadj', attendance: 100, tuitionStatus: 'Paid', tuitionDue: 0 },
                { id: 'student_dz_3', name: 'Youcef Belaili', attendance: 92, tuitionStatus: 'Overdue', tuitionDue: 1200 },
                { id: 'student_dz_4', name: 'Sofiane Feghouli', attendance: 45, tuitionStatus: 'Pending', tuitionDue: 500 },
            ]
        };

        let currentUser = null;
        let activeClassId = null;
        let activeScanner = null;
        let activeChatPartner = null;
        let firestoreUnsubscribes = [];
        let globalUnsubscribe = null;
        let userProfileUnsubscribe = null; // Listener for user profile changes
        let notificationStore = []; 
        let currentCalendarDate = new Date();
        let activeSessionFile = null;
        let isFileSynced = false;

        const routes = {
            superadmin: [
                { id: 'saas-dashboard', label: 'Platform Overview', icon: 'fa-chart-line' },
                { id: 'saas-schools', label: 'Manage Schools', icon: 'fa-school' },
                { id: 'saas-subs', label: 'Subscriptions', icon: 'fa-credit-card' },
                { id: 'settings', label: 'Settings', icon: 'fa-cog' }
            ],
            schooladmin: [
                { id: 'admin-dashboard', label: 'Dashboard', icon: 'fa-chart-pie' },
                { id: 'admin-finance', label: 'Financial Module', icon: 'fa-coins' },
                { id: 'admin-users', label: 'User Management', icon: 'fa-users' },
                { id: 'admin-payroll', label: 'Teacher Payroll', icon: 'fa-file-invoice-dollar' },
                { id: 'settings', label: 'Settings', icon: 'fa-cog' }
            ],
            teacher: [
                { id: 'teacher-classes', label: 'My Classes & Scanning', icon: 'fa-chalkboard-user' },
                { id: 'teacher-calendar', label: 'Attendance Calendar', icon: 'fa-calendar-check' },
                { id: 'teacher-chat', label: 'Chat with Students', icon: 'fa-comments' },
                { id: 'settings', label: 'Settings', icon: 'fa-cog' }
            ],
            student: [
                { id: 'student-qr', label: 'My Digital ID', icon: 'fa-id-card' },
                { id: 'student-calendar', label: 'Attendance Calendar', icon: 'fa-calendar-days' },
                { id: 'student-materials', label: 'Received Materials', icon: 'fa-folder-open' },
                { id: 'teacher-chat', label: 'Chat with Teacher', icon: 'fa-comments' },
                { id: 'settings', label: 'Settings', icon: 'fa-cog' }
            ]
        };

        // --- 2. AUTH & INIT ---
        
        async function safeGetDoc(docRef, retries = 5, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    return await window.getDoc(docRef);
                } catch (e) {
                    // Check for offline/unavailable errors
                    if ((e.code === 'unavailable' || e.message.includes('offline')) && i < retries - 1) {
                        console.warn(`Connection unstable, retrying data fetch (${i + 1}/${retries})...`);
                        await new Promise(r => setTimeout(r, delay));
                        // Attempt to force network enabled
                        try { await window.enableNetwork(window.dbFirestore); } catch (netErr) { console.log("Network enable attempt:", netErr); }
                    } else {
                        throw e; // Rethrow other errors immediately
                    }
                }
            }
            throw new Error("Max retries reached for document fetch.");
        }

        async function login(roleKey) {
            // IMMEDIATE FAIL CHECK
            if (window.authFailed) {
                showAuthErrorModal(window.authError);
                return;
            }

            // Short timeout check instead of long poll
            if (!window.isAuthReady) {
                showToast("Connecting to cloud... please wait.");
                try {
                    await new Promise((resolve, reject) => {
                        let attempts = 0;
                        const interval = setInterval(() => {
                            attempts++;
                            if (window.isAuthReady) {
                                clearInterval(interval);
                                resolve();
                            } else if (window.authFailed) {
                                clearInterval(interval);
                                reject("Auth failed during wait");
                            } else if (attempts > 50) { // Increased wait to 5s
                                clearInterval(interval);
                                // Don't reject, try to proceed, maybe auth is slow but will happen during fetch
                                console.warn("Auth wait timeout - attempting to proceed");
                                resolve(); 
                            }
                        }, 100);
                    });
                } catch (e) {
                    showAuthErrorModal(window.authError || { code: 'timeout', message: 'Connection timed out' });
                    return;
                }
            }
            
            const defaultUser = db.users[roleKey];
            const isStudent = defaultUser.role === 'student';
            
            // Fetch or Create User Profile from Firestore with RETRY logic
            const userRef = window.doc(window.dbFirestore, window.dbCollections.users, defaultUser.id);
            try {
                const docSnap = await safeGetDoc(userRef);
                if (docSnap.exists()) {
                    currentUser = { ...defaultUser, ...docSnap.data() };
                } else {
                    // Create initial profile
                    await window.setDoc(userRef, {
                        name: defaultUser.name,
                        role: defaultUser.role,
                        schoolId: defaultUser.schoolId,
                        bio: isStudent ? 'Student' : 'Faculty Member',
                        notificationsEnabled: true
                    });
                    currentUser = { ...defaultUser, bio: isStudent ? 'Student' : 'Faculty Member', notificationsEnabled: true };
                }
            } catch (e) {
                console.error("Profile Fetch Error", e);
                // Fallback to local data so app doesn't crash
                currentUser = defaultUser;
                showToast("Offline Mode: Some features restricted");
            }

            document.getElementById('login-modal').classList.add('hidden');
            updateUIHeader();
            renderSidebar();
            
            // Listen for profile changes (Real-time updates to self)
            userProfileUnsubscribe = window.onSnapshot(userRef, (doc) => {
                if (doc.exists()) {
                    const newData = doc.data();
                    currentUser = { ...currentUser, ...newData };
                    updateUIHeader(); // Update header name immediately
                }
            });

            setupGlobalNotifications();
            
            const startPage = isStudent ? 'student-qr' : (defaultUser.role === 'teacher' ? 'teacher-classes' : 'saas-dashboard');
            renderPage(startPage);
            showToast(`Welcome back, ${currentUser.name}`);
        }

        function logout() {
            if(activeScanner) try { activeScanner.stop(); activeScanner = null; } catch(e){}
            firestoreUnsubscribes.forEach(u => u()); firestoreUnsubscribes = [];
            if(globalUnsubscribe) globalUnsubscribe();
            if(userProfileUnsubscribe) userProfileUnsubscribe();
            
            currentUser = null;
            notificationStore = [];
            updateNotificationBadge();
            document.getElementById('login-modal').classList.remove('hidden');
            document.getElementById('app-content').innerHTML = '';
        }

        function updateUIHeader() {
            if (!currentUser) return;
            document.getElementById('user-name').innerText = currentUser.name;
            document.getElementById('user-role').innerText = currentUser.role.toUpperCase();
            document.getElementById('user-initials').innerText = currentUser.name.charAt(0);
            const sName = currentUser.schoolId ? db.schools.find(s => s.id === currentUser.schoolId).name : 'Super Admin';
            document.getElementById('school-name-display').innerText = sName;
        }

        // --- 3. NOTIFICATION SYSTEM ---
        function toggleNotifications() {
            const dd = document.getElementById('notification-dropdown');
            dd.classList.toggle('hidden');
        }

        function setupGlobalNotifications() {
            if (globalUnsubscribe) globalUnsubscribe();
            const messagesRef = window.collection(window.dbFirestore, window.dbCollections.messages);
            const q = window.query(messagesRef, window.where("receiverId", "==", String(currentUser.id)));
            
            let initialLoad = true;
            globalUnsubscribe = window.onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const msg = change.doc.data();
                        
                        // Check if unread before adding to store
                        if (msg.read !== true && !notificationStore.find(n => n.id === change.doc.id)) {
                             notificationStore.unshift({
                                id: change.doc.id,
                                senderId: msg.senderId,
                                senderName: msg.senderName,
                                text: msg.text,
                                time: msg.timestamp ? new Date(msg.timestamp.seconds * 1000) : new Date()
                            });
                        }
                        
                        // Play sound ONLY for fresh messages (not historic load)
                        const now = Date.now() / 1000;
                        const msgTime = msg.timestamp?.seconds || 0;
                        const isRecent = (now - msgTime) < 10; // 10 seconds threshold

                        if (!initialLoad && isRecent && msg.read !== true && currentUser.notificationsEnabled !== false) {
                            document.getElementById('msg-sound').play().catch(e=>{});
                            showToast(`New message from ${msg.senderName}`);
                        }
                    }
                    if (change.type === "modified") {
                        const msg = change.doc.data();
                        if (msg.read === true) {
                            notificationStore = notificationStore.filter(n => n.id !== change.doc.id);
                        }
                    }
                });
                
                notificationStore.sort((a,b) => b.time - a.time);
                updateNotificationBadge();
                renderNotificationList();
                
                initialLoad = false;
            });
        }

        function renderNotificationList() {
            const list = document.getElementById('notification-list');
            if (notificationStore.length === 0) {
                list.innerHTML = `<div class="p-8 text-center text-slate-400 text-xs"><i class="fa-regular fa-bell-slash text-2xl mb-2 opacity-50"></i><p>No new notifications</p></div>`;
                return;
            }
            list.innerHTML = notificationStore.map((notif, index) => `
                <div onclick="openChatFromNotif('${notif.senderId}', '${notif.senderName}')" class="p-4 border-b border-slate-50 hover:bg-blue-50 cursor-pointer transition flex items-start gap-3">
                    <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-xs shrink-0">${notif.senderName.charAt(0)}</div>
                    <div class="flex-1 overflow-hidden">
                        <p class="text-sm font-bold text-slate-700 truncate">${notif.senderName}</p>
                        <p class="text-xs text-slate-500 truncate">${notif.text}</p>
                        <p class="text-[10px] text-slate-400 mt-1">${notif.time.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</p>
                    </div>
                    <div class="w-2 h-2 bg-blue-500 rounded-full mt-2"></div>
                </div>
            `).join('');
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notif-badge');
            const count = notificationStore.length;
            if (count > 0) {
                badge.innerText = count > 9 ? '9+' : count;
                badge.classList.remove('hidden');
                badge.classList.remove('badge-pop');
                void badge.offsetWidth;
                badge.classList.add('badge-pop');
            } else {
                badge.classList.add('hidden');
            }
        }

        function clearNotifications() {
            notificationStore = [];
            updateNotificationBadge();
            renderNotificationList();
        }

        function openChatFromNotif(partnerId, partnerName) {
            document.getElementById('notification-dropdown').classList.add('hidden');
            notificationStore = notificationStore.filter(n => n.senderId !== partnerId);
            updateNotificationBadge();
            renderNotificationList();
            activeChatPartner = { id: partnerId, name: partnerName };
            renderPage('teacher-chat');
            markMessagesRead(partnerId);
        }

        async function markMessagesRead(senderId) {
            try {
                const q = window.query(
                    window.collection(window.dbFirestore, window.dbCollections.messages), 
                    window.where("senderId", "==", senderId),
                    window.where("receiverId", "==", String(currentUser.id)),
                    window.where("read", "==", false)
                );
                const snapshot = await window.getDocs(q);
                snapshot.forEach(doc => {
                    window.updateDoc(window.doc(window.dbFirestore, window.dbCollections.messages, doc.id), { read: true });
                });
            } catch(e) { console.error("Error marking read", e); }
        }

        // --- 4. ROUTER ---
        function renderPage(pageId) {
            document.getElementById('notification-dropdown').classList.add('hidden');
            if(activeScanner) { activeScanner.stop().catch(e=>{}); activeScanner = null; }
            firestoreUnsubscribes.forEach(u => u()); firestoreUnsubscribes = [];

            const container = document.getElementById('app-content');
            container.innerHTML = '';
            
            const titles = {
                'teacher-classes': 'My Classes',
                'teacher-calendar': 'Attendance Records',
                'student-qr': 'My Digital ID',
                'student-calendar': 'My History',
                'teacher-chat': 'Messages',
                'settings': 'Account Settings'
            };
            document.getElementById('page-title').innerText = titles[pageId] || 'Dashboard';

            switch(pageId) {
                case 'teacher-classes': renderTeacherClasses(container); break;
                case 'teacher-scan': renderTeacherScanner(container); break;
                case 'teacher-calendar': renderTeacherCalendar(container); break;
                case 'teacher-chat': renderChat(container); break;
                case 'student-qr': renderStudentQR(container); break;
                case 'student-calendar': renderStudentCalendar(container); break;
                case 'student-materials': renderStudentMaterials(container); break;
                case 'settings': renderSettings(container); break;
                default: container.innerHTML = '<div class="text-center mt-10 text-slate-400">Section Under Development</div>';
            }
        }

        // --- 5. PAGE RENDERERS ---
        
        // SETTINGS PAGE
        function renderSettings(container) {
            container.innerHTML = `
                <div class="max-w-2xl mx-auto bg-white rounded-3xl shadow-sm border border-slate-100 fade-in p-8">
                    <h2 class="text-xl font-bold text-slate-800 mb-6">Profile Settings</h2>
                    
                    <div class="space-y-6">
                        <!-- Role Field (Locked) -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Account Role</label>
                            <div class="w-full bg-slate-100 border border-slate-200 rounded-xl px-4 py-3 text-sm text-slate-500 flex justify-between items-center cursor-not-allowed opacity-75">
                                <span class="font-bold uppercase tracking-wider text-xs">${currentUser.role}</span>
                                <div class="flex items-center gap-2 text-xs text-slate-400">
                                    <span>Locked</span>
                                    <i class="fa-solid fa-lock"></i>
                                </div>
                            </div>
                            <p class="text-[10px] text-slate-400 mt-1 pl-1">Role assignments are managed by your institution administrator.</p>
                        </div>

                        <!-- Name Field -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Display Name</label>
                            <input type="text" id="settings-name" value="${currentUser.name}" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-300 outline-none transition">
                        </div>

                        <!-- Bio/Title Field -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Title / Bio</label>
                            <input type="text" id="settings-bio" value="${currentUser.bio || ''}" placeholder="e.g. Math Teacher" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-300 outline-none transition">
                        </div>

                        <!-- Notifications Toggle -->
                        <div class="flex items-center justify-between p-4 bg-slate-50 rounded-xl border border-slate-100">
                            <div>
                                <h4 class="font-bold text-slate-700 text-sm">Notifications</h4>
                                <p class="text-xs text-slate-500">Receive sounds and popups for messages.</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="settings-notif" class="sr-only peer" ${currentUser.notificationsEnabled !== false ? 'checked' : ''}>
                                <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>

                        <div class="pt-4 border-t border-slate-50 flex justify-end">
                            <button onclick="saveSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-bold text-sm shadow-lg shadow-blue-200 transition transform hover:scale-105">
                                Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function saveSettings() {
            const newName = document.getElementById('settings-name').value.trim();
            const newBio = document.getElementById('settings-bio').value.trim();
            const notifEnabled = document.getElementById('settings-notif').checked;

            if (!newName) return showToast("Name cannot be empty");

            try {
                await window.setDoc(window.doc(window.dbFirestore, window.dbCollections.users, currentUser.id), {
                    name: newName, bio: newBio, notificationsEnabled: notifEnabled
                }, { merge: true });
                currentUser.name = newName; currentUser.bio = newBio; currentUser.notificationsEnabled = notifEnabled;
                updateUIHeader(); showToast("Settings Saved Successfully");
            } catch (e) { console.error("Save Error", e); showToast("Failed to save settings"); }
        }

        // CALENDARS
        function renderTeacherCalendar(container) {
            container.innerHTML = `
                <div class="flex flex-col h-full bg-white rounded-3xl shadow-sm border border-slate-100 fade-in overflow-hidden">
                    <div class="p-6 border-b border-slate-50 flex justify-between items-center">
                        <div class="flex gap-2">
                            <button onclick="changeMonth(-1, 'teacher')" class="w-8 h-8 hover:bg-slate-50 rounded-full flex items-center justify-center text-slate-500"><i class="fa-solid fa-chevron-left"></i></button>
                            <h2 id="calendar-title" class="text-lg font-bold text-slate-800 w-32 text-center"></h2>
                            <button onclick="changeMonth(1, 'teacher')" class="w-8 h-8 hover:bg-slate-50 rounded-full flex items-center justify-center text-slate-500"><i class="fa-solid fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="flex-1 flex overflow-hidden">
                        <div class="w-2/3 p-8 border-r border-slate-50 overflow-y-auto">
                            <div class="calendar-grid mb-2 text-center text-slate-400 text-xs font-bold uppercase"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div>
                            <div id="calendar-days" class="calendar-grid"></div>
                        </div>
                        <div class="w-1/3 p-8 bg-slate-50 overflow-y-auto">
                            <h3 class="font-bold text-slate-700 mb-4" id="detail-date">Select a Date</h3>
                            <div id="attendance-list" class="space-y-2 text-sm text-slate-500">Click a blue day to view attendees.</div>
                        </div>
                    </div>
                </div>
            `;
            const attRef = window.collection(window.dbFirestore, window.dbCollections.attendance);
            const unsub = window.onSnapshot(attRef, (snap) => {
                const events = {};
                snap.forEach(doc => {
                    const d = doc.data();
                    const date = new Date(d.timestamp.seconds*1000).toISOString().split('T')[0];
                    if(!events[date]) events[date]=[]; events[date].push(d);
                });
                renderCalendarGrid('calendar-days', 'calendar-title', events, 'teacher');
            });
            firestoreUnsubscribes.push(unsub);
        }

        function renderStudentCalendar(container) {
            container.innerHTML = `
                <div class="h-full bg-white rounded-3xl shadow-sm border border-slate-100 fade-in p-8">
                    <div class="flex justify-between items-center mb-8">
                        <div class="flex gap-2">
                            <button onclick="changeMonth(-1, 'student')" class="w-8 h-8 hover:bg-slate-50 rounded-full flex items-center justify-center"><i class="fa-solid fa-chevron-left"></i></button>
                            <h2 id="calendar-title" class="text-xl font-bold text-slate-800"></h2>
                            <button onclick="changeMonth(1, 'student')" class="w-8 h-8 hover:bg-slate-50 rounded-full flex items-center justify-center"><i class="fa-solid fa-chevron-right"></i></button>
                        </div>
                        <div class="flex gap-2 text-sm text-slate-600"><span class="w-4 h-4 bg-green-100 border border-green-300 rounded block"></span> Days Present</div>
                    </div>
                    <div class="max-w-5xl mx-auto">
                        <div class="calendar-grid mb-4 text-center text-slate-400 text-sm font-bold uppercase"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div>
                        <div id="calendar-days" class="calendar-grid gap-3"></div>
                    </div>
                </div>
            `;
            const attRef = window.collection(window.dbFirestore, window.dbCollections.attendance);
            const q = window.query(attRef, window.where('studentId', '==', String(currentUser.id)));
            const unsub = window.onSnapshot(q, (snap) => {
                const events = {};
                snap.forEach(doc => {
                    const d = doc.data();
                    const date = new Date(d.timestamp.seconds*1000).toISOString().split('T')[0];
                    if(!events[date]) events[date]=[]; events[date].push(d);
                });
                renderCalendarGrid('calendar-days', 'calendar-title', events, 'student');
            });
            firestoreUnsubscribes.push(unsub);
        }

        function changeMonth(offset, role) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + offset);
            role === 'teacher' ? renderTeacherCalendar(document.getElementById('app-content')) : renderStudentCalendar(document.getElementById('app-content'));
        }

        function renderCalendarGrid(gridId, titleId, events, role) {
            const grid = document.getElementById(gridId);
            const title = document.getElementById(titleId);
            if(!grid || !title) return;
            const y = currentCalendarDate.getFullYear();
            const m = currentCalendarDate.getMonth();
            title.innerText = new Date(y, m).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            grid.innerHTML = '';
            const first = new Date(y, m, 1).getDay();
            const days = new Date(y, m + 1, 0).getDate();
            for(let i=0; i<first; i++) grid.innerHTML += `<div class="empty"></div>`;
            for(let i=1; i<=days; i++) {
                const dateKey = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const has = events[dateKey] && events[dateKey].length > 0;
                let cls = 'calendar-day';
                if(role === 'student' && has) cls += ' present';
                if(role === 'teacher' && has) cls += ' has-event';
                const el = document.createElement('div'); el.className = cls; el.innerText = i;
                if(role === 'teacher' && has) el.onclick = () => showAttendanceDetails(dateKey, events[dateKey]);
                grid.appendChild(el);
            }
        }

        function showAttendanceDetails(d, recs) {
            document.getElementById('detail-date').innerText = `Present on ${d}`;
            document.getElementById('attendance-list').innerHTML = recs.map(r => `
                <div class="flex items-center gap-3 p-3 bg-white border border-slate-100 rounded-xl shadow-sm mb-2">
                    <div class="w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-bold text-xs">${r.studentName.charAt(0)}</div>
                    <div><p class="text-slate-800 font-bold text-sm">${r.studentName}</p><p class="text-xs text-slate-400">${r.className}</p></div>
                </div>
            `).join('');
        }

        // CHAT
        function renderChat(container) {
            let contacts = currentUser.role === 'teacher' ? db.students.map(s => ({id:s.id, name:s.name})) : [{id:db.users.teacher.id, name:db.users.teacher.name}];
            if (!activeChatPartner && contacts.length) activeChatPartner = contacts[0];

            container.innerHTML = `
                <div class="flex h-full bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden fade-in">
                    <div class="w-1/3 border-r border-slate-50 bg-slate-50 flex flex-col">
                        <div class="p-6 border-b border-slate-100"><h3 class="font-bold text-slate-700">Contacts</h3></div>
                        <div class="overflow-y-auto flex-1 p-2 space-y-1">
                            ${contacts.map(c => `
                                <div onclick="switchChat('${c.id}', '${c.name}')" class="p-3 rounded-xl cursor-pointer hover:bg-white transition flex items-center gap-3 ${activeChatPartner?.id === c.id ? 'bg-white shadow-sm ring-1 ring-slate-100' : ''}">
                                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 text-white flex items-center justify-center font-bold relative">
                                        ${c.name.charAt(0)}
                                        <div id="contact-badge-${c.id}" class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full text-[10px] flex items-center justify-center hidden border border-white text-white">0</div>
                                    </div>
                                    <span id="contact-name-${c.id}" class="font-medium text-slate-700 text-sm">${c.name}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="flex-1 flex flex-col bg-white">
                        <div class="p-4 border-b border-slate-50 flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-yellow-100 text-yellow-700 flex items-center justify-center font-bold">${activeChatPartner?.name.charAt(0)}</div>
                            <h4 class="font-bold text-slate-800">${activeChatPartner?.name}</h4>
                        </div>
                        <div id="msg-stream" class="flex-1 p-6 overflow-y-auto space-y-3 bg-slate-50/30"></div>
                        <div class="p-4 bg-white border-t border-slate-50">
                            <form onsubmit="handleSendMessage(event)" class="flex gap-2">
                                <label class="p-3 text-slate-400 hover:text-blue-600 cursor-pointer transition"><i class="fa-solid fa-paperclip"></i><input type="file" id="chat-file-input" class="hidden" onchange="showFileSelected(this)"></label>
                                <div class="flex-1 bg-slate-100 rounded-full flex items-center px-4 border border-transparent focus-within:border-blue-300 focus-within:bg-white transition">
                                    <input type="text" id="chat-input" placeholder="Type message..." class="w-full bg-transparent border-none outline-none text-sm py-3">
                                    <span id="file-indicator" class="text-xs text-blue-600 font-bold hidden mr-2"></span>
                                </div>
                                <button type="submit" class="w-12 h-12 bg-blue-600 text-white rounded-full hover:bg-blue-700 shadow-lg shadow-blue-200 transition transform hover:scale-105"><i class="fa-solid fa-paper-plane"></i></button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            if(activeChatPartner) {
                markMessagesRead(activeChatPartner.id);
                setupChatListener(activeChatPartner.id);
            }

            const msgRef = window.collection(window.dbFirestore, window.dbCollections.messages);
            const q = window.query(msgRef, window.where("receiverId", "==", String(currentUser.id)), window.where("read", "==", false));
            const countUnsub = window.onSnapshot(q, (snapshot) => {
                const unreadCounts = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    unreadCounts[data.senderId] = (unreadCounts[data.senderId] || 0) + 1;
                });
                
                contacts.forEach(c => {
                    const el = document.getElementById(`contact-name-${c.id}`);
                    const badge = document.getElementById(`contact-badge-${c.id}`);
                    const count = unreadCounts[c.id] || 0;
                    
                    if (el && badge) {
                        if (count > 0 && activeChatPartner?.id !== c.id) { 
                            el.classList.add('font-extrabold', 'text-blue-600');
                            el.classList.remove('font-medium', 'text-slate-700');
                            badge.innerText = count;
                            badge.classList.remove('hidden');
                        } else {
                            el.classList.remove('font-extrabold', 'text-blue-600');
                            el.classList.add('font-medium', 'text-slate-700');
                            badge.classList.add('hidden');
                        }
                    }
                });
            });
            firestoreUnsubscribes.push(countUnsub);
        }

        function switchChat(id, name) {
            activeChatPartner = { id, name };
            renderPage('teacher-chat');
        }

        function setupChatListener(pid) {
            const cid = [String(currentUser.id), String(pid)].sort().join('_');
            const ref = window.collection(window.dbFirestore, window.dbCollections.messages);
            const q = window.query(ref, window.where('chatId', '==', cid));
            const unsub = window.onSnapshot(q, (snap) => {
                let msgs = [];
                snap.forEach(d => msgs.push({id: d.id, ...d.data()}));
                msgs.sort((a,b)=>(a.timestamp?.seconds||0)-(b.timestamp?.seconds||0));
                
                const div = document.getElementById('msg-stream');
                div.innerHTML = msgs.map(m => {
                    if (m.senderId === activeChatPartner.id && !m.read) {
                        setTimeout(() => {
                             window.updateDoc(window.doc(window.dbFirestore, window.dbCollections.messages, m.id), { read: true });
                        }, 500);
                    }

                    const isMe = String(m.senderId) === String(currentUser.id);
                    return `<div class="flex w-full ${isMe?'justify-end':'justify-start'} slide-in-right"><div class="msg-bubble px-4 py-3 text-sm ${isMe?'msg-sent':'msg-received'}">${m.file?`<div class="mb-1 bg-white/20 p-2 rounded flex items-center gap-2 text-xs font-bold"><i class="fa-solid fa-file"></i> ${m.file}</div>`:''} ${m.text} <span class="text-[9px] opacity-60 block text-right mt-1">${new Date(m.timestamp?.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span></div></div>`;
                }).join('');
                div.scrollTop = div.scrollHeight;
            });
            firestoreUnsubscribes.push(unsub);
        }

        async function handleSendMessage(e) {
            e.preventDefault();
            const inp = document.getElementById('chat-input');
            const finp = document.getElementById('chat-file-input');
            const txt = inp.value.trim();
            if(!txt && !finp.files[0]) return;
            const cid = [String(currentUser.id), String(activeChatPartner.id)].sort().join('_');
            await window.addDoc(window.collection(window.dbFirestore, window.dbCollections.messages), {
                chatId: cid, senderId: String(currentUser.id), senderName: currentUser.name, receiverId: String(activeChatPartner.id),
                text: txt || (finp.files[0]?"Sent a file":""), file: finp.files[0]?.name||null, timestamp: window.Timestamp.now(), read: false
            });
            inp.value = ''; finp.value = '';
            document.getElementById('file-indicator').classList.add('hidden');
        }

        function showFileSelected(input) {
            if(input.files[0]) {
                const el = document.getElementById('file-indicator');
                el.innerText = `📎 ${input.files[0].name}`;
                el.classList.remove('hidden');
            }
        }

        // OTHER (Scan & Classes same as previous version)
        function renderSidebar() {
            const nav = document.getElementById('nav-menu'); nav.innerHTML = '';
            const r = routes[currentUser.role];
            r.forEach((rt, idx) => {
                const b = document.createElement('button');
                b.className = `sidebar-item w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-500 rounded-xl mb-1`;
                if(idx===0) b.classList.add('active');
                b.innerHTML = `<i class="fa-solid ${rt.icon} w-6"></i> ${rt.label}`;
                b.onclick = () => { document.querySelectorAll('.sidebar-item').forEach(x=>x.classList.remove('active')); b.classList.add('active'); renderPage(rt.id); };
                nav.appendChild(b);
            });
        }

        function renderStudentQR(container) {
             container.innerHTML = `
                <div class="h-full flex flex-col items-center justify-center p-6 fade-in">
                    <div class="bg-white p-8 rounded-3xl shadow-xl border border-slate-100 text-center max-w-sm w-full relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-400 to-yellow-400"></div>
                        <div class="w-24 h-24 bg-slate-50 rounded-full mx-auto mb-4 border-4 border-white shadow-lg flex items-center justify-center text-3xl font-bold text-slate-400">${currentUser.name.charAt(0)}</div>
                        <h2 class="text-2xl font-bold text-slate-800">${currentUser.name}</h2>
                        <p class="text-slate-400 text-sm mb-6">Grade 10 &bull; ID: ${currentUser.id}</p>
                        <div id="student-qrcode" class="flex justify-center mb-6 p-4 border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50/50"></div>
                        <p class="text-xs text-slate-400 font-medium">Show to teacher for attendance</p>
                    </div>
                </div>`;
             setTimeout(() => {
                 new QRCode(document.getElementById("student-qrcode"), {
                    text: JSON.stringify({ type: 'edusaas_student_id', id: currentUser.id, name: currentUser.name }),
                    width: 180, height: 180, colorDark: "#1e293b", colorLight: "#ffffff"
                });
             }, 100);
        }

        function renderTeacherClasses(container) {
            container.innerHTML = `<div class="mb-6"><h2 class="text-2xl font-bold text-slate-800">My Classes</h2></div><div id="classes-list-container" class="space-y-4">Loading...</div>`;
            const ref = window.collection(window.dbFirestore, window.dbCollections.classes);
            const unsub = window.onSnapshot(ref, (snap) => {
                let list = db.classes;
                if(!snap.empty) { const d=snap.docs.reduce((a,x)=>({...a,[x.id]:x.data()}),{}); list = db.classes.map(c=>({...c, currentFile:d[c.id]?.currentFile})); }
                document.getElementById('classes-list-container').innerHTML = list.map(c => `
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 fade-in flex items-center justify-between">
                        <div>
                            <span class="bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Active Session</span>
                            <h3 class="font-bold text-lg text-slate-800 mt-1">${c.name}</h3>
                            <p class="text-sm text-slate-400"><i class="fa-regular fa-clock mr-1"></i> ${c.time} &bull; Room ${c.room}</p>
                        </div>
                        <div class="flex gap-3">
                            <div class="relative group">
                                <label class="w-10 h-10 rounded-full bg-slate-100 hover:bg-yellow-100 text-slate-500 hover:text-yellow-600 flex items-center justify-center cursor-pointer transition">
                                    <i class="fa-solid fa-file-arrow-up"></i>
                                    <input type="file" class="hidden" onchange="uploadFile('${c.id}', this)">
                                </label>
                                ${c.currentFile ? `<div class="absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>` : ''}
                            </div>
                            <button onclick="startScanning('${c.id}')" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-xl font-medium shadow-lg shadow-blue-200 transition transform hover:scale-105 flex items-center gap-2"><i class="fa-solid fa-camera"></i> Scan</button>
                        </div>
                    </div>
                `).join('');
            });
            firestoreUnsubscribes.push(unsub);
        }

        function renderTeacherScanner(container) {
            const cls = db.classes.find(c => c.id === activeClassId);
            container.innerHTML = `
                <div class="max-w-md mx-auto fade-in">
                    <div class="bg-white p-6 rounded-3xl shadow-xl border border-slate-100 relative overflow-hidden">
                        <div class="flex justify-between items-center mb-6">
                            <button onclick="renderPage('teacher-classes')" class="text-slate-400 hover:text-blue-600"><i class="fa-solid fa-arrow-left"></i></button>
                            <h3 class="font-bold text-slate-800">Scan Attendance</h3>
                            <div class="w-6"></div>
                        </div>
                        <div id="reader" class="rounded-2xl overflow-hidden bg-slate-900 min-h-[300px] shadow-inner relative"></div>
                        <div class="mt-6 flex gap-2">
                            <input id="manual-student-id" placeholder="Or enter ID..." class="flex-1 bg-slate-50 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 ring-blue-200 outline-none">
                            <button onclick="manualTeacherScan()" class="bg-blue-600 text-white px-4 rounded-xl hover:bg-blue-700"><i class="fa-solid fa-check"></i></button>
                        </div>
                    </div>
                </div>`;
            setTimeout(() => {
                activeScanner = new Html5Qrcode("reader");
                activeScanner.start({ facingMode: "environment" }, { fps: 20, qrbox: 250 }, (txt) => {
                    handleTeacherScanSuccess(txt); activeScanner.pause(true); document.getElementById('scan-sound').play(); setTimeout(()=>activeScanner.resume(), 2000);
                });
            }, 300);
        }

        async function uploadFile(cid, input) {
            if(input.files[0]) {
                await window.setDoc(window.doc(window.dbFirestore, window.dbCollections.classes, cid), { currentFile: input.files[0].name }, { merge: true });
                showToast("Material Attached");
            }
        }
        function startScanning(cid) { activeClassId=cid; renderPage('teacher-scan'); }
        async function handleTeacherScanSuccess(txt) {
            try {
                let sData = txt.startsWith('{') ? JSON.parse(txt) : {id:txt, name:"Student #"+txt};
                const clsRef = await window.getDoc(window.doc(window.dbFirestore, window.dbCollections.classes, activeClassId)); // One-time fetch for file
                const file = clsRef.data()?.currentFile;
                
                await window.addDoc(window.collection(window.dbFirestore, window.dbCollections.attendance), {
                    studentId: String(sData.id), studentName: sData.name, classId: activeClassId, className: db.classes.find(c=>c.id===activeClassId).name, timestamp: window.Timestamp.now(), status: 'present'
                });
                if(file) await window.addDoc(window.collection(window.dbFirestore, window.dbCollections.materials), {
                    studentId: String(sData.id), fileName: file, classId: activeClassId, className: db.classes.find(c=>c.id===activeClassId).name, timestamp: window.Timestamp.now()
                });
                showToast(`${sData.name} Marked Present`);
            } catch(e) { showToast("Scan Error"); }
        }
        function manualTeacherScan() { handleTeacherScanSuccess(document.getElementById('manual-student-id').value); }
        function renderStudentMaterials(container) { container.innerHTML = `<div class="p-8 text-center text-slate-400">Materials Library</div>`; }
        function showToast(msg) { const t=document.getElementById('toast'); document.getElementById('toast-msg').innerText=msg; t.classList.remove('translate-y-24','opacity-0'); setTimeout(()=>t.classList.add('translate-y-24','opacity-0'),3000); }
    </script>
</body>
</html>