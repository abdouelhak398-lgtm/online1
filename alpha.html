<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EduSaaS - Institutional OS v5.2</title>
    <!-- Core Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        inst: {
                            50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1', 400: '#94a3b8',
                            500: '#64748b', 600: '#475569', 700: '#334155', 800: '#1e293b', 900: '#0f172a', 950: '#020617',
                        },
                        primary: '#4f46e5',
                        success: '#10b981',
                        danger: '#ef4444'
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --bg-body: #f8fafc;
            --bg-surface: #ffffff;
            --text-main: #020617; /* Hard Contrast for Light Mode */
            --text-muted: #475569;
            --border: #e2e8f0;
        }

        .dark {
            --bg-body: #020617;
            --bg-surface: #0f172a;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: #1e293b;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--bg-body); color: var(--text-main);
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* Institutional Hard Contrast */
        .force-vis { color: var(--text-main) !important; font-weight: 900 !important; }
        .logo-text { font-family: 'Plus Jakarta Sans', sans-serif; letter-spacing: -0.02em; }

        .card-edu {
            background-color: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 1.25rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05);
            transition: all 0.2s ease;
        }

        /* LIVE SYNC PULSE ANIMATION */
        @keyframes live-glow {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); border-color: #10b981; }
            70% { box-shadow: 0 0 0 12px rgba(16, 185, 129, 0); border-color: #10b981; }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); border-color: #10b981; }
        }
        .session-is-live {
            border: 2px solid #10b981 !important;
            background: rgba(16, 185, 129, 0.05) !important;
            animation: live-glow 2s infinite;
        }

        .sidebar-item {
            display: flex; align-items: center; gap: 0.75rem; padding: 0.85rem 1.25rem;
            margin: 0.25rem 1rem; border-radius: 0.75rem; font-weight: 700;
            color: var(--text-muted); transition: all 0.2s ease; cursor: pointer;
        }
        .sidebar-item:hover { background-color: rgba(79, 70, 229, 0.08); color: #4f46e5; }
        .sidebar-item.active { background-color: #4f46e5; color: white !important; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }

        .grid-master {
            display: grid; grid-template-columns: 80px repeat(7, 1fr); gap: 1px;
            background-color: var(--border); border: 2px solid var(--border);
            border-radius: 1rem; overflow: hidden;
        }
        .grid-head { background-color: var(--bg-body); color: var(--text-main); font-weight: 900; font-size: 11px; text-transform: uppercase; padding: 1.25rem 0.5rem; text-align: center; }
        .grid-cell { background-color: var(--bg-surface); min-height: 115px; padding: 0.5rem; position: relative; }
        .grid-time { background-color: var(--bg-body); color: var(--text-muted); font-weight: 900; font-size: 10px; display: flex; align-items: center; justify-content: center; }

        input, select, textarea {
            background-color: var(--bg-surface); border: 2px solid var(--border);
            color: var(--text-main); padding: 0.75rem 1rem; border-radius: 0.75rem; font-weight: 700; outline: none;
            width: 100%;
        }
        input:focus { border-color: #4f46e5; }

        .btn-pro {
            background-color: #4f46e5; color: white; padding: 0.85rem 1.75rem;
            border-radius: 0.85rem; font-weight: 800; transition: transform 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
            cursor: pointer; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }
        .btn-pro:active { transform: scale(0.97); }

        .msg-bubble { max-width: 80%; padding: 0.75rem 1.25rem; border-radius: 1.25rem; font-size: 0.95rem; line-height: 1.5; font-weight: 500; }
        .msg-sent { background-color: #4f46e5; color: white; border-bottom-right-radius: 0.25rem; }
        .msg-received { background-color: var(--bg-body); color: var(--text-main); border: 1px solid var(--border); border-bottom-left-radius: 0.25rem; font-weight: 600; }

        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <div id="mobile-overlay" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-[60]" onclick="window.toggleMobileMenu()"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 w-72 bg-surface border-r border-color z-[70] transform -translate-x-full lg:translate-x-0 transition-all duration-300 ease-in-out hidden md:flex flex-col h-full" style="background-color: var(--bg-surface); border-right: 1px solid var(--border);">
        <div class="p-8 flex items-center gap-4">
            <div class="w-10 h-10 bg-primary rounded-xl flex items-center justify-center text-white font-black text-xl shadow-lg">E</div>
            <div>
                <h1 class="text-xl font-black uppercase tracking-tight force-vis logo-text">EduSaaS</h1>
                <p class="text-[9px] font-bold uppercase tracking-widest text-primary">Academic OS</p>
            </div>
        </div>

        <nav id="nav-menu" class="flex-1 py-4 space-y-1"></nav>

        <div class="p-6 space-y-3">
            <button onclick="window.toggleDarkMode()" class="flex items-center gap-3 w-full px-4 py-3 rounded-xl border border-color hover:bg-body transition-all" style="background-color: var(--bg-body); border-color: var(--border);">
                <i id="theme-icon" class="fa-solid fa-moon text-primary"></i>
                <span class="text-sm font-bold uppercase tracking-wide">Appearance</span>
            </button>
            <button onclick="window.logout()" class="flex items-center gap-3 w-full px-4 py-3 rounded-xl bg-danger/10 text-danger hover:bg-danger/20 transition-all font-black">
                <i class="fa-solid fa-power-off"></i>
                <span class="text-sm uppercase tracking-wide">Disconnect</span>
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full relative overflow-hidden lg:ml-72">
        <header class="h-20 bg-surface border-b border-color flex items-center justify-between px-6 lg:px-12 shrink-0 z-40" style="background-color: var(--bg-surface); border-bottom: 1px solid var(--border);">
            <div class="flex items-center gap-4">
                <button onclick="window.toggleMobileMenu()" class="lg:hidden w-10 h-10 flex items-center justify-center rounded-xl border border-color text-muted hover:bg-body transition-colors" style="border: 1px solid var(--border);">
                    <i class="fa-solid fa-bars-staggered"></i>
                </button>
                <div class="flex flex-col">
                    <h2 id="page-title" class="text-lg lg:text-xl font-black uppercase tracking-tight force-vis">Workspace</h2>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="w-2 h-2 rounded-full bg-success animate-pulse"></span>
                        <span class="text-[10px] font-black uppercase tracking-widest text-success">Secure Academic Sync</span>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="flex items-center gap-3 bg-body p-2 px-4 rounded-2xl border border-color shadow-sm" style="background-color: var(--bg-body); border-color: var(--border);">
                    <div class="w-8 h-8 rounded-lg bg-primary flex items-center justify-center text-white font-black text-xs" id="user-initials">?</div>
                    <div class="hidden sm:block">
                        <p id="user-name-header" class="text-xs font-black">Account</p>
                        <p id="user-role-header" class="text-[9px] font-bold text-primary uppercase tracking-widest">Active Hub</p>
                    </div>
                </div>
            </div>
        </header>

        <div id="app-content" class="flex-1 overflow-y-auto p-6 lg:p-12 relative scroll-smooth bg-opacity-30"></div>

        <footer class="bg-surface border-t border-color py-3 px-10 flex justify-between items-center shrink-0 opacity-60" style="background-color: var(--bg-surface); border-top: 1px solid var(--border);">
            <span id="footer-status" class="text-[10px] font-mono text-secondary uppercase tracking-widest">IDLE</span>
            <span class="text-[9px] font-black uppercase tracking-widest text-secondary font-black">Enterprise OS v5.2</span>
        </footer>
    </main>

    <!-- Unified Modals -->
    <div id="modal-container" class="fixed inset-0 z-[150] bg-black/70 backdrop-blur-md hidden flex items-center justify-center p-4">
        
        <!-- Live Session Tool -->
        <div id="class-mgmt-modal-content" class="bg-surface rounded-[2rem] shadow-2xl max-w-md w-full p-10 fade-in hidden border border-color relative" style="background-color: var(--bg-surface); border-color: var(--border);">
            <button type="button" onclick="window.closeConfirmModal()" class="absolute top-8 right-8 text-secondary hover:text-danger transition-all"><i class="fa-solid fa-xmark text-2xl"></i></button>
            <h3 class="text-2xl font-black mb-8 text-center uppercase tracking-tight" style="color: var(--text-primary);">Session Config</h3>
            <form id="class-form" onsubmit="window.handleClassSave(event)" class="space-y-6">
                <input type="hidden" id="edit-class-id">
                <input id="class-name-input" type="text" placeholder="Session Name" maxlength="40" class="font-bold">
                <div class="grid grid-cols-2 gap-4">
                    <input id="class-date-input" type="date">
                    <input id="class-room-input" type="text" placeholder="Lab / Room" class="font-bold">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <select id="class-start-time" class="font-bold">
                        <option value="08:00">08:00 AM</option><option value="09:00">09:00 AM</option><option value="10:00">10:00 AM</option><option value="11:00">11:00 AM</option><option value="12:00">12:00 PM</option><option value="13:00">01:00 PM</option><option value="14:00">02:00 PM</option><option value="15:00">03:00 PM</option><option value="16:00">04:00 PM</option>
                    </select>
                    <select id="class-end-time" class="font-bold">
                        <option value="09:00">09:00 AM</option><option value="10:00">10:00 AM</option><option value="11:00">11:00 AM</option><option value="12:00">12:00 PM</option><option value="13:00">01:00 PM</option><option value="14:00">02:00 PM</option><option value="15:00">03:00 PM</option><option value="16:00">04:00 PM</option><option value="17:00">05:00 PM</option>
                    </select>
                </div>
                <button type="submit" class="w-full btn-pro uppercase tracking-widest shadow-xl font-black">Publish Session</button>
            </form>
        </div>

        <!-- Dropbox Modal -->
        <div id="hw-mgmt-modal-content" class="bg-surface rounded-[2rem] shadow-2xl max-w-lg w-full p-10 fade-in hidden border border-color relative" style="background-color: var(--bg-surface); border-color: var(--border);">
            <button type="button" onclick="window.closeConfirmModal()" class="absolute top-8 right-8 text-secondary hover:text-danger transition-all"><i class="fa-solid fa-xmark text-2xl"></i></button>
            <h3 class="text-2xl font-black mb-8 text-center uppercase tracking-tight" style="color: var(--text-primary);">Issue Task</h3>
            <form id="hw-form" onsubmit="window.handleHWSave(event)" class="space-y-5">
                <input id="hw-title-input" type="text" placeholder="Task Title" class="font-bold">
                <textarea id="hw-desc-input" placeholder="Technical instructions..." class="h-32"></textarea>
                <div class="grid grid-cols-2 gap-4">
                    <input id="hw-date-input" type="date">
                    <input id="hw-time-input" type="time">
                </div>
                <div class="p-4 bg-body rounded-xl border-2 border-dashed border-color flex flex-col items-center gap-2" style="background-color: var(--bg-body); border-color: var(--border);">
                    <input type="file" id="hw-file-input" class="hidden" onchange="window.handleFileSelect(this, 'hw-file-label')">
                    <button type="button" onclick="document.getElementById('hw-file-input').click()" class="text-primary font-bold text-sm uppercase tracking-widest"><i class="fa-solid fa-paperclip mr-2"></i>Attach Resource</button>
                    <span id="hw-file-label" class="text-[10px] font-black text-secondary">Max 1MB allowed</span>
                </div>
                <button type="submit" id="hw-submit-btn" class="w-full btn-pro uppercase tracking-widest shadow-xl font-black">Dispatch Task</button>
            </form>
        </div>

        <!-- Grade Modal -->
        <div id="grade-modal-content" class="bg-surface rounded-[2rem] shadow-2xl max-w-md w-full p-10 fade-in hidden border border-color relative" style="background-color: var(--bg-surface); border-color: var(--border);">
            <button type="button" onclick="window.closeConfirmModal()" class="absolute top-8 right-8 text-secondary hover:text-danger transition-all"><i class="fa-solid fa-xmark text-2xl"></i></button>
            <h3 class="text-2xl font-black mb-2 text-center uppercase tracking-tight" style="color: var(--text-primary);">Grade result</h3>
            <p id="grade-student-name" class="text-center font-bold text-primary mb-8 uppercase text-[10px] tracking-widest"></p>
            <form id="grade-form" onsubmit="window.handleGradeSave(event)" class="space-y-6">
                <input type="hidden" id="grade-sub-id">
                <input id="grade-input" type="number" step="0.5" min="0" max="20" placeholder="Grade / 20" class="font-black text-lg">
                <textarea id="review-input" placeholder="Feedback critique..." class="h-32 font-bold"></textarea>
                <button type="submit" class="w-full btn-pro uppercase tracking-widest shadow-xl font-black">Publish result</button>
            </form>
        </div>

        <!-- Submission Modal -->
        <div id="submission-modal-content" class="bg-surface rounded-[2rem] shadow-2xl max-w-md w-full p-10 fade-in hidden border border-color relative" style="background-color: var(--bg-surface); border-color: var(--border);">
            <button type="button" onclick="window.closeConfirmModal()" class="absolute top-8 right-8 text-secondary hover:text-danger transition-all"><i class="fa-solid fa-xmark text-2xl"></i></button>
            <h3 class="text-2xl font-black mb-4 text-center uppercase tracking-tight" style="color: var(--text-primary);">Submit work</h3>
            <p id="sub-hw-title" class="text-center font-bold text-primary mb-8 uppercase text-xs tracking-widest"></p>
            <form id="sub-form" onsubmit="window.handleSubmissionSave(event)" class="space-y-6">
                <input type="hidden" id="sub-hw-id">
                <div class="p-8 bg-body rounded-2xl border-2 border-dashed border-color flex flex-col items-center gap-4" style="background-color: var(--bg-body); border-color: var(--border);">
                    <input type="file" id="sub-file-input" class="hidden" onchange="window.handleFileSelect(this, 'sub-file-label')">
                    <button type="button" onclick="document.getElementById('sub-file-input').click()" class="text-primary font-black text-sm uppercase tracking-widest"><i class="fa-solid fa-cloud-arrow-up mr-2"></i>Select Result</button>
                    <span id="sub-file-label" class="text-[10px] font-black text-secondary">Institutional Drop (Max 1MB)</span>
                </div>
                <button type="submit" class="w-full btn-pro uppercase tracking-widest shadow-xl font-black">Finalize Upload</button>
            </form>
        </div>
    </div>

    <!-- Login UI -->
    <div id="login-modal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-xl flex items-center justify-center p-4">
        <div class="bg-surface rounded-[3rem] shadow-2xl max-w-lg w-full p-16 text-center border border-color" style="background-color: var(--bg-surface); border-color: var(--border);">
            <div class="w-20 h-20 bg-primary rounded-[1.5rem] flex items-center justify-center text-white font-black text-4xl mx-auto mb-10 shadow-2xl transform rotate-3">E</div>
            <h2 class="text-4xl font-black mb-4 tracking-tight uppercase" style="color: var(--text-main);">Academic Sync</h2>
            <p class="text-secondary mb-12 text-sm font-semibold tracking-wide uppercase font-black">Identity Verification</p>
            <div class="space-y-5">
                <button onclick="window.handleLogin('teacher')" class="w-full p-8 border border-color rounded-[2rem] bg-body hover:bg-primary/10 hover:border-primary transition-all flex items-center gap-6 group" style="background-color: var(--bg-body); border-color: var(--border);">
                    <div class="w-16 h-16 bg-primary text-white rounded-2xl flex items-center justify-center text-2xl shadow-lg group-hover:scale-110 transition-transform"><i class="fa-solid fa-shield-halved"></i></div>
                    <div class="text-left"><span class="font-black block text-lg uppercase" style="color: var(--text-main);">Faculty Terminal</span><span class="text-[10px] text-primary font-black uppercase tracking-widest">Lead Suite</span></div>
                </button>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="window.handleLogin('student1')" class="p-6 bg-body border border-color rounded-3xl text-sm font-black hover:border-primary transition-all shadow-sm uppercase tracking-wide" style="background-color: var(--bg-body); border-color: var(--border); color: var(--text-main);">Y. Brahimi</button>
                    <button onclick="window.handleLogin('student2')" class="p-6 bg-body border border-color rounded-3xl text-sm font-black hover:border-primary transition-all shadow-sm uppercase tracking-wide" style="background-color: var(--bg-body); border-color: var(--border); color: var(--text-main);">M. Hadjadj</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-12 right-12 bg-primary text-white px-8 py-5 rounded-2xl shadow-2xl transform translate-y-32 opacity-0 transition-all duration-500 z-[200] flex items-center gap-5">
        <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center text-white shrink-0 shadow-lg"><i class="fa-solid fa-check text-xs"></i></div>
        <span id="toast-msg" class="font-black text-sm tracking-wide uppercase">Sync Confirmed</span>
    </div>

    <audio id="scan-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, setDoc, getDoc, updateDoc, doc, Timestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. REGISTRATION (FUNCTION BINDING) ---
        window.showToast = (msg) => { 
            const t = document.getElementById('toast'); if(!t) return;
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('translate-y-32', 'opacity-0'); 
            setTimeout(() => t.classList.add('translate-y-32', 'opacity-0'), 4000); 
        };

        window.isLive = (date, start, end) => {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            if (date !== today) return false;
            const nowStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
            return nowStr >= start && nowStr < end;
        };

        window.getStartOfWeek = (date) => {
            const d = new Date(date);
            const day = d.getDay(), diff = d.getDate() - day + (day === 0 ? -6 : 1); 
            return new Date(d.setDate(diff));
        };

        window.toggleDarkMode = () => {
            const isDark = !document.documentElement.classList.contains('dark');
            document.documentElement.classList.toggle('dark', isDark);
            document.getElementById('theme-icon').className = isDark ? "fa-solid fa-sun text-yellow-400" : "fa-solid fa-moon text-primary";
        };

        window.toggleMobileMenu = () => {
            const s = document.getElementById('sidebar'), o = document.getElementById('mobile-overlay');
            if(s && o) { s.classList.toggle('-translate-x-full'); o.classList.toggle('hidden'); }
        };

        window.closeConfirmModal = () => {
            document.querySelectorAll('#modal-container > div').forEach(d => d.classList.add('hidden'));
            document.getElementById('modal-container').classList.add('hidden');
        };

        window.logout = () => location.reload();

        // --- 2. FIREBASE SETUP ---
        const configRaw = typeof __firebase_config !== 'undefined' ? __firebase_config : '{"apiKey":""}';
        const firebaseConfig = JSON.parse(configRaw);
        const app = initializeApp(firebaseConfig), auth = getAuth(app), db = getFirestore(app);
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'edusaas-v3-stable';

        const dbCollections = {
            users: `artifacts/${APP_ID}/public/data/users`,
            classes: `artifacts/${APP_ID}/public/data/classes`,
            attendance: `artifacts/${APP_ID}/public/data/attendance`,
            messages: `artifacts/${APP_ID}/public/data/messages`,
            assignments: `artifacts/${APP_ID}/public/data/assignments`,
            submissions: `artifacts/${APP_ID}/public/data/submissions`
        };

        const staticData = {
            users: {
                teacher: { name: 'Fatima Zohra', role: 'teacher', id: 'teacher_dz' },
                student1: { name: 'Yacine Brahimi', role: 'student', id: 'student_dz_1' },
                student2: { name: 'Meriem Hadjadj', role: 'student', id: 'student_dz_2' }
            },
            timetable: {
                days: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'],
                hours: ['08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00']
            }
        };

        // --- 3. STATE ---
        let currentUser = null, activeChatPartner = null, activeScanner = null, isProcessingScan = false;
        let allUsers = [], allClassList = [], globalUnsubscribes = [], pageUnsubscribes = [];
        let activeClassId = null, currentTimetableDate = new Date(); 
        let tempFileData = null, tempFileName = null;

        // --- 4. ENGINE FUNCTIONS ---

        window.setupGlobalNotifications = () => {
            globalUnsubscribes.forEach(u => u()); globalUnsubscribes = [];
            const u1 = onSnapshot(collection(db, dbCollections.users), (snap) => { 
                allUsers = snap.docs.map(d=>({id:d.id, ...d.data()})); 
                if(document.getElementById('page-title')?.dataset?.id === 'inbox-view') window.renderPage('inbox-view');
            });
            const u2 = onSnapshot(collection(db, dbCollections.classes), (snap) => { 
                allClassList = snap.docs.map(d=>({id:d.id, ...d.data()})); 
                const pid = document.getElementById('page-title')?.dataset?.id;
                if(pid && pid.includes('schedule')) window.renderPage(pid);
            });
            globalUnsubscribes.push(u1, u2);
        };

        window.renderSidebar = () => {
            const nav = document.getElementById('nav-menu'); if (!nav || !currentUser) return;
            nav.innerHTML = '';
            const routes = currentUser.role === 'teacher' ? [
                { id: 'teacher-classes', label: 'My Hub', icon: 'fa-layer-group' },
                { id: 'teacher-schedule', label: 'Schedule', icon: 'fa-calendar-day' },
                { id: 'teacher-assignments', label: 'Dropbox', icon: 'fa-folder-tree' },
                { id: 'inbox-view', label: 'Secure Inbox', icon: 'fa-comment-alt' }
            ] : [
                { id: 'student-qr', label: 'Identity Vault', icon: 'fa-id-card' },
                { id: 'student-schedule', label: 'Schedule', icon: 'fa-calendar-day' },
                { id: 'student-assignments', label: 'Dropbox', icon: 'fa-folder-open' },
                { id: 'inbox-view', label: 'Faculty Line', icon: 'fa-comment-alt' }
            ];
            routes.forEach((rt) => {
                const b = document.createElement('button');
                const pid = document.getElementById('page-title')?.dataset?.id;
                b.className = `sidebar-item w-full ${pid === rt.id ? 'active' : ''}`;
                b.innerHTML = `<div class="w-6 text-center"><i class="fa-solid ${rt.icon} text-xs"></i></div> <span class="uppercase tracking-wide text-[10px] font-black">${rt.label}</span>`;
                b.onclick = () => window.renderPage(rt.id);
                nav.appendChild(b);
            });
        };

        window.renderPage = async (pageId) => {
            if (activeScanner) { try { await activeScanner.stop(); } catch(e) {} activeScanner = null; }
            pageUnsubscribes.forEach(u => u()); pageUnsubscribes = [];
            const container = document.getElementById('app-content'); if(!container) return;
            container.innerHTML = `<div class="h-full flex items-center justify-center"><div class="w-12 h-12 border-4 border-primary/20 border-t-primary rounded-full animate-spin"></div></div>`;
            const titleEl = document.getElementById('page-title'); if (titleEl) titleEl.dataset.id = pageId;

            window.renderSidebar(); 

            setTimeout(async () => {
                container.innerHTML = '';
                if(pageId.includes('schedule')) {
                    const weekStart = window.getStartOfWeek(new Date(currentTimetableDate));
                    const weekDates = [];
                    for(let i=0; i<7; i++) {
                        const wd = new Date(weekStart); wd.setDate(wd.getDate() + i);
                        weekDates.push({ name: staticData.timetable.days[i], iso: wd.toISOString().split('T')[0], label: wd.toLocaleDateString([], {day:'numeric', month:'short'}) });
                    }
                    container.innerHTML = `
                        <div class="mb-10 flex flex-col md:flex-row justify-between items-start md:items-end fade-in gap-4">
                            <div><h2 class="text-4xl font-black force-vis tracking-tighter uppercase">Academic Schedule</h2><p class="text-xs font-bold text-secondary uppercase tracking-widest mt-2">Institutional Alignment</p></div>
                            <div class="flex gap-3 bg-surface p-2 rounded-2xl border border-color shadow-sm items-center" style="background-color: var(--bg-surface); border-color: var(--border);">
                                <div class="flex items-center gap-2 px-2"><i class="fa-solid fa-calendar-day text-primary"></i><input type="date" id="calendar-jump-picker" onchange="window.goToDate(this.value)" value="${currentTimetableDate.toISOString().split('T')[0]}"></div>
                                <div class="flex gap-1 border-l border-color pl-2" style="border-color: var(--border);">
                                    <button onclick="window.navigateWeek(-1)" class="w-10 h-10 flex items-center justify-center hover:bg-body rounded-xl transition-all" style="background-color: var(--bg-body); color: var(--text-primary); border: 1px solid var(--border);"><i class="fa-solid fa-chevron-left"></i></button>
                                    <button onclick="window.navigateWeek(1)" class="w-10 h-10 flex items-center justify-center hover:bg-body rounded-xl transition-all" style="background-color: var(--bg-body); color: var(--text-primary); border: 1px solid var(--border);"><i class="fa-solid fa-chevron-right"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="grid-master fade-in">
                            ${staticData.timetable.hours.map(h => `<div class="grid-time">${h}</div>` + weekDates.map(wd => {
                                const classes = (allClassList || []).filter(c => c.date === wd.iso && c.startTime === h);
                                return `<div class="grid-cell">${classes.map(c => {
                                    const live = window.isLive(c.date, c.startTime, c.endTime);
                                    return `<div class="card-edu p-3 border-l-4 border-l-primary h-full ${live?'session-is-live':''}">
                                        <p class="text-[10px] font-black uppercase text-primary mb-1">${c.name}</p>
                                        ${live?'<div class="flex items-center gap-1 mb-2"><span class="w-1.5 h-1.5 rounded-full bg-success"></span><span class="text-[7px] font-black text-success uppercase">LIVE NOW</span></div>':''}
                                        <p class="text-[9px] font-bold text-secondary uppercase"><i class="fa-solid fa-clock mr-1"></i>${c.startTime}-${c.endTime}</p>
                                        <p class="text-[9px] font-bold text-secondary uppercase"><i class="fa-solid fa-location-dot mr-1"></i>${c.room || 'TBA'}</p>
                                    </div>`;
                                }).join('')}</div>`;
                            }).join('')).join('')}
                        </div>`;
                }
                else if(pageId === 'teacher-classes') {
                    container.innerHTML = `<div class="mb-12 flex justify-between items-center fade-in"><div><h2 class="text-4xl font-black force-vis tracking-tighter uppercase">My Hub</h2><p class="text-xs font-bold text-secondary uppercase tracking-widest mt-2">Active Session Control</p></div><button onclick="window.requestAddClass()" class="btn-pro shadow-xl font-black text-xs uppercase tracking-widest">+ New Session</button></div><div id="cls-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>`;
                    const list = document.getElementById('cls-list');
                    list.innerHTML = (allClassList || []).map(cl => `<div class="p-8 card-edu relative group ${window.isLive(cl.date, cl.startTime, cl.endTime)?'session-is-live':''}">
                        <div class="absolute top-6 right-6 flex gap-2"><button onclick="window.requestEditClass('${cl.id}')" class="w-8 h-8 flex items-center justify-center text-muted hover:text-primary transition-all"><i class="fa-solid fa-sliders text-xs"></i></button><button onclick="window.requestDeleteClass('${cl.id}')" class="w-8 h-8 flex items-center justify-center text-muted hover:text-danger transition-all"><i class="fa-solid fa-trash text-xs"></i></button></div>
                        <div class="mb-10"><h3 class="font-black text-xl uppercase tracking-tight" style="color: var(--text-primary);">${cl.name}</h3><div class="flex items-center gap-3 mt-4"><div class="bg-primary text-white px-3 py-1 rounded-lg text-[9px] font-black uppercase tracking-widest font-black">${cl.room || 'No Room'}</div><p class="text-[10px] font-bold text-secondary uppercase">${cl.startTime} - ${cl.endTime}</p></div></div>
                        <button onclick="window.startScanning('${cl.id}')" class="w-full bg-primary text-white p-4 rounded-xl font-black text-xs uppercase tracking-widest shadow-lg">Collect Attendance</button></div>`).join('');
                }
                else if(pageId === 'inbox-view') {
                    const isT = currentUser.role === 'teacher';
                    const listUsers = (allUsers || []).filter(u => isT ? u.role === 'student' : u.role === 'teacher');
                    if(!activeChatPartner && listUsers.length) activeChatPartner = listUsers[0];
                    container.innerHTML = `<div class="flex h-[calc(100vh-280px)] card-edu overflow-hidden fade-in shadow-2xl">
                        <div id="chat-list" class="${(window.innerWidth < 1024 && activeChatPartner)?'hidden':'flex'} w-full lg:w-96 border-r border-color flex flex-col bg-body/50" style="border-color: var(--border); background-color: var(--bg-body);">
                            <div class="p-8 border-b border-color font-black uppercase text-[11px] tracking-[0.2em]" style="border-color: var(--border); color: var(--text-primary);">Contacts</div>
                            <div id="inbox-contacts-render" class="overflow-y-auto flex-1 p-4 space-y-2">
                                ${listUsers.map(c => `<div onclick="window.switchChat('${c.id}', '${c.name}')" class="p-5 rounded-2xl cursor-pointer transition-all ${activeChatPartner?.id === c.id ? 'bg-primary text-white shadow-lg' : 'bg-surface hover:bg-primary/10 text-primary font-bold'}" style="${activeChatPartner?.id === c.id ? '' : 'background-color: var(--bg-surface);'}"><p class="text-sm font-black">${c.name}</p></div>`).join('')}
                            </div>
                        </div>
                        <div class="flex-1 ${(window.innerWidth < 1024 && !activeChatPartner)?'hidden':'flex'} flex-col bg-surface" style="background-color: var(--bg-surface);">
                            ${activeChatPartner ? `
                                <div class="p-8 border-b border-color flex items-center justify-between bg-surface z-10 sticky top-0 font-black uppercase tracking-widest" style="border-color: var(--border); background-color: var(--bg-surface); color: var(--text-primary);">
                                    <button onclick="window.switchChat(null)" class="lg:hidden mr-4 text-primary"><i class="fa-solid fa-arrow-left"></i></button>
                                    <h4 class="flex-1">${activeChatPartner.name}</h4>
                                </div>
                                <div id="msg-stream" class="flex-1 p-8 overflow-y-auto space-y-6"></div>
                                <div class="p-6 border-t border-color bg-surface flex gap-4" style="border-color: var(--border); background-color: var(--bg-surface);">
                                    <input type="text" id="chat-input" placeholder="Type secure message..." maxlength="1000" class="flex-1">
                                    <button onclick="window.handleSendMessage(event)" class="bg-primary text-white w-14 h-14 rounded-2xl shadow-xl hover:scale-105 transition-transform"><i class="fa-solid fa-paper-plane text-xl"></i></button>
                                </div>
                            ` : `<div class="flex-1 flex flex-col items-center justify-center opacity-40 text-secondary uppercase font-black"><p class="text-xs">Select Terminal to start sync</p></div>`}
                        </div>
                    </div>`;
                    if(activeChatPartner) {
                        const cid = [currentUser.id, activeChatPartner.id].sort().join('_');
                        const unsub = onSnapshot(collection(db, dbCollections.messages), (snap) => {
                            let msgs = snap.docs.map(d=>d.data()).filter(m => m.chatId === cid).sort((a,b)=>(a.timestamp?.seconds||0)-(b.timestamp?.seconds||0));
                            const div = document.getElementById('msg-stream'); if(!div) return;
                            div.innerHTML = msgs.map(m => `<div class="flex w-full ${m.senderId === currentUser.id?'justify-end':'justify-start'} mb-2 group animate-fade-in"><div class="msg-bubble ${m.senderId === currentUser.id?'msg-sent shadow-md':'msg-received'}"><p class="font-bold tracking-tight text-inherit">${m.text}</p><div class="text-[8px] opacity-70 text-right mt-2 font-black tracking-widest flex items-center justify-end uppercase">${new Date(m.timestamp?.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div></div></div>`).join('');
                            div.scrollTop = div.scrollHeight;
                        });
                        pageUnsubscribes.push(unsub);
                    }
                }
                else if(pageId === 'student-qr') {
                    container.innerHTML = `<div class="h-full flex flex-col items-center justify-center p-4 fade-in"><div class="card-edu p-16 text-center max-w-md w-full relative overflow-hidden"><div class="absolute top-0 left-0 w-full h-2 bg-indigo-600"></div><h2 class="font-black text-2xl mb-12 uppercase tracking-tight" style="color: var(--text-primary);">${currentUser.name}</h2><div id="sqr" class="bg-white p-6 rounded-[2.5rem] mb-12 shadow-inner inline-block border border-slate-100"></div><p class="text-[10px] text-primary font-black uppercase tracking-widest font-black">Identity Vault Key</p></div></div>`;
                    setTimeout(() => { new QRCode(document.getElementById("sqr"), { text: JSON.stringify({ id: currentUser.id, name: currentUser.name }), width: 200, height: 200, colorDark: "#020617" }); }, 100);
                }
            }, 350);
        };

        // --- 5. ATTACH HANDLERS ---
        window.handleLogin = async (roleKey) => {
            currentUser = { ...staticData.users[roleKey] };
            try { 
                const authWorkflow = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { return await signInWithCustomToken(auth, __initial_auth_token); } 
                    else { return await signInAnonymously(auth); }
                };
                await authWorkflow();
                await setDoc(doc(db, dbCollections.users, currentUser.id), { name: currentUser.name, role: currentUser.role, lastSeen: Timestamp.now() }, { merge: true });
                document.getElementById('login-modal').classList.add('hidden');
                document.getElementById('user-initials').innerText = currentUser.name.charAt(0);
                document.getElementById('user-name-header').innerText = currentUser.name;
                document.getElementById('user-role-header').innerText = currentUser.role.toUpperCase();
                document.getElementById('footer-status').innerText = "CONNECTED: " + currentUser.id.toUpperCase();
                window.setupGlobalNotifications(); 
                window.renderPage(currentUser.role === 'teacher' ? 'teacher-classes' : 'student-qr');
            } catch (e) { window.showToast("Institutional Verification Fail"); }
        };

        window.handleSendMessage = async (e) => {
            e.preventDefault(); const inp = document.getElementById('chat-input'), txt = inp.value.trim(); if(!txt || !activeChatPartner) return;
            const cid = [currentUser.id, activeChatPartner.id].sort().join('_');
            try { await addDoc(collection(db, dbCollections.messages), { chatId: cid, senderId: currentUser.id, text: txt, timestamp: Timestamp.now(), read: false }); inp.value = ''; } catch (e) { window.showToast("Handshake Delay"); }
        };

        window.switchChat = (id, name) => { activeChatPartner = id ? { id, name } : null; window.renderPage('inbox-view'); };

        window.handleClassSave = async (e) => {
            e.preventDefault(); const id = document.getElementById('edit-class-id').value, name = document.getElementById('class-name-input').value, date = document.getElementById('class-date-input').value, start = document.getElementById('class-start-time').value, end = document.getElementById('class-end-time').value, room = document.getElementById('class-room-input').value;
            if(!name || !date) return window.showToast("Required Data Missing");
            try { const data = { name, date, startTime: start, endTime: end, room, timestamp: Timestamp.now() }; if(id) await updateDoc(doc(db, dbCollections.classes, id), data); else await addDoc(collection(db, dbCollections.classes), data); window.closeConfirmModal(); window.showToast("Schedule Synchronized"); } catch(err) { window.showToast("Sync Failure"); }
        };

        window.handleHWSave = async (e) => {
            e.preventDefault(); const title = document.getElementById('hw-title-input').value, date = document.getElementById('hw-date-input').value, time = document.getElementById('hw-time-input').value;
            if(!title || !date || !time) return window.showToast("Deadline data required");
            try { await addDoc(collection(db, dbCollections.assignments), { title, description: document.getElementById('hw-desc-input').value, deadlineDate: date, deadlineTime: time, fileData: tempFileData, fileName: tempFileName, creatorId: currentUser.id, timestamp: Timestamp.now() }); window.closeConfirmModal(); window.showToast("Task Issued"); } catch (err) { window.showToast("Sync Error"); }
        };

        window.handleGradeSave = async (e) => {
            e.preventDefault(); const subId = document.getElementById('grade-sub-id').value, grade = document.getElementById('grade-input').value, review = document.getElementById('review-input').value;
            try { await updateDoc(doc(db, dbCollections.submissions, subId), { grade, review }); window.closeConfirmModal(); window.showToast("Evaluation score saved"); } catch (err) { window.showToast("Sync Failed"); }
        };

        window.handleSubmissionSave = async (e) => {
            e.preventDefault(); const hwId = document.getElementById('sub-hw-id').value; if(!tempFileData) return window.showToast("Choose work file first");
            try { await setDoc(doc(db, dbCollections.submissions, `${hwId}_${currentUser.id}`), { assignmentId: hwId, studentId: currentUser.id, studentName: currentUser.name, fileData: tempFileData, fileName: tempFileName, timestamp: Timestamp.now() }); tempFileData = null; tempFileName = null; window.closeConfirmModal(); window.showToast("Work Synced"); } catch (err) { window.showToast("Upload Error"); }
        };

        window.handleTeacherScanSuccess = async (txt) => {
            if(isProcessingScan || !activeClassId) return; isProcessingScan = true;
            try {
                let sData = txt.trim().startsWith('{') ? JSON.parse(txt) : { id: txt, name: "Student ID " + txt.substring(0,4) };
                await addDoc(collection(db, dbCollections.attendance), { studentId: String(sData.id), studentName: sData.name, classId: activeClassId, timestamp: Timestamp.now() });
                window.showToast(`Verified: ${sData.name}`);
                document.getElementById('scan-sound').play().catch(()=>{});
            } catch (e) { window.showToast("Institutional Validation Error"); }
            setTimeout(() => { isProcessingScan = false; }, 2000);
        };

        window.goToDate = (val) => { if(!val) return; currentTimetableDate = new Date(val); window.renderPage(document.getElementById('page-title')?.dataset?.id || 'teacher-schedule'); };
        window.navigateWeek = (offset) => { currentTimetableDate.setDate(currentTimetableDate.getDate() + (offset * 7)); window.renderPage(document.getElementById('page-title')?.dataset?.id || 'teacher-schedule'); };
        window.startScanning = (cid) => { activeClassId = cid; window.renderPage('teacher-scan'); };
        window.requestAddClass = () => { document.getElementById('modal-container').classList.remove('hidden'); document.getElementById('class-mgmt-modal-content').classList.remove('hidden'); document.getElementById('edit-class-id').value = ""; document.getElementById('class-form').reset(); };
        window.requestAddHW = () => { document.getElementById('modal-container').classList.remove('hidden'); document.getElementById('hw-mgmt-modal-content').classList.remove('hidden'); document.getElementById('hw-form').reset(); document.getElementById('hw-file-label').innerText = "Institutional Dropbox"; };
        window.requestSubmitWork = (id, title) => { document.getElementById('modal-container').classList.remove('hidden'); document.getElementById('submission-modal-content').classList.remove('hidden'); document.getElementById('sub-hw-id').value = id; document.getElementById('sub-hw-title').innerText = title; };
        window.handleFileSelect = (input, labelId) => { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (e) => { tempFileData = e.target.result; tempFileName = file.name; document.getElementById(labelId).innerText = file.name; }; reader.readAsDataURL(file); };
        window.downloadFile = (n, d) => { const a = document.createElement('a'); a.href = d; a.download = n; a.click(); };
        window.viewSubmissions = (hwId) => { onSnapshot(collection(db, dbCollections.submissions), (snap) => { const subs = snap.docs.map(d=>d.data()).filter(s => s.assignmentId === hwId); document.getElementById('modal-body-content').innerHTML = `<div class="p-6 text-main"><h4 class="font-black uppercase mb-6 tracking-widest text-center" style="color: var(--text-primary);">Audit Ledger</h4><div class="space-y-3">${subs.length ? subs.map(s => `<div class="p-4 bg-body rounded-xl flex justify-between items-center border border-color" style="background-color: var(--bg-body); border-color: var(--border);"><div><p class="font-black text-xs uppercase" style="color: var(--text-primary);">${s.studentName}</p><p class="text-[9px] font-bold text-secondary uppercase mt-1">${s.grade ? 'Graded ('+s.grade+'/20)' : 'Awaiting Audit'}</p></div><div class="flex gap-2"><button onclick="window.downloadFile('${s.fileName}','${s.fileData}')" class="w-10 h-10 bg-surface border border-color text-primary rounded-lg flex items-center justify-center shadow-sm" style="background-color: var(--bg-surface); border-color: var(--border);"><i class="fa-solid fa-download text-xs"></i></button><button onclick="window.openGradeModal('${s.assignmentId}','${s.studentId}','${s.studentName}')" class="p-2 px-4 bg-primary text-white rounded-lg text-[9px] font-black uppercase shadow-md">${s.grade?'Update':'Grade'}</button></div></div>`).join('') : '<p class="text-center py-8 text-xs font-bold text-secondary uppercase font-black">No submissions logged</p>'}</div></div>`; document.getElementById('generic-modal-content').classList.remove('hidden'); document.getElementById('modal-container').classList.remove('hidden'); }); };
        window.openGradeModal = (hwId, studentId, studentName) => { document.querySelectorAll('#modal-container > div').forEach(d => d.classList.add('hidden')); document.getElementById('grade-modal-content').classList.remove('hidden'); document.getElementById('grade-sub-id').value = `${hwId}_${studentId}`; document.getElementById('grade-student-name').innerText = `Evaluating: ${studentName}`; };
        window.viewFeedback = (grade, review) => { document.getElementById('modal-body-content').innerHTML = `<div class="p-8 text-center text-primary"><h3 class="text-xl font-black uppercase tracking-widest mb-6">Review Evaluation</h3><div class="w-24 h-24 bg-primary text-white rounded-full flex flex-col items-center justify-center mx-auto mb-8 shadow-xl"><span class="text-[10px] font-black opacity-60 uppercase">Grade</span><span class="text-2xl font-black">${grade}/20</span></div><div class="p-6 bg-body rounded-2xl border border-color text-left" style="background-color: var(--bg-body); border-color: var(--border);"><p class="text-[10px] font-black text-secondary uppercase mb-2 tracking-widest">Instructor critique</p><p class="text-sm font-bold leading-relaxed" style="color: var(--text-primary);">${review}</p></div></div>`; document.getElementById('generic-modal-content').classList.remove('hidden'); document.getElementById('modal-container').classList.remove('hidden'); };

        // --- 6. HANDSHAKE (INIT) ---
        (async () => {
            try { 
                onAuthStateChanged(auth, (user) => { if (user) { window.setupGlobalNotifications(); } });
                const performAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { return await signInWithCustomToken(auth, __initial_auth_token); } 
                    else { return await signInAnonymously(auth); }
                };
                await performAuth();
            } catch (e) { console.error("Identity Handshake Fail"); }
        })();
    </script>
</body>
</html>
