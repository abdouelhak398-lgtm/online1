<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Edu-Alg - Professional Academic OS</title>
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        institutional: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                            950: '#020617',
                        },
                        primary: '#4f46e5',
                        success: '#10b981',
                        danger: '#ef4444'
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --bg-body: #f1f5f9;
            --bg-surface: #ffffff;
            --text-primary: #020617;
            --text-secondary: #334155;
            --border-color: #cbd5e1;
        }

        .dark {
            --bg-body: #020617;
            --bg-surface: #0f172a;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border-color: #1e293b;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
        }

        #page-title, .logo-text { color: #020617 !important; font-weight: 900 !important; }
        .dark #page-title, .dark .logo-text { color: #ffffff !important; }

        .card-edu {
            background-color: var(--bg-surface);
            border: 1px solid var(--border-color);
            border-radius: 1.25rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05);
            transition: border-color 0.2s;
        }
        .card-edu:hover { border-color: #4f46e5; }

        .sidebar-nav-item {
            display: flex; align-items: center; gap: 0.75rem; padding: 0.85rem 1.25rem;
            margin: 0.25rem 1rem; border-radius: 0.75rem; font-weight: 700;
            color: var(--text-secondary); transition: all 0.2s ease; cursor: pointer;
        }
        .sidebar-nav-item:hover { background-color: rgba(79, 70, 229, 0.1); color: #4f46e5; }
        .sidebar-nav-item.active { background-color: #4f46e5; color: white !important; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }

        .grid-container {
            display: grid; 
            grid-template-columns: 100px 1fr;
            gap: 1px;
            background-color: var(--border-color); border: 2px solid var(--border-color);
            border-radius: 1rem; overflow: hidden;
        }
        .grid-header { 
            background-color: #f8fafc; 
            color: #020617; 
            font-weight: 900; 
            font-size: 11px; 
            text-transform: uppercase; 
            padding: 1.5rem 1rem; 
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .dark .grid-header { background-color: #1e293b; color: #f8fafc; }
        
        .grid-slot { background-color: var(--bg-surface); min-height: 120px; padding: 0.75rem; position: relative; }
        .grid-time-col { background-color: #e2e8f0; color: #020617; font-weight: 900; font-size: 11px; display: flex; align-items: center; justify-content: center; }
        .dark .grid-time-col { background-color: #020617; color: #94a3b8; }

        .class-tag { 
            background: #eef2ff; border-left: 5px solid #cbd5e1;
            padding: 0.75rem; border-radius: 0.75rem; font-size: 11px; font-weight: 800;
            color: #1e1b4b; height: 100%; display: flex; flex-direction: column;
            justify-content: center; transition: all 0.4s ease;
        }
        .dark .class-tag { color: #eef2ff; background: rgba(255, 255, 255, 0.03); }

        @keyframes live-pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); border-color: #10b981; }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); border-color: #10b981; }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); border-color: #10b981; }
        }
        .live-now-glow {
            border: 2px solid #10b981 !important;
            border-left: 5px solid #10b981 !important;
            background: rgba(16, 185, 129, 0.05) !important;
            animation: live-pulse 2s infinite;
        }
        .live-label {
            background-color: #10b981;
            color: white;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 9px;
            text-transform: uppercase;
            font-weight: 900;
            align-self: flex-start;
            margin-bottom: 6px;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }

        input, select, textarea {
            background-color: var(--bg-surface);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.75rem 1rem; border-radius: 0.75rem; font-weight: 700; outline: none;
            width: 100%; transition: border-color 0.2s;
        }
        input:focus { border-color: #4f46e5; }

        .btn-pro {
            background-color: #4f46e5; color: white; padding: 0.75rem 1.5rem;
            border-radius: 0.75rem; font-weight: 800; transition: transform 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
            cursor: pointer;
        }
        .btn-pro:active { transform: scale(0.97); }

        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <div id="mobile-overlay" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-[60]" onclick="window.toggleMobileMenu()"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 w-72 bg-surface border-r border-color z-[70] transform -translate-x-full lg:translate-x-0 transition-all duration-300 ease-in-out hidden md:flex flex-col h-full" style="background-color: var(--bg-surface); border-right: 1px solid var(--border-color);">
        <div class="p-8 flex items-center gap-4">
            <div class="w-10 h-10 bg-primary rounded-xl flex items-center justify-center text-white font-black text-xl shadow-lg">E</div>
            <div>
                <h1 class="text-xl font-black uppercase tracking-tight logo-text">Edu-Alg</h1>
                <p class="text-[9px] font-bold uppercase tracking-widest text-primary">Academic OS</p>
            </div>
        </div>

        <nav id="nav-menu" class="flex-1 py-4 space-y-1"></nav>

        <div class="p-6 space-y-3">
            <button onclick="window.toggleDarkMode()" class="flex items-center gap-3 w-full px-4 py-3 rounded-xl border border-color hover:bg-body transition-all" style="background-color: var(--bg-body); border-color: var(--border-color);">
                <i id="theme-icon" class="fa-solid fa-moon text-primary"></i>
                <span class="text-sm font-bold uppercase tracking-wide">Appearance</span>
            </button>
            <button onclick="window.logout()" class="flex items-center gap-3 w-full px-4 py-3 rounded-xl bg-danger/10 text-danger hover:bg-danger/20 transition-all">
                <i class="fa-solid fa-power-off"></i>
                <span class="text-sm font-bold uppercase tracking-wide">Disconnect</span>
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full relative overflow-hidden lg:ml-72">
        <header class="h-20 bg-surface border-b border-color flex items-center justify-between px-6 lg:px-12 shrink-0 z-40" style="background-color: var(--bg-surface); border-bottom: 1px solid var(--border-color);">
            <div class="flex items-center gap-4">
                <button onclick="window.toggleMobileMenu()" class="lg:hidden w-10 h-10 flex items-center justify-center rounded-xl border border-color text-secondary hover:bg-body transition-colors">
                    <i class="fa-solid fa-bars-staggered"></i>
                </button>
                <div class="flex flex-col">
                    <h2 id="page-title" class="text-lg lg:text-xl font-black uppercase tracking-tight">Workspace</h2>
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-success animate-pulse"></span>
                        <span class="text-[9px] font-black uppercase tracking-widest text-success">Secure Sync Active</span>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="flex items-center gap-3 bg-body p-2 px-4 rounded-2xl border border-color shadow-sm" style="background-color: var(--bg-body); border-color: var(--border-color);">
                    <div class="w-8 h-8 rounded-lg bg-primary flex items-center justify-center text-white font-black text-xs" id="user-initials">?</div>
                    <div class="hidden sm:block">
                        <p id="user-name-header" class="text-xs font-black">Account</p>
                        <p id="user-role-header" class="text-[9px] font-bold text-primary uppercase tracking-widest">Linked</p>
                    </div>
                </div>
            </div>
        </header>

        <div id="app-content" class="flex-1 overflow-y-auto p-6 lg:p-12 relative scroll-smooth bg-opacity-30"></div>

        <footer class="bg-surface border-t border-color py-3 px-10 flex justify-between items-center shrink-0" style="background-color: var(--bg-surface); border-top: 1px solid var(--border-color);">
            <span id="footer-user-id" class="text-[10px] font-mono text-secondary uppercase tracking-widest opacity-60">IDLE</span>
            <span class="text-[9px] font-black uppercase tracking-widest text-secondary opacity-50">Algerian Educational Cloud</span>
        </footer>
    </main>

    <!-- Global Modals -->
    <div id="modal-container" class="fixed inset-0 z-[150] bg-black/70 backdrop-blur-md hidden flex items-center justify-center p-4">
        
        <!-- Delete Confirmation Modal -->
        <div id="delete-confirm-modal" class="bg-surface rounded-[2rem] shadow-2xl max-sm w-full p-10 fade-in hidden border border-color relative text-center" style="background-color: var(--bg-surface); border-color: var(--border-color);">
            <div class="w-20 h-20 bg-danger/10 text-danger rounded-full flex items-center justify-center text-3xl mx-auto mb-6">
                <i class="fa-solid fa-trash-can"></i>
            </div>
            <h3 id="delete-modal-title" class="text-xl font-black mb-3 uppercase tracking-tight">Terminate Entry?</h3>
            <p class="text-sm font-bold text-secondary mb-8">This action will permanently remove this record from the institutional ledger.</p>
            <input type="hidden" id="delete-target-id">
            <input type="hidden" id="delete-target-type">
            <div class="flex gap-3">
                <button onclick="window.closeConfirmModal()" class="flex-1 p-4 bg-body text-secondary font-black rounded-xl uppercase text-[10px]" style="background-color: var(--bg-body);">Cancel</button>
                <button id="delete-confirm-btn" onclick="window.confirmDeletion()" class="flex-1 p-4 bg-danger text-white font-black rounded-xl uppercase text-[10px] shadow-lg shadow-danger/20">Delete</button>
            </div>
        </div>

        <!-- Session Creation Modal -->
        <div id="class-mgmt-modal-content" class="bg-surface rounded-[2rem] shadow-2xl max-md w-full p-10 fade-in hidden border border-color relative" style="background-color: var(--bg-surface); border-color: var(--border-color);">
            <button type="button" onclick="window.closeConfirmModal()" class="absolute top-8 right-8 text-secondary hover:text-danger transition-all"><i class="fa-solid fa-xmark text-2xl"></i></button>
            <h3 class="text-2xl font-black mb-8 text-center uppercase tracking-tight">Session Config</h3>
            <form id="class-form" onsubmit="window.handleClassSave(event)" class="space-y-6">
                <input type="hidden" id="edit-class-id">
                <div class="space-y-1">
                    <label class="text-[10px] font-black uppercase text-secondary">Session Name</label>
                    <input id="class-name-input" type="text" placeholder="Mathematics, Physics..." maxlength="40" class="font-bold">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-black uppercase text-secondary">Date</label>
                        <input id="class-date-input" type="date">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-black uppercase text-secondary">Room / Location</label>
                        <input id="class-room-input" type="text" placeholder="Room 101, Lab B..." class="font-bold">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-black uppercase text-secondary">Start Time</label>
                        <select id="class-time-input" class="font-bold">
                            <option value="08:00">08:00 AM</option><option value="09:00">09:00 AM</option><option value="10:00">10:00 AM</option><option value="11:00">11:00 AM</option><option value="12:00">12:00 PM</option><option value="13:00">01:00 PM</option><option value="14:00">02:00 PM</option><option value="15:00">03:00 PM</option><option value="16:00">04:00 PM</option><option value="17:00">05:00 PM</option>
                        </select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-black uppercase text-secondary">End Time</label>
                        <select id="class-end-time-input" class="font-bold">
                            <option value="09:00">09:00 AM</option><option value="10:00">10:00 AM</option><option value="11:00">11:00 AM</option><option value="12:00">12:00 PM</option><option value="13:00">01:00 PM</option><option value="14:00">02:00 PM</option><option value="15:00">03:00 PM</option><option value="16:00">04:00 PM</option><option value="17:00">05:00 PM</option><option value="18:00">06:00 PM</option>
                        </select>
                    </div>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-black uppercase text-secondary">Type</label>
                    <select id="class-type-input" class="font-bold"><option value="Cours">Cours</option><option value="TD">TD</option><option value="Exam">Exam</option></select>
                </div>
                <div class="p-4 bg-body rounded-xl border-2 border-dashed border-color flex flex-col items-center gap-2" style="background-color: var(--bg-body); border-color: var(--border-color);">
                    <input type="file" id="session-files-input" class="hidden" multiple onchange="window.handleSessionFilesSelect(this)">
                    <button type="button" onclick="document.getElementById('session-files-input').click()" class="text-primary font-bold text-sm uppercase tracking-widest"><i class="fa-solid fa-paperclip mr-2"></i>Attach Session Resources</button>
                    <span id="session-files-label" class="text-[10px] font-black text-secondary">Optional: Materials for present students</span>
                </div>
                <button type="submit" class="w-full btn-pro uppercase tracking-widest shadow-xl">Confirm Sync</button>
            </form>
        </div>

        <!-- Attendance List Modal -->
        <div id="attendance-modal-content" class="bg-surface rounded-[2.5rem] shadow-2xl max-w-lg w-full p-10 fade-in hidden border border-color relative" style="background-color: var(--bg-surface); border-color: var(--border-color);">
            <button onclick="window.closeConfirmModal()" class="absolute top-8 right-8 text-secondary hover:text-danger transition-all"><i class="fa-solid fa-xmark text-2xl"></i></button>
            <h3 class="text-2xl font-black mb-6 text-center uppercase tracking-tight">Presence Ledger</h3>
            <div id="attendance-list-body" class="space-y-3 max-h-96 overflow-y-auto"></div>
        </div>

        <!-- User Creation/Editing (Admin) -->
        <div id="admin-user-modal-content" class="bg-surface rounded-[2rem] shadow-2xl max-md w-full p-10 fade-in hidden border border-color relative" style="background-color: var(--bg-surface); border-color: var(--border-color);">
            <button type="button" onclick="window.closeConfirmModal()" class="absolute top-8 right-8 text-secondary hover:text-danger transition-all"><i class="fa-solid fa-xmark text-2xl"></i></button>
            <h3 id="admin-user-modal-title" class="text-2xl font-black mb-8 text-center uppercase tracking-tight">Account Configuration</h3>
            <form id="admin-user-form" onsubmit="window.handleAdminUserSave(event)" class="space-y-5">
                <input type="hidden" id="admin-edit-user-id">
                <div class="space-y-1">
                    <label class="text-[10px] font-black uppercase text-secondary">Legal Name</label>
                    <input id="admin-user-name" type="text" placeholder="Full Name" class="font-bold" required>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-black uppercase text-secondary">Institutional Email</label>
                    <input id="admin-user-email" type="email" placeholder="name@edu-alg.dz" class="font-bold" required>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-black uppercase text-secondary">Security Key</label>
                    <input id="admin-user-pass" type="password" placeholder="Key Payload" class="font-bold" required>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-black uppercase text-secondary">Permission Tier</label>
                    <select id="admin-user-role" class="font-bold">
                        <option value="student">Student</option>
                        <option value="teacher">Teacher</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div id="admin-student-extras" class="hidden space-y-1">
                    <label class="text-[10px] font-black uppercase text-secondary">Custom Identity Key (QR Data)</label>
                    <textarea id="admin-user-qrdata" rows="2" class="font-mono text-xs p-3 w-full border border-color rounded-lg outline-none bg-body" placeholder="Raw QR Data String"></textarea>
                </div>
                <button type="submit" class="w-full btn-pro uppercase tracking-widest text-sm shadow-xl p-4">Finalize Entry</button>
            </form>
        </div>

        <!-- Assignment Creation (Teacher) -->
        <div id="hw-mgmt-modal-content" class="bg-surface rounded-[2rem] shadow-2xl max-w-lg w-full p-10 fade-in hidden border border-color relative" style="background-color: var(--bg-surface); border-color: var(--border-color);">
            <button type="button" onclick="window.closeConfirmModal()" class="absolute top-8 right-8 text-secondary hover:text-danger transition-all"><i class="fa-solid fa-xmark text-2xl"></i></button>
            <h3 class="text-2xl font-black mb-8 text-center uppercase tracking-tight">Issue Assignment</h3>
            <form id="hw-form" onsubmit="window.handleHWSave(event)" class="space-y-5">
                <input id="hw-title-input" type="text" placeholder="Title of Task" class="font-bold">
                <textarea id="hw-desc-input" placeholder="Technical objectives..." class="h-32"></textarea>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-black uppercase text-secondary">Final Date</label>
                        <input id="hw-date-input" type="date">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-black uppercase text-secondary">Final Time</label>
                        <input id="hw-time-input" type="time">
                    </div>
                </div>
                <div class="p-4 bg-body rounded-xl border-2 border-dashed border-color flex flex-col items-center gap-2" style="background-color: var(--bg-body); border-color: var(--border-color);">
                    <input type="file" id="hw-files-input" class="hidden" multiple onchange="window.handleHWFilesSelect(this)">
                    <button type="button" onclick="document.getElementById('hw-files-input').click()" class="text-primary font-bold text-sm uppercase tracking-widest"><i class="fa-solid fa-paperclip mr-2"></i>Attach Resource(s)</button>
                    <span id="hw-files-label" class="text-[10px] font-black text-secondary">Institutional File Storage</span>
                </div>
                <button type="submit" id="hw-submit-btn" class="w-full btn-pro uppercase tracking-widest text-sm shadow-xl">Issue Task</button>
            </form>
        </div>

        <!-- Submission Modal (Student) -->
        <div id="submission-modal-content" class="bg-surface rounded-[2rem] shadow-2xl max-md w-full p-10 fade-in hidden border border-color relative" style="background-color: var(--bg-surface); border-color: var(--border-color);">
            <button type="button" onclick="window.closeConfirmModal()" class="absolute top-8 right-8 text-secondary hover:text-danger transition-all"><i class="fa-solid fa-xmark text-2xl"></i></button>
            <h3 class="text-2xl font-black mb-4 text-center uppercase tracking-tight">Submit Result</h3>
            <p id="sub-hw-title" class="text-center font-bold text-primary mb-8 uppercase text-xs tracking-widest"></p>
            <form id="sub-form" onsubmit="window.handleSubmissionSave(event)" class="space-y-6">
                <input type="hidden" id="sub-hw-id">
                <div class="p-8 bg-body rounded-2xl border-2 border-dashed border-color flex flex-col items-center gap-4" style="background-color: var(--bg-body); border-color: var(--border-color);">
                    <input type="file" id="sub-file-input" class="hidden" onchange="window.handleFileSelect(this, 'sub-file-label')">
                    <button type="button" onclick="document.getElementById('sub-file-input').click()" class="text-primary font-black text-sm uppercase tracking-widest"><i class="fa-solid fa-cloud-arrow-up mr-2"></i>Choose File</button>
                    <span id="sub-file-label" class="text-[10px] font-black text-secondary">Institutional File Drop (Max 1MB)</span>
                </div>
                <button type="submit" class="w-full btn-pro uppercase tracking-widest shadow-xl">Finalize Submission</button>
            </form>
        </div>

        <!-- Identity Scanner Modal (Any QR Accepted) -->
        <div id="identity-scanner-modal-content" class="bg-surface rounded-[2rem] shadow-2xl max-w-2xl w-full p-10 fade-in hidden border border-color relative flex flex-col items-center" style="background-color: var(--bg-surface); border-color: var(--border-color);">
            <button type="button" onclick="window.closeConfirmModal()" class="absolute top-8 right-8 text-secondary hover:text-danger transition-all"><i class="fa-solid fa-xmark text-2xl"></i></button>
            <h3 class="text-2xl font-black mb-2 uppercase tracking-tight">Identity Sync</h3>
            <p class="text-[10px] font-bold text-secondary uppercase tracking-widest mb-8">Scan any QR code to link it to your account</p>
            <div id="identity-reader" class="w-full rounded-[2.5rem] overflow-hidden border-4 border-color mb-8" style="background: #000; aspect-ratio: 1/1;"></div>
            <button onclick="window.closeConfirmModal()" class="text-danger font-black text-xs uppercase tracking-widest"><i class="fa-solid fa-circle-stop mr-2"></i>Cancel Scanner</button>
        </div>

        <div id="generic-modal-content" class="bg-surface rounded-[2.5rem] shadow-2xl max-w-2xl w-full p-10 fade-in hidden border border-color relative flex flex-col" style="background-color: var(--bg-surface); border-color: var(--border-color);">
             <button onclick="window.closeConfirmModal()" class="absolute top-8 right-8 text-secondary hover:text-danger transition-all"><i class="fa-solid fa-xmark text-2xl"></i></button>
             <div id="modal-body-content" class="mt-4"></div>
        </div>
    </div>

    <!-- Login Portal -->
    <div id="login-modal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-xl flex items-center justify-center p-4">
        <div class="bg-surface rounded-[3rem] shadow-2xl max-w-lg w-full p-12 lg:p-16 text-center border border-color" style="background-color: var(--bg-surface); border-color: var(--border-color);">
            <div class="w-20 h-20 bg-primary rounded-[1.5rem] flex items-center justify-center text-white font-black text-4xl mx-auto mb-10 shadow-2xl transform rotate-3">E</div>
            <h2 class="text-4xl font-black mb-4 tracking-tight uppercase" style="color: var(--text-primary);">Institutional Portal</h2>
            <p class="text-secondary mb-12 text-sm font-semibold tracking-wide uppercase">Institutional OS Sync</p>
            
            <form onsubmit="window.handleLogin(event)" class="space-y-6">
                <div class="space-y-4">
                    <div class="text-left">
                        <label class="text-[10px] font-black uppercase text-secondary mb-1 block">Institutional Email</label>
                        <input id="login-email" type="email" placeholder="name@edu-alg.dz" class="w-full p-4 border border-color rounded-2xl bg-body font-bold text-sm focus:border-primary transition-all outline-none" required>
                    </div>
                    <div class="text-left">
                        <label class="text-[10px] font-black uppercase text-secondary mb-1 block">Security Key</label>
                        <input id="login-password" type="password" placeholder="••••••••" class="w-full p-4 border border-color rounded-2xl bg-body font-bold text-sm focus:border-primary transition-all outline-none" required>
                    </div>
                </div>
                <button type="submit" class="w-full btn-pro p-5 rounded-2xl shadow-xl hover:scale-[1.02] transition-all uppercase font-black tracking-widest text-sm">Synchronize Access</button>
            </form>
        </div>
    </div>

    <!-- Toast / Notification Hub -->
    <div id="toast" class="fixed bottom-12 right-12 bg-primary text-white px-8 py-5 rounded-2xl shadow-2xl transform translate-y-32 opacity-0 transition-all duration-500 z-[200] flex items-center gap-5">
        <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center text-white shrink-0 shadow-lg" id="toast-icon"><i class="fa-solid fa-check"></i></div>
        <div class="flex flex-col">
            <span id="toast-title" class="text-[10px] font-black uppercase tracking-widest opacity-70">System Message</span>
            <span id="toast-msg" class="font-black text-sm tracking-wide uppercase">Sync Confirmed</span>
        </div>
    </div>

    <!-- Notification Sounds -->
    <audio id="scan-sound" src="https://mixkit.imgix.net/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>
    <audio id="msg-sound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3" preload="auto"></audio>
    <audio id="alert-sound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3" preload="auto"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, setDoc, getDoc, getDocs, updateDoc, deleteDoc, doc, Timestamp, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. CONFIG & DATA ---
        const firebaseConfig = JSON.parse('{"apiKey":"AIzaSyD2aOVfl6bXOpWCL9eaiM85g14WB25aXYg","authDomain":"alpha-26f1e.firebaseapp.com","projectId":"alpha-26f1e","storageBucket":"alpha-26f1e.firebasestorage.app","messagingSenderId":"838970744952","appId":"1:838970744952:web:4b190d95010ecf23e18d8d","measurementId":"G-230TGXB20M"}');
        const app = initializeApp(firebaseConfig), auth = getAuth(app), db = getFirestore(app);
        const APP_ID = 'edusaas-live-demo-v2';

        const dbCollections = {
            users: `artifacts/${APP_ID}/public/data/users`,
            classes: `artifacts/${APP_ID}/public/data/classes`,
            attendance: `artifacts/${APP_ID}/public/data/attendance`,
            messages: `artifacts/${APP_ID}/public/data/messages`,
            assignments: `artifacts/${APP_ID}/public/data/assignments`,
            submissions: `artifacts/${APP_ID}/public/data/submissions`
        };

        const staticData = {
            users: {
                admin: { name: 'Institutional Admin', role: 'admin', id: 'admin_dz', email: 'admin@edu.dz', password: 'root_access' },
                teacher: { name: 'Zohra Benamor', role: 'teacher', id: 'teacher_dz', email: 'teacher@edu.dz', password: 'admin123' },
                student1: { name: 'Safer Cheikh Abdelhak', role: 'student', id: 'student_dz_1', email: 'student1@edu.dz', password: 'pass123' },
                student2: { name: 'Saadi Ali', role: 'student', id: 'student_dz_2', email: 'student2@edu.dz', password: 'pass456' }
            },
            timetable: {
                hours: ['08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00']
            }
        };

        // --- 2. STATE ---
        let currentUser = null, activeChatPartner = null, isDarkMode = false, activeScanner = null, isProcessingScan = false;
        let allUsers = [], allClassList = [], allAttendance = [], globalUnsubscribes = [], pageUnsubscribes = [], activeClassId = null;
        let currentTimetableDate = new Date(); 
        let tempSessionFiles = [], tempHWFiles = [];
        let liveCheckInterval = null, notifiedUpcoming = new Set();
        let sessionStartTime = Date.now();

        // --- 3. UTILITIES ---
        function showToast(msg, type = 'success', title = 'System Message', icon = 'fa-check') { 
            const t = document.getElementById('toast'); if(!t) return;
            document.getElementById('toast-title').innerText = title;
            document.getElementById('toast-msg').innerText = msg;
            document.getElementById('toast-icon').innerHTML = `<i class="fa-solid ${icon}"></i>`;
            const alertSound = document.getElementById('alert-sound');
            const msgSound = document.getElementById('msg-sound');
            if (type === 'message') msgSound.play().catch(()=>{});
            else alertSound.play().catch(()=>{});
            t.classList.remove('translate-y-32', 'opacity-0'); 
            setTimeout(() => t.classList.add('translate-y-32', 'opacity-0'), 4500); 
        }

        function getLocalISODate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function updateUIHeader() {
            if (!currentUser) return;
            const displayName = currentUser.name || "Account";
            document.getElementById('user-initials').innerText = displayName.charAt(0);
            document.getElementById('user-name-header').innerText = displayName;
            document.getElementById('user-role-header').innerText = (currentUser.role || 'linked').toUpperCase();
            document.getElementById('footer-user-id').innerText = (currentUser.id || 'idle').toUpperCase();
        }

        function checkIsLive(classDate, startTime, endTime) {
            const now = new Date();
            const today = getLocalISODate(now);
            if (classDate !== today) return false;
            const nowStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
            
            let safeEnd = endTime;
            if (!endTime || endTime <= startTime) {
                const [h, m] = startTime.split(':').map(Number);
                safeEnd = (h + 1).toString().padStart(2, '0') + ":" + m.toString().padStart(2, '0');
            }
            return nowStr >= startTime && nowStr < safeEnd;
        }

        function startLiveHeartbeat() {
            if (liveCheckInterval) clearInterval(liveCheckInterval);
            liveCheckInterval = setInterval(() => {
                const now = new Date();
                const todayIso = getLocalISODate(now);
                const nowTotalMin = now.getHours() * 60 + now.getMinutes();
                allClassList.forEach(cls => {
                    if (cls.date === todayIso) {
                        const [h, m] = cls.time.split(':').map(Number);
                        const clsTotalMin = h * 60 + m;
                        const diff = clsTotalMin - nowTotalMin;
                        if (diff <= 15 && diff > 0 && !notifiedUpcoming.has(cls.id)) {
                            notifiedUpcoming.add(cls.id);
                            showToast(`Upcoming Session: ${cls.name} at ${cls.time}`, 'alert', 'Class Reminder', 'fa-calendar-day');
                        }
                    }
                });
                const pid = document.getElementById('page-title')?.dataset?.id;
                if (pid && (pid.includes('schedule') || pid === 'teacher-classes')) { renderPage(pid, true); }
            }, 30000);
        }

        function setupGlobalNotifications() {
            globalUnsubscribes.forEach(u => u()); globalUnsubscribes = [];
            const u1 = onSnapshot(collection(db, 'artifacts', APP_ID, 'public', 'data', 'users'), (snap) => { 
                allUsers = snap.docs.map(d=>({id:d.id, ...d.data()})); 
                const pid = document.getElementById('page-title')?.dataset?.id;
                
                if (currentUser) {
                    const currentRecord = allUsers.find(u => u.id === currentUser.id);
                    if (currentRecord) {
                        currentUser = { ...currentUser, ...currentRecord };
                    }
                }

                if(pid === 'inbox-view' || pid === 'user-management') window.renderPage(pid, true); 
            });
            const u2 = onSnapshot(collection(db, 'artifacts', APP_ID, 'public', 'data', 'classes'), (snap) => { 
                allClassList = snap.docs.map(d=>({id:d.id, ...d.data()})); 
                const pid = document.getElementById('page-title')?.dataset?.id; 
                if(pid && (pid.includes('schedule') || pid === 'teacher-classes' || pid === 'student-vault')) window.renderPage(pid, true); 
            });
            const u3 = onSnapshot(collection(db, 'artifacts', APP_ID, 'public', 'data', 'attendance'), (snap) => {
                allAttendance = snap.docs.map(d=>d.data());
                if (currentUser && currentUser.role === 'student') {
                    snap.docChanges().forEach(change => { if (change.type === "added") { const data = change.doc.data(); const ts = data.timestamp?.toMillis() || 0; if (data.studentId === currentUser.id && ts > sessionStartTime) { showToast(`Resources Synced: Session verification complete.`, 'alert', 'Vault Sync', 'fa-file-circle-check'); } } });
                }
                const pid = document.getElementById('page-title')?.dataset?.id;
                if(pid && (pid.includes('schedule') || pid === 'student-vault')) window.renderPage(pid, true);
            });
            const u4 = onSnapshot(collection(db, 'artifacts', APP_ID, 'public', 'data', 'assignments'), (snap) => {
                if (currentUser && currentUser.role === 'student') {
                    snap.docChanges().forEach(change => { if (change.type === "added") { const data = change.doc.data(); const ts = data.timestamp?.toMillis() || 0; if (ts > sessionStartTime) { showToast(`New Assignment: ${data.title}`, 'alert', 'Institutional Task', 'fa-folder-tree'); } } });
                }
                const pid = document.getElementById('page-title')?.dataset?.id;
                if(pid && pid.includes('assignments')) window.renderPage(pid, true);
            });
            const u5 = onSnapshot(collection(db, 'artifacts', APP_ID, 'public', 'data', 'messages'), (snap) => {
                snap.docChanges().forEach(change => { if (change.type === "added") { const m = change.doc.data(); const ts = m.timestamp?.toMillis() || 0; const isForMe = m.chatId.includes(currentUser.id); const isNotByMe = m.senderId !== currentUser.id; if (isForMe && isNotByMe && ts > sessionStartTime) { const sender = allUsers.find(u => u.id === m.senderId); showToast(`New from ${sender?.name || 'Faculty'}: ${m.text.substring(0, 20)}...`, 'message', 'Inbox', 'fa-comment-alt'); } } });
            });
            globalUnsubscribes.push(u1, u2, u3, u4, u5);
        }

        function renderSidebar() {
            const nav = document.getElementById('nav-menu'); if (!nav || !currentUser) return;
            nav.innerHTML = '';
            let routes = [];
            
            if (currentUser.role === 'admin') {
                routes = [
                    { id: 'user-management', label: 'User Management', icon: 'fa-users-gear' }
                ];
            } else if (currentUser.role === 'teacher') {
                routes = [
                    { id: 'teacher-classes', label: 'My Hub', icon: 'fa-layer-group' },
                    { id: 'teacher-schedule', label: 'Schedule', icon: 'fa-calendar-day' },
                    { id: 'teacher-assignments', label: 'Dropbox', icon: 'fa-folder-tree' },
                    { id: 'inbox-view', label: 'Inbox', icon: 'fa-comment-alt' },
                    { id: 'account-settings', label: 'Credentials', icon: 'fa-user-shield' }
                ];
            } else {
                routes = [
                    { id: 'student-qr', label: 'Identity Vault', icon: 'fa-id-card' },
                    { id: 'student-schedule', label: 'Schedule', icon: 'fa-calendar-day' },
                    { id: 'student-vault', label: 'Repository', icon: 'fa-box-archive' },
                    { id: 'student-assignments', label: 'Dropbox', icon: 'fa-folder-open' },
                    { id: 'inbox-view', label: 'Faculty Line', icon: 'fa-comment-alt' },
                    { id: 'account-settings', label: 'Credentials', icon: 'fa-user-shield' }
                ];
            }

            routes.forEach((rt) => {
                const b = document.createElement('button');
                const pid = document.getElementById('page-title')?.dataset?.id;
                b.className = `sidebar-nav-item w-full ${pid === rt.id ? 'active' : ''}`;
                b.innerHTML = `<div class="w-6 text-center"><i class="fa-solid ${rt.icon} text-xs"></i></div> <span class="uppercase tracking-wide text-[10px] font-black">${rt.label}</span>`;
                b.onclick = () => window.renderPage(rt.id);
                nav.appendChild(b);
            });
        }

        async function renderPage(pageId, skipLoading = false) {
            if (activeScanner) { try { await activeScanner.stop(); } catch(e) {} activeScanner = null; }
            pageUnsubscribes.forEach(u => u()); pageUnsubscribes = [];
            const container = document.getElementById('app-content'); if(!container) return;
            if (!skipLoading) { container.innerHTML = `<div class="h-full flex items-center justify-center"><div class="w-12 h-12 border-4 border-primary/20 border-t-primary rounded-full animate-spin"></div></div>`; }
            const titleEl = document.getElementById('page-title'); if (titleEl) titleEl.dataset.id = pageId;
            renderSidebar(); 

            setTimeout(async () => {
                container.innerHTML = '';
                if(pageId.includes('schedule')) {
                    const selIso = getLocalISODate(currentTimetableDate);
                    const selLabel = currentTimetableDate.toLocaleDateString([], { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                    container.innerHTML = `
                        <div class="mb-10 flex flex-col md:flex-row justify-between items-start md:items-end fade-in gap-4">
                            <div><h2 class="text-4xl font-black tracking-tighter uppercase">Academic Schedule</h2><p class="text-xs font-bold text-secondary uppercase tracking-widest mt-2">Institutional Ledger: ${selLabel}</p></div>
                            <div class="flex gap-3 bg-surface p-2 rounded-2xl border border-color shadow-sm items-center" style="background-color: var(--bg-surface); border-color: var(--border-color);">
                                <div class="flex items-center gap-2 px-2"><i class="fa-solid fa-calendar-day text-primary"></i><input type="date" id="calendar-jump-picker" onchange="window.goToDate(this.value)" value="${selIso}"></div>
                                <div class="flex gap-1 border-l border-color pl-2" style="border-color: var(--border-color);">
                                    <button onclick="window.navigateDay(-1)" class="w-10 h-10 flex items-center justify-center hover:bg-body rounded-xl border border-color transition-all" style="background-color: var(--bg-body); border-color: var(--border-color); color: var(--text-primary);"><i class="fa-solid fa-chevron-left"></i></button>
                                    <button onclick="window.navigateDay(1)" class="w-10 h-10 flex items-center justify-center hover:bg-body rounded-xl border border-color transition-all" style="background-color: var(--bg-body); border-color: var(--border-color); color: var(--text-primary);"><i class="fa-solid fa-chevron-right"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="grid-container fade-in shadow-2xl">
                            <div class="grid-time-col bg-slate-200 dark:bg-slate-900 border-b border-color" style="border-color: var(--border-color);"><i class="fa-solid fa-clock opacity-30"></i></div>
                            <div class="grid-header flex justify-between items-center"><div><span class="text-primary mr-2">●</span>Scheduled Workspace</div><div class="opacity-50 text-[9px] font-black uppercase tracking-widest">${selLabel}</div></div>
                            ${staticData.timetable.hours.map(h => {
                                const classes = (allClassList || []).filter(c => c.date === selIso && c.time === h);
                                return `<div class="grid-time-col">${h}</div><div class="grid-slot">${classes.map(c => {
                                        const isLive = checkIsLive(c.date, c.time, c.endTime);
                                        const isPresent = allAttendance.some(a => a.studentId === currentUser.id && a.classId === c.id);
                                        return `<div class="class-tag shadow-sm ${isLive?'live-now-glow':''}">
                                            ${isLive?'<div class="live-label">In Progress</div>':''}
                                            <div class="flex justify-between items-start"><p class="uppercase font-black text-sm">${c.name}</p>${isPresent ? '<span class="text-[9px] font-black text-success uppercase"><i class="fa-solid fa-circle-check mr-1"></i>Present</span>' : ''}</div>
                                            <div class="mt-3 grid grid-cols-2 gap-2 opacity-70 font-bold text-[9px]"><p><i class="fa-solid fa-location-dot mr-1 text-primary"></i>${c.room || 'TBA'}</p><p><i class="fa-solid fa-clock mr-1 text-primary"></i>${c.time} - ${c.endTime || 'End TBA'}</p></div>
                                            ${currentUser.role === 'teacher' ? `<button onclick="window.viewAttendance('${c.id}')" class="mt-4 text-[9px] font-black text-primary uppercase border-t border-color pt-2 text-left hover:underline">Presence List (${allAttendance.filter(a=>a.classId===c.id).length})</button>` : `
                                                ${isPresent && c.files?.length ? `<div class="mt-4 border-t border-color pt-2"><p class="text-[8px] font-black text-secondary uppercase mb-2">Attached Files</p><div class="flex flex-wrap gap-2">${c.files.map(f => `<button onclick="window.downloadFile('${f.name}','${f.data}')" class="p-2 bg-primary/10 text-primary rounded text-[8px] font-black hover:bg-primary/20"><i class="fa-solid fa-download mr-1"></i>${f.name}</button>`).join('')}</div></div>` : isPresent ? '<p class="mt-4 text-[8px] font-black text-secondary uppercase italic opacity-40">No files synced</p>' : ''}
                                            `}</div>`;
                                    }).join('')}</div>`;
                            }).join('')}
                        </div>`;
                }
                else if(pageId === 'user-management') {
                    container.innerHTML = `
                        <div class="mb-12 flex justify-between items-center fade-in">
                            <div><h2 class="text-4xl font-black tracking-tighter uppercase">User Management</h2><p class="text-xs font-bold text-secondary uppercase tracking-widest mt-2">Institutional Entity Control</p></div>
                            <button onclick="window.requestAdminAddUser()" class="btn-pro shadow-xl font-black text-xs uppercase tracking-widest">+ Provision Account</button>
                        </div>
                        <div class="card-edu overflow-hidden fade-in shadow-2xl">
                            <table class="w-full text-left">
                                <thead class="bg-body/50 border-b border-color uppercase text-[10px] font-black tracking-widest text-secondary">
                                    <tr>
                                        <th class="p-6">Identity</th>
                                        <th class="p-6">Institutional Metadata</th>
                                        <th class="p-6">Permission Tier</th>
                                        <th class="p-6 text-right">Ledger Control</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-color" style="border-color: var(--border-color);">
                                    ${allUsers.map(u => `
                                        <tr class="hover:bg-body/30 transition-colors">
                                            <td class="p-6">
                                                <div class="flex items-center gap-3">
                                                    <div class="w-10 h-10 rounded-xl bg-primary/10 text-primary flex items-center justify-center font-black text-sm">${u.name?.charAt(0)}</div>
                                                    <div><p class="font-black text-sm uppercase">${u.name}</p><p class="text-[9px] font-bold text-secondary uppercase">${u.id}</p></div>
                                                </div>
                                            </td>
                                            <td class="p-6">
                                                <p class="text-[10px] font-black opacity-80">${u.email || 'NO_HANDSHAKE_EMAIL'}</p>
                                                <p class="text-[9px] font-bold text-secondary opacity-50 uppercase tracking-tighter">Security Key: ••••••••</p>
                                                ${u.role === 'student' ? `<p class="text-[8px] font-black text-primary uppercase mt-1">QR Key: ${u.qrData ? (u.qrData.length > 15 ? u.qrData.substring(0, 15) + '...' : u.qrData) : 'DEFAULT'}</p>` : ''}
                                            </td>
                                            <td class="p-6">
                                                <span class="text-[9px] font-black uppercase tracking-widest px-3 py-1 bg-primary/10 text-primary rounded-full border border-primary/20">${u.role}</span>
                                            </td>
                                            <td class="p-6 text-right space-x-2">
                                                <button onclick="window.requestAdminEditUser('${u.id}')" class="w-10 h-10 rounded-xl bg-body border border-color text-secondary hover:text-primary transition-all"><i class="fa-solid fa-user-pen text-xs"></i></button>
                                                <button onclick="window.handleAdminDeleteUser('${u.id}')" class="w-10 h-10 rounded-xl bg-danger/10 text-danger hover:bg-danger/20 transition-all"><i class="fa-solid fa-trash-can text-xs"></i></button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                else if(pageId === 'student-vault') {
                    const myAttendance = allAttendance.filter(a => a.studentId === currentUser.id);
                    const fileLedger = [];
                    myAttendance.forEach(att => { const cls = allClassList.find(c => c.id === att.classId); if (cls && cls.files) { cls.files.forEach(f => { fileLedger.push({ ...f, receivedAt: att.timestamp, originSession: cls.name }); }); } });
                    fileLedger.sort((a, b) => (b.receivedAt?.seconds || 0) - (a.receivedAt?.seconds || 0));
                    container.innerHTML = `<div class="mb-12 flex justify-between items-center fade-in"><div><h2 class="text-4xl font-black tracking-tighter uppercase">Repository</h2><p class="text-xs font-bold text-secondary uppercase tracking-widest mt-2">Institutional Material Log</p></div><div class="bg-primary/10 p-4 rounded-2xl border border-primary/20"><span class="text-xs font-black text-primary uppercase">${fileLedger.length} Artifacts Synced</span></div></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 fade-in">${fileLedger.length ? fileLedger.map(f => { const dt = new Date(f.receivedAt?.seconds * 1000); return `<div class="card-edu p-6 flex flex-col justify-between"><div><div class="flex justify-between items-start mb-4"><div class="w-10 h-10 bg-primary/10 rounded-xl flex items-center justify-center text-primary text-xl"><i class="fa-solid fa-file-invoice"></i></div><span class="text-[8px] font-black text-secondary uppercase bg-body p-1 px-2 rounded-lg border border-color">${f.originSession}</span></div><h4 class="font-black text-sm uppercase truncate mb-1" style="color: var(--text-primary);">${f.name}</h4><p class="text-[9px] font-bold text-secondary uppercase tracking-widest mb-6">Received: ${dt.toLocaleDateString()} @ ${dt.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p></div><button onclick="window.downloadFile('${f.name}','${f.data}')" class="w-full btn-pro p-3 text-[10px] uppercase tracking-widest"><i class="fa-solid fa-cloud-arrow-down mr-2"></i>Download</button></div>`; }).join('') : `<div class="col-span-full py-20 text-center opacity-40"><i class="fa-solid fa-box-open text-6xl mb-6"></i><p class="font-black uppercase tracking-widest text-sm">Vault Empty</p></div>`}</div>`;
                }
                else if(pageId === 'teacher-assignments' || pageId === 'student-assignments') {
                    const isT = currentUser.role === 'teacher';
                    container.innerHTML = `<div class="mb-12 flex justify-between items-center fade-in"><div><h2 class="text-4xl font-black tracking-tighter uppercase">Dropbox</h2><p class="text-xs font-bold text-secondary uppercase tracking-widest mt-2">Institutional Task Ledger</p></div>${isT ? `<button onclick="window.requestAddHW()" class="btn-pro shadow-lg">+ Issue Task</button>` : ''}</div><div id="hw-list" class="grid grid-cols-1 md:grid-cols-2 gap-8"></div>`;
                }
                else if(pageId === 'teacher-classes') {
                    const todayIso = getLocalISODate(new Date());
                    const todaysClasses = (allClassList || []).filter(c => c.date === todayIso);
                    container.innerHTML = `<div class="mb-12 flex justify-between items-center fade-in"><div><h2 class="text-4xl font-black tracking-tighter uppercase">My Hub</h2><p class="text-xs font-bold text-secondary uppercase tracking-widest mt-2">Active Session Control</p></div><button onclick="window.requestAddClass()" class="btn-pro shadow-xl font-black text-xs uppercase tracking-widest font-black">+ New Session</button></div><div id="cls-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>`;
                    const list = document.getElementById('cls-list');
                    list.innerHTML = todaysClasses.length ? todaysClasses.map(cl => {
                        const isLive = checkIsLive(cl.date, cl.time, cl.endTime);
                        return `<div class="p-8 card-edu relative group ${isLive?'live-now-glow':''}">
                        <div class="absolute top-6 right-6 flex gap-3"><button onclick="window.requestEditClass('${cl.id}')" class="w-10 h-10 flex items-center justify-center text-secondary hover:text-primary transition-all"><i class="fa-solid fa-sliders text-xs"></i></button><button onclick="window.requestDeleteClass('${cl.id}')" class="w-10 h-10 flex items-center justify-center text-secondary hover:text-danger transition-all"><i class="fa-solid fa-trash text-xs"></i></button></div>
                        <div class="mb-10">
                            ${isLive?'<div class="live-label">Live Now</div>':''}
                            <h3 class="font-black text-xl tracking-tight uppercase" style="color: var(--text-primary);">${cl.name}</h3>
                            <div class="flex flex-col gap-1 mt-3">
                                <p class="text-[10px] font-black text-secondary uppercase tracking-widest"><i class="fa-solid fa-calendar mr-2 text-primary"></i>${cl.date}</p>
                                <p class="text-[10px] font-black text-secondary uppercase tracking-widest"><i class="fa-solid fa-location-dot mr-2 text-primary"></i>${cl.room || 'No Room Assigned'}</p>
                                <p class="text-[10px] font-black text-secondary uppercase tracking-widest"><i class="fa-solid fa-clock mr-2 text-primary"></i>${cl.time} - ${cl.endTime || 'End TBA'}</p>
                            </div>
                        </div>
                        <button onclick="window.startScanning('${cl.id}')" class="w-full bg-primary text-white p-4 rounded-xl font-black text-xs uppercase tracking-widest shadow-xl">Mark Presence</button></div>`;
                    }).join('') : `<div class="col-span-full py-20 text-center opacity-30"><i class="fa-solid fa-calendar-xmark text-6xl mb-4"></i><p class="font-black uppercase tracking-widest text-sm">No sessions scheduled for today</p></div>`;
                }
                else if(pageId === 'teacher-scan') {
                    container.innerHTML = `<div class="h-full flex flex-col items-center justify-center fade-in p-6"><div class="card-edu w-full max-w-2xl p-12 text-center relative overflow-hidden"><div class="absolute top-0 left-0 w-full h-2 bg-success"></div><h2 class="font-black text-2xl mb-2 uppercase tracking-tight">Presence Terminal</h2><p class="text-[10px] font-bold text-secondary uppercase tracking-widest mb-10">Scanning Institutional Identity Keys</p><div id="reader" class="rounded-[2.5rem] overflow-hidden border-4 border-color mb-10 mx-auto w-full aspect-square md:w-[450px]" style="background: #000;"></div><button onclick="window.renderPage('teacher-classes')" class="text-danger font-black text-xs uppercase tracking-widest hover:underline"><i class="fa-solid fa-circle-stop mr-2"></i>Terminate Scanner</button></div></div>`;
                    
                    // Optimized Scanner initialization logic
                    activeScanner = new Html5Qrcode("reader");
                    const config = { 
                        fps: 20, 
                        qrbox: (w, h) => {
                            const minDim = Math.min(w, h);
                            return { width: minDim * 0.75, height: minDim * 0.75 };
                        }
                    };

                    activeScanner.start({ facingMode: "environment" }, config, window.handleTeacherScanSuccess)
                    .catch(err => {
                        showToast("Terminal Hardware Locked", "error", "Camera Error", "fa-video-slash");
                    });
                }
                else if(pageId === 'student-qr') {
                    container.innerHTML = `<div class="h-full flex flex-col items-center justify-center p-4 fade-in"><div class="card-edu p-16 text-center max-w-md w-full relative overflow-hidden"><div class="absolute top-0 left-0 w-full h-2 bg-indigo-600"></div><h2 class="font-black text-2xl mb-12 uppercase tracking-tight" id="vault-user-name" style="color: var(--text-primary);">${currentUser.name}</h2><div class="bg-white p-6 rounded-[2.5rem] mb-12 shadow-inner inline-block border border-slate-100"><img id="vault-qr-image" class="mx-auto" style="width: 200px; height: 200px;" src=""></div><p class="text-[10px] text-primary font-black uppercase tracking-widest font-black">Institutional Identity Key</p></div></div>`;
                    const unsub = onSnapshot(doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', currentUser.id), (docSnap) => {
                        const qrImg = document.getElementById("vault-qr-image");
                        const nameBox = document.getElementById("vault-user-name");
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            if (nameBox) nameBox.innerText = data.name || currentUser.name;
                            if (qrImg) {
                                const qrContent = data.qrData || JSON.stringify({ id: data.uid || currentUser.id, name: data.name });
                                const tempDiv = document.createElement('div');
                                new QRCode(tempDiv, { text: qrContent, width: 256, height: 256 });
                                setTimeout(() => {
                                    const generated = tempDiv.querySelector('canvas') || tempDiv.querySelector('img');
                                    if (generated) {
                                        qrImg.src = (generated.tagName === 'CANVAS') ? generated.toDataURL() : generated.src;
                                    }
                                }, 50);
                            }
                        }
                    });
                    pageUnsubscribes.push(unsub);
                }
                else if(pageId === 'account-settings') {
                    container.innerHTML = `
                        <div class="max-w-2xl mx-auto py-10 fade-in">
                            <h2 class="text-4xl font-black tracking-tighter uppercase mb-2">Account Settings</h2>
                            <p class="text-xs font-bold text-secondary uppercase tracking-widest mb-10">Credential Handshake Control</p>
                            <div class="card-edu p-10 space-y-8">
                                <form onsubmit="window.handleUpdateCredentials(event)" class="space-y-6">
                                    <div class="space-y-1">
                                        <label class="text-[10px] font-black uppercase text-secondary">Updated Institutional Email</label>
                                        <input id="settings-email" type="email" value="${currentUser.email}" class="font-bold">
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-[10px] font-black uppercase text-secondary">New Security Key (Min 6 Characters)</label>
                                        <input id="settings-password" type="password" placeholder="••••••••" class="font-bold">
                                    </div>
                                    <div class="pt-4">
                                        <button type="submit" class="w-full btn-pro uppercase tracking-widest text-sm shadow-xl p-5">Commit Updates</button>
                                    </div>
                                </form>
                                ${currentUser.role === 'student' ? `
                                <div class="pt-6 border-t border-color">
                                    <label class="text-[10px] font-black uppercase text-secondary mb-4 block">Institutional Identity Key</label>
                                    <button type="button" onclick="window.requestScanNewIdentity()" class="w-full bg-body border-2 border-dashed border-color p-10 rounded-2xl flex flex-col items-center gap-3 hover:border-primary transition-all" style="background-color: var(--bg-body); border-color: var(--border-color);">
                                        <i class="fa-solid fa-camera text-4xl text-primary"></i>
                                        <div class="text-center">
                                            <span class="block text-[11px] font-black uppercase tracking-widest mb-1">Scan New QR Code</span>
                                            <span class="block text-[8px] font-bold text-secondary uppercase opacity-60">Permanently link any presented QR artifact</span>
                                        </div>
                                    </button>
                                    <p id="card-sync-status" class="text-[9px] font-black text-success uppercase mt-4 text-center ${currentUser.qrData ? '' : 'hidden'}">
                                        <i class="fa-solid fa-circle-check mr-1"></i> Custom artifact linked to ledger
                                    </p>
                                </div>` : ''}
                            </div>
                        </div>`;
                }
                else if(pageId === 'inbox-view') {
                    const listUsers = allUsers.filter(u => u.id !== currentUser.id && u.name && u.name !== 'undefined' && u.name !== 'Amine Benali' && (currentUser.role === 'student' ? u.role === 'teacher' : u.role === 'student'));
                    if(activeChatPartner) {
                        const latestPartner = allUsers.find(u => u.id === activeChatPartner.id);
                        if (latestPartner) activeChatPartner = latestPartner;
                    } else if (listUsers.length) {
                        activeChatPartner = listUsers[0];
                    }
                    container.innerHTML = `<div class="flex h-[calc(100vh-280px)] card-edu overflow-hidden fade-in shadow-2xl"><div id="chat-list" class="w-full lg:w-96 border-r border-color flex flex-col bg-body/50" style="border-color: var(--border-color); background-color: var(--bg-body);"><div class="p-8 border-b border-color font-black uppercase text-[11px] tracking-[0.2em]" style="border-color: var(--border-color); color: var(--text-primary);">contacts</div><div id="inbox-contacts-render" class="overflow-y-auto flex-1 p-4 space-y-2">${listUsers.map(c => `<div onclick="window.switchChat('${c.id}')" class="p-5 rounded-2xl cursor-pointer transition-all ${activeChatPartner?.id === c.id ? 'bg-primary text-white shadow-lg' : 'bg-surface hover:bg-primary/10 text-primary font-bold'}" style="${activeChatPartner?.id === c.id ? '' : 'background-color: var(--bg-surface);'}"><p class="text-sm font-black">${c.name}</p></div>`).join('')}</div></div><div class="flex-1 flex flex-col bg-surface" style="background-color: var(--bg-surface); border-color: var(--border-color);"> ${activeChatPartner ? `<div class="p-8 border-b border-color flex items-center justify-between bg-surface z-10 sticky top-0 font-black uppercase tracking-widest" style="border-color: var(--border-color); background-color: var(--bg-surface); color: var(--text-primary);"><h4>${activeChatPartner.name}</h4></div><div id="msg-stream" class="flex-1 p-8 overflow-y-auto space-y-6"></div><div class="p-6 border-t border-color bg-surface flex gap-4" style="border-color: var(--border-color); background-color: var(--bg-surface);"><input type="text" id="chat-input" onkeydown="window.handleChatKeydown(event)" placeholder="Secure handshake..." class="flex-1 border border-color rounded-xl p-3"><button onclick="window.handleSendMessage(event)" class="bg-primary text-white w-14 h-14 rounded-2xl shadow-xl hover:scale-105 transition-transform"><i class="fa-solid fa-paper-plane text-xl"></i></button></div>` : `<div class="flex-1 flex flex-col items-center justify-center opacity-40 text-secondary uppercase font-black"><p class="text-xs font-black">Select Terminal to start sync</p></div>`}</div></div>`;
                    if(activeChatPartner) {
                        const cid = [currentUser.id, activeChatPartner.id].sort().join('_');
                        const unsub = onSnapshot(collection(db, 'artifacts', APP_ID, 'public', 'data', 'messages'), (snap) => {
                            let msgs = snap.docs.map(d=>d.data()).filter(m => m.chatId === cid).sort((a,b)=>(a.timestamp?.seconds||0)-(b.timestamp?.seconds||0));
                            const div = document.getElementById('msg-stream'); if(!div) return;
                            div.innerHTML = msgs.map(m => `<div class="flex w-full ${m.senderId === currentUser.id?'justify-end':'justify-start'} mb-2 group animate-fade-in"><div class="msg-bubble ${m.senderId === currentUser.id?'msg-sent shadow-md':'msg-received'}"><p class="font-bold tracking-tight text-inherit">${m.text}</p><div class="text-[8px] opacity-70 text-right mt-2 font-black tracking-widest flex items-center justify-end uppercase font-black">${new Date(m.timestamp?.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div></div></div>`).join('');
                            div.scrollTop = div.scrollHeight;
                        });
                        pageUnsubscribes.push(unsub);
                    }
                }
            }, skipLoading ? 0 : 350);
        };

        // --- 4. EXPORTS ---
        window.handleLogin = async (event) => {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                const credential = await signInAnonymously(auth);
                const uid = credential.user.uid;
                
                const usersSnap = await getDocs(collection(db, 'artifacts', APP_ID, 'public', 'data', 'users'));
                const usersInDb = usersSnap.docs.map(d => ({id: d.id, ...d.data()}));

                const staticEntry = Object.values(staticData.users).find(u => u.email === email && u.password === password);
                const dbEntry = usersInDb.find(u => u.email === email && u.password === password);
                let userEntry = dbEntry || staticEntry;

                if (!userEntry) {
                    showToast("Invalid Credentials", "error", "Access Denied", "fa-shield-xmark");
                    return;
                }

                const targetId = userEntry.id || uid;
                currentUser = { ...userEntry, id: targetId }; 
                sessionStartTime = Date.now(); 
                notifiedUpcoming = new Set();
                
                const userDocRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', targetId);
                const existingSnap = await getDoc(userDocRef);

                if (!existingSnap.exists()) {
                    await setDoc(userDocRef, { 
                        uid: uid,
                        name: currentUser.name, 
                        role: currentUser.role,
                        email: currentUser.email,
                        password: currentUser.password,
                        lastSeen: Timestamp.now(),
                        createdAt: Timestamp.now()
                    });
                } else {
                    await updateDoc(userDocRef, { lastSeen: Timestamp.now() });
                }

                document.getElementById('login-modal').classList.add('hidden');
                updateUIHeader(); setupGlobalNotifications(); startLiveHeartbeat();
                renderPage(currentUser.role === 'admin' ? 'user-management' : (currentUser.role === 'teacher' ? 'teacher-classes' : 'student-qr'));
                showToast(`Welcome back, ${currentUser.name}`, 'success', 'Terminal Synchronized', 'fa-shield-check');
            } catch (e) { 
                showToast("Auth Sync Error", "error");
            }
        }

        window.handleUpdateCredentials = async (e) => {
            e.preventDefault();
            const email = document.getElementById('settings-email').value;
            const pass = document.getElementById('settings-password').value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (!emailRegex.test(email)) return showToast("Invalid email format", "error");
            if (pass && pass.length < 6) return showToast("Key must be 6+ chars", "error");

            const emailExists = Object.values(staticData.users).some(u => u.email === email && u.id !== currentUser.id);
            if (emailExists) return showToast("Email already registered", "error");

            try {
                await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', currentUser.id), { 
                    email: email, 
                    password: pass || currentUser.password 
                });
                showToast("Credentials Updated Permanently", "success", "Institutional Commit", "fa-user-check");
                renderPage('account-settings', true);
            } catch (err) {
                showToast("Sync failure to database", "error");
            }
        };

        window.requestAdminAddUser = () => {
            document.getElementById('admin-edit-user-id').value = '';
            document.getElementById('admin-user-form').reset();
            document.getElementById('admin-student-extras').classList.add('hidden');
            document.querySelectorAll('#modal-container > div').forEach(d => d.classList.add('hidden'));
            document.getElementById('modal-container').classList.remove('hidden');
            document.getElementById('admin-user-modal-content').classList.remove('hidden');
        };

        window.requestAdminEditUser = async (userId) => {
            try {
                const snap = await getDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', userId));
                if (snap.exists()) {
                    const u = snap.data();
                    document.getElementById('admin-edit-user-id').value = userId;
                    document.getElementById('admin-user-name').value = u.name;
                    document.getElementById('admin-user-email').value = u.email;
                    document.getElementById('admin-user-pass').value = u.password;
                    document.getElementById('admin-user-role').value = u.role;
                    
                    const studentExtras = document.getElementById('admin-student-extras');
                    if (u.role === 'student') {
                        studentExtras.classList.remove('hidden');
                        document.getElementById('admin-user-qrdata').value = u.qrData || '';
                    } else {
                        studentExtras.classList.add('hidden');
                    }

                    document.querySelectorAll('#modal-container > div').forEach(d => d.classList.add('hidden'));
                    document.getElementById('modal-container').classList.remove('hidden');
                    document.getElementById('admin-user-modal-content').classList.remove('hidden');
                }
            } catch (err) { showToast("Load Error", "error"); }
        };

        window.handleAdminUserSave = async (e) => {
            e.preventDefault();
            const editId = document.getElementById('admin-edit-user-id').value;
            const name = document.getElementById('admin-user-name').value;
            const email = document.getElementById('admin-user-email').value;
            const pass = document.getElementById('admin-user-pass').value;
            const role = document.getElementById('admin-user-role').value;
            const qrData = document.getElementById('admin-user-qrdata').value;
            
            const targetId = editId || 'ext_' + Math.random().toString(36).substr(2, 9);
            const data = { name, email, password: pass, role, lastSeen: Timestamp.now() };
            if (role === 'student') data.qrData = qrData;
            if (!editId) data.createdAt = Timestamp.now();

            try {
                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', targetId), data, { merge: true });
                showToast(editId ? "Entity Updated" : "Entity Provisioned", "success");
                window.closeConfirmModal();
            } catch (err) {
                showToast("Provisioning Sync Error", "error");
            }
        };

        window.handleAdminDeleteUser = async (userId) => {
            document.getElementById('delete-target-id').value = userId; 
            document.getElementById('delete-target-type').value = 'user'; 
            document.getElementById('delete-modal-title').innerText = 'Purge Entity?'; 
            document.querySelectorAll('#modal-container > div').forEach(d => d.classList.add('hidden')); 
            document.getElementById('modal-container').classList.remove('hidden'); 
            document.getElementById('delete-confirm-modal').classList.remove('hidden');
        };

        window.requestScanNewIdentity = async () => {
            document.querySelectorAll('#modal-container > div').forEach(d => d.classList.add('hidden'));
            document.getElementById('modal-container').classList.remove('hidden');
            document.getElementById('identity-scanner-modal-content').classList.remove('hidden');
            activeScanner = new Html5Qrcode("identity-reader");
            activeScanner.start(
                { facingMode: "environment" }, 
                { fps: 15, qrbox: { width: 350, height: 350 } }, 
                window.handleNewIdentityScanSuccess
            );
        };

        window.handleNewIdentityScanSuccess = async (txt) => {
            if (isProcessingScan) return;
            isProcessingScan = true;
            try {
                await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', currentUser.id), { qrData: txt });
                showToast("Identity Key Synchronized", "success", "Database Update Confirmed", "fa-id-card");
                document.getElementById('scan-sound').play().catch(()=>{});
                window.closeConfirmModal();
                renderPage('account-settings', true);
            } catch (e) {
                showToast("Identity Sync Failure", "error");
            }
            setTimeout(() => { isProcessingScan = false; }, 2000);
        };

        window.handleTeacherScanSuccess = async (txt) => {
            if(isProcessingScan) return;
            isProcessingScan = true;
            try {
                let studentId, studentName;
                // Match scanned QR code against the live student database field
                const matchedUser = allUsers.find(u => u.qrData === txt);
                if (matchedUser) {
                    studentId = matchedUser.id;
                    studentName = matchedUser.name;
                } else {
                    // Fallback to initial JSON format
                    try {
                        const sData = JSON.parse(txt);
                        studentId = sData.id;
                        studentName = sData.name;
                    } catch(jsonErr) {
                        // If not JSON and no match, it's invalid
                        showToast("Unrecognized Identity Key", "error");
                        isProcessingScan = false;
                        return;
                    }
                }
                
                const attId = `${activeClassId}_${studentId}`;
                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'attendance', attId), { 
                    studentId: studentId, 
                    studentName: studentName, 
                    classId: activeClassId, 
                    timestamp: Timestamp.now() 
                });
                
                showToast(`Verified: ${studentName}`, 'success');
                document.getElementById('scan-sound').play().catch(()=>{});
                
                // Keep scanner open for the next student but provide a visual break
                const readerDiv = document.getElementById('reader');
                if(readerDiv) {
                    readerDiv.classList.add('border-success');
                    setTimeout(() => readerDiv.classList.remove('border-success'), 1000);
                }
            } catch (e) { 
                showToast("Terminal Sync Error", 'error'); 
            }
            // Cooldown to prevent double-scanning the same card immediately
            setTimeout(() => { isProcessingScan = false; }, 1500);
        }

        window.requestDeleteHW = (id) => { document.getElementById('delete-target-id').value = id; document.getElementById('delete-target-type').value = 'task'; document.getElementById('delete-modal-title').innerText = 'Purge Task?'; document.querySelectorAll('#modal-container > div').forEach(d => d.classList.add('hidden')); document.getElementById('modal-container').classList.remove('hidden'); document.getElementById('delete-confirm-modal').classList.remove('hidden'); };
        window.confirmDeletion = async () => { 
            const id = document.getElementById('delete-target-id').value; 
            const type = document.getElementById('delete-target-type').value; 
            if (!id) return; 
            try { 
                let collName;
                if (type === 'task') collName = 'assignments';
                else if (type === 'session') collName = 'classes';
                else if (type === 'user') collName = 'users';

                await deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', collName, id)); 
                window.closeConfirmModal(); 
                showToast("Record Removed Permanently", "success", "Database Synchronized", "fa-trash-can"); 
                const pid = document.getElementById('page-title')?.dataset?.id;
                if (pid) renderPage(pid, true);
            } catch (e) { 
                showToast("Ledger Sync Error", "error"); 
            } 
        };
        
        window.handleHWFilesSelect = (input) => { const files = Array.from(input.files); tempHWFiles = []; let loaded = 0; files.forEach(f => { const r = new FileReader(); r.onload = (e) => { tempHWFiles.push({ name: f.name, data: e.target.result }); loaded++; if(loaded === files.length) document.getElementById('hw-files-label').innerText = `${loaded} file(s) attached`; }; r.readAsDataURL(f); }); };
        window.handleHWSave = async (e) => { e.preventDefault(); const title = document.getElementById('hw-title-input').value, date = document.getElementById('hw-date-input').value, time = document.getElementById('hw-time-input').value; if(!title || !date || !time) return showToast("Deadline missing", "error"); try { await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'assignments'), { title, description: document.getElementById('hw-desc-input').value, deadlineDate: date, deadlineTime: time, files: tempHWFiles, creatorId: currentUser.id, timestamp: Timestamp.now() }); tempHWFiles = []; window.closeConfirmModal(); showToast("Task Dispatched", "success"); } catch (err) { showToast("Sync Error", "error"); } };
        window.handleSessionFilesSelect = (input) => { const files = Array.from(input.files); tempSessionFiles = []; let loaded = 0; files.forEach(f => { const r = new FileReader(); r.onload = (e) => { tempSessionFiles.push({ name: f.name, data: e.target.result }); loaded++; if(loaded === files.length) document.getElementById('session-files-label').innerText = `${loaded} file(s) attached`; }; r.readAsDataURL(f); }); };
        window.handleClassSave = async (e) => { e.preventDefault(); const id = document.getElementById('edit-class-id').value, name = document.getElementById('class-name-input').value, date = document.getElementById('class-date-input').value, start = document.getElementById('class-time-input').value, end = document.getElementById('class-end-time-input').value, room = document.getElementById('class-room-input').value; if(!name || !date || !room) return showToast("Required Data Missing", "error"); try { const data = { name, date, time: start, endTime: end, room, type: document.getElementById('class-type-input').value, files: tempSessionFiles, timestamp: Timestamp.now() }; if(id) await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'classes', id), data); else await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'classes'), data); tempSessionFiles = []; window.closeConfirmModal(); showToast("Schedule Synchronized", "success"); } catch(err) { showToast("Sync Failure", "error"); } }
        window.viewAttendance = (classId) => { const list = allAttendance.filter(a => a.classId === classId); document.getElementById('attendance-list-body').innerHTML = list.length ? list.map(a => `<div class="p-4 bg-body rounded-xl border border-color flex justify-between items-center" style="background-color: var(--bg-body); border-color: var(--border-color);"><div><p class="font-black text-xs uppercase">${a.studentName}</p><p class="text-[8px] font-bold text-secondary uppercase mt-1">Verified via Identity Key</p></div><div class="w-8 h-8 bg-success/10 text-success rounded-full flex items-center justify-center"><i class="fa-solid fa-check"></i></div></div>`).join('') : '<p class="text-center py-10 font-bold text-secondary uppercase text-xs">No students marked present yet</p>'; document.querySelectorAll('#modal-container > div').forEach(d => d.classList.add('hidden')); document.getElementById('attendance-modal-content').classList.remove('hidden'); document.getElementById('modal-container').classList.remove('hidden'); };
        window.handleChatKeydown = (e) => { if (e.key === 'Enter' && window.innerWidth >= 1024) { e.preventDefault(); window.handleSendMessage(e); } };
        window.startScanning = (cid) => { activeClassId = cid; renderPage('teacher-scan'); }
        window.toggleDarkMode = () => { isDarkMode = !isDarkMode; document.documentElement.classList.toggle('dark', isDarkMode); document.getElementById('theme-icon').className = isDarkMode ? "fa-solid fa-sun text-yellow-400" : "fa-solid fa-moon text-primary"; }
        window.toggleMobileMenu = () => { document.getElementById('sidebar').classList.toggle('-translate-x-full'); document.getElementById('mobile-overlay').classList.toggle('hidden'); }
        window.closeConfirmModal = () => { document.querySelectorAll('#modal-container > div').forEach(d => d.classList.add('hidden')); document.getElementById('modal-container').classList.add('hidden'); }
        window.logout = () => location.reload();
        window.goToDate = (val) => { if(!val) return; currentTimetableDate = new Date(val); renderPage(document.getElementById('page-title')?.dataset?.id || 'teacher-schedule'); }
        window.navigateDay = (offset) => { currentTimetableDate.setDate(currentTimetableDate.getDate() + offset); renderPage(document.getElementById('page-title')?.dataset?.id || 'teacher-schedule'); }
        window.requestAddClass = () => { document.getElementById('class-form').reset(); document.getElementById('edit-class-id').value = ""; tempSessionFiles = []; document.getElementById('session-files-label').innerText = "Optional: Materials for present students"; document.querySelectorAll('#modal-container > div').forEach(d => d.classList.add('hidden')); document.getElementById('modal-container').classList.remove('hidden'); document.getElementById('class-mgmt-modal-content').classList.remove('hidden'); }
        window.downloadFile = (n, d) => { const a = document.createElement('a'); a.href = d; a.download = n; a.click(); };
        window.handleSendMessage = async (e) => { e.preventDefault(); const inp = document.getElementById('chat-input'), txt = inp.value.trim(); if(!txt || !activeChatPartner) return; const cid = [currentUser.id, activeChatPartner.id].sort().join('_'); await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'messages'), { chatId: cid, senderId: currentUser.id, text: txt, timestamp: Timestamp.now(), read: false }); inp.value = ''; };
        window.handleFileSelect = (input, labelId) => { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (e) => { window.tempFileData = e.target.result; window.tempFileName = file.name; document.getElementById(labelId).innerText = file.name; }; reader.readAsDataURL(file); };
        window.handleSubmissionSave = async (e) => { e.preventDefault(); const hwId = document.getElementById('sub-hw-id').value; if(!window.tempFileData) return showToast("Attach file first", "error"); try { await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'submissions', `${hwId}_${currentUser.id}`), { assignmentId: hwId, studentId: currentUser.id, studentName: currentUser.name, fileData: window.tempFileData, fileName: window.tempFileName, timestamp: Timestamp.now() }); window.tempFileData = null; window.tempFileName = null; window.closeConfirmModal(); showToast("Work Synced", "success"); } catch (err) { showToast("Upload Failure", "error"); } };
        window.viewSubmissions = (hwId) => { const container = document.getElementById('modal-body-content'); container.innerHTML = `<div class="p-10 text-center"><div class="w-12 h-12 border-4 border-primary/20 border-t-primary rounded-full animate-spin mx-auto"></div></div>`; document.querySelectorAll('#modal-container > div').forEach(d => d.classList.add('hidden')); document.getElementById('generic-modal-content').classList.remove('hidden'); document.getElementById('modal-container').classList.remove('hidden'); onSnapshot(collection(db, 'artifacts', APP_ID, 'public', 'data', 'submissions'), (snap) => { const subs = snap.docs.map(d=>d.data()).filter(s => s.assignmentId === hwId); container.innerHTML = `<div class="p-6 uppercase font-black tracking-widest"><h4 class="mb-8 text-center" style="color: var(--text-primary);">Audit Ledger</h4><div class="space-y-3">${subs.length ? subs.map(s => `<div class="p-4 bg-body rounded-xl flex justify-between items-center border border-color" style="background-color: var(--bg-body); border-color: var(--border-color);"><div><p class="font-black text-xs uppercase">${s.studentName}</p><p class="text-[9px] font-bold text-secondary uppercase mt-1">${s.grade ? 'Graded ('+s.grade+'/20)' : 'Awaiting Audit'}</p></div><div class="flex gap-2"><button onclick="window.downloadFile('${s.fileName}','${s.fileData}')" class="w-10 h-10 bg-surface border border-color text-primary rounded-lg flex items-center justify-center shadow-sm" style="background-color: var(--bg-surface); border-color: var(--border-color);">Property of Alpha Group</button></div></div>`).join('') : '<p class="text-center py-8 text-xs font-bold text-secondary uppercase font-black">No submissions logged</p>'}</div></div>`; }); };
        window.requestSubmitWork = (id, title) => { document.querySelectorAll('#modal-container > div').forEach(d => d.classList.add('hidden')); document.getElementById('modal-container').classList.remove('hidden'); document.getElementById('submission-modal-content').classList.remove('hidden'); document.getElementById('sub-hw-id').value = id; document.getElementById('sub-hw-title').innerText = title; };

        window.renderPage = renderPage;
        (async () => { try { await signInAnonymously(auth); } catch (e) {} })();
    </script>
</body>
</html>
